<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administra√ß√£o de Ofertas - Chegar Primeiro</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(to bottom, #4d0607 20%, #d31a20 100%);
      min-height: 100vh;
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 30px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .admin-header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    }

    .admin-header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
    }

    .admin-actions {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: scale(1.05);
    }

    .btn-primary {
      background: #ffffff;
      color: #690000;
      border-color: #fff;
    }

    .btn-primary:hover {
      background: #f8f9fa;
      transform: scale(1.05);
    }

    .servicos-table {
      width: 100%;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .servicos-table table {
      width: 100%;
      border-collapse: collapse;
      color: #333;
    }

    .servicos-table th,
    .servicos-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }

    .servicos-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
    }

    .servicos-table tr:hover {
      background: #f8f9fa;
    }

    .status-ativo {
      color: #28a745;
      font-weight: 600;
    }

    .status-inativo {
      color: #dc3545;
      font-weight: 600;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      margin: 0 2px;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .modal-content {
      background: linear-gradient(to bottom, #4d0607 20%, #d31a20 100%);
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 24px;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #fff;
      font-weight: 500;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid transparent;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.95);
      color: #333;
      font-size: 14px;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #fff;
      background: #fff;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 10002;
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.4s ease;
      max-width: 350px;
    }

    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }

    .notification.success { background: #28a745; }
    .notification.error { background: #dc3545; }
    .notification.info { background: #17a2b8; }

    .loading {
      text-align: center;
      padding: 40px;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="admin-header">
      <h1>üõ†Ô∏è Administra√ß√£o de Ofertas Claro</h1>
      <p>Gerencie os planos e ofertas dispon√≠veis no sistema</p>
    </div>

    <div class="admin-actions">
      <button class="btn btn-primary" onclick="abrirModalNovaOferta()">
        ‚ûï Adicionar Nova Oferta
      </button>
      <button class="btn" onclick="carregarOfertas()">
        üîÑ Atualizar Lista
      </button>
      <button class="btn" onclick="inicializarSistema()">
        ‚öôÔ∏è Inicializar Sistema
      </button>
      <a href="dashboard.html" class="btn">
        ‚Üê Voltar ao Dashboard
      </a>
    </div>

    <div class="servicos-table">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Tipo</th>
            <th>Velocidade</th>
            <th>Pre√ßo</th>
            <th>Pre√ßo Promocional</th>
            <th>Status</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="ofertasTableBody">
          <tr>
            <td colspan="8" class="loading">
              <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                <div style="border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
                Carregando ofertas...
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal para adicionar/editar oferta -->
  <div class="modal" id="modalOferta">
    <div class="modal-content">
      <span class="close-modal" onclick="fecharModal()">&times;</span>
      <h3 id="modalTitle">Adicionar Nova Oferta</h3>
      
      <form id="formOferta" onsubmit="salvarOferta(event)">
        <input type="hidden" id="ofertaId">
        
        <div class="form-group">
          <label for="ofertaNome">Nome da Oferta *</label>
          <input type="text" id="ofertaNome" required placeholder="Ex: Claro fibra 350 MEGA + globoplay">
        </div>
        
        <div class="form-group">
          <label for="ofertaTipo">Tipo *</label>
          <select id="ofertaTipo" required>
            <option value="">Selecione o tipo</option>
            <option value="fibra">Fibra</option>
            <option value="controle">Controle</option>
            <option value="p√≥s">P√≥s</option>
            <option value="pre">Pr√©</option>
            <option value="combo">Combo</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="ofertaVelocidade">Velocidade/Dados</label>
          <input type="text" id="ofertaVelocidade" placeholder="Ex: 350 MEGA ou 30GB">
        </div>
        
        <div class="form-group">
          <label for="ofertaBeneficios">Benef√≠cios</label>
          <textarea id="ofertaBeneficios" rows="3" placeholder="Ex: globoplay + Wi-Fi Gr√°tis + McAfee + E-books"></textarea>
        </div>
        
        <div class="form-group">
          <label for="ofertaPreco">Pre√ßo (R$) *</label>
          <input type="number" id="ofertaPreco" step="0.01" required placeholder="79.90">
        </div>
        
        <div class="form-group">
          <label for="ofertaPrecoPromocional">Pre√ßo Promocional (R$)</label>
          <input type="number" id="ofertaPrecoPromocional" step="0.01" placeholder="59.90">
        </div>
        
        <div class="form-group">
          <label for="ofertaOrdem">Ordem de Exibi√ß√£o</label>
          <input type="number" id="ofertaOrdem" placeholder="1">
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="ofertaAtivo" checked> Oferta Ativa
          </label>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">
            üíæ Salvar Oferta
          </button>
          <button type="button" class="btn" onclick="fecharModal()" style="flex: 1;">
            ‚ùå Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Notifica√ß√£o -->
  <div class="notification" id="notification"></div>

  <script>
    // Carregar ofertas ao inicializar a p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      carregarOfertas();
    });

    // Fun√ß√£o para carregar lista de ofertas
    async function carregarOfertas() {
      try {
        const response = await fetch('https://chegar-primeiro.onrender.com/api/ofertas');
        const result = await response.json();
        
        const tbody = document.getElementById('ofertasTableBody');
        
        if (response.ok && result.success && result.ofertas.length > 0) {
          renderizarTabelaOfertas(result.ofertas);
        } else {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                ‚ö†Ô∏è Nenhuma oferta encontrada. 
                <button class="btn btn-primary" onclick="popularOfertasPadrao()" style="margin-left: 15px;">
                  Adicionar Ofertas Padr√£o
                </button>
              </td>
            </tr>
          `;
        }
      } catch (error) {
        console.error('Erro ao carregar ofertas:', error);
        showNotification('Erro ao carregar ofertas', 'error');
      }
    }

    // Fun√ß√£o para renderizar tabela de ofertas
    function renderizarTabelaOfertas(ofertas) {
      const tbody = document.getElementById('ofertasTableBody');
      
      const ofertasHTML = ofertas.map(oferta => `
        <tr>
          <td>${oferta.id}</td>
          <td>${oferta.nome}</td>
          <td><span class="badge">${oferta.tipo}</span></td>
          <td>${oferta.velocidade || '-'}</td>
          <td>R$ ${parseFloat(oferta.preco).toFixed(2)}</td>
          <td>${oferta.preco_promocional ? 'R$ ' + parseFloat(oferta.preco_promocional).toFixed(2) : '-'}</td>
          <td class="${oferta.ativo ? 'status-ativo' : 'status-inativo'}">
            ${oferta.ativo ? '‚úÖ Ativo' : '‚ùå Inativo'}
          </td>
          <td>
            <button class="btn btn-sm" onclick="editarOferta(${oferta.id})">‚úèÔ∏è Editar</button>
            <button class="btn btn-sm" onclick="toggleOfertaStatus(${oferta.id}, ${!oferta.ativo})">
              ${oferta.ativo ? 'üö´ Desativar' : '‚úÖ Ativar'}
            </button>
          </td>
        </tr>
      `).join('');
      
      tbody.innerHTML = ofertasHTML;
    }

    // Fun√ß√£o para abrir modal de nova oferta
    function abrirModalNovaOferta() {
      document.getElementById('modalTitle').textContent = 'Adicionar Nova Oferta';
      document.getElementById('formOferta').reset();
      document.getElementById('ofertaId').value = '';
      document.getElementById('ofertaAtivo').checked = true;
      document.getElementById('modalOferta').style.display = 'flex';
    }

    // Fun√ß√£o para editar oferta existente
    async function editarOferta(id) {
      try {
        // Buscar dados da oferta
        const response = await fetch('https://chegar-primeiro.onrender.com/api/ofertas');
        const result = await response.json();
        
        const oferta = result.ofertas.find(s => s.id === id);
        if (!oferta) {
          showNotification('Oferta n√£o encontrada', 'error');
          return;
        }
        
        // Preencher formul√°rio
        document.getElementById('modalTitle').textContent = 'Editar Oferta';
        document.getElementById('ofertaId').value = oferta.id;
        document.getElementById('ofertaNome').value = oferta.nome;
        document.getElementById('ofertaTipo').value = oferta.tipo;
        document.getElementById('ofertaVelocidade').value = oferta.velocidade || '';
        document.getElementById('ofertaBeneficios').value = oferta.beneficios || '';
        document.getElementById('ofertaPreco').value = oferta.preco;
        document.getElementById('ofertaPrecoPromocional').value = oferta.preco_promocional || '';
        document.getElementById('ofertaOrdem').value = oferta.ordem || '';
        document.getElementById('ofertaAtivo').checked = oferta.ativo;
        
        document.getElementById('modalOferta').style.display = 'flex';
      } catch (error) {
        console.error('Erro ao carregar oferta para edi√ß√£o:', error);
        showNotification('Erro ao carregar dados da oferta', 'error');
      }
    }

    // Fun√ß√£o para salvar oferta (nova ou editada)
    async function salvarOferta(event) {
      event.preventDefault();
      
      const ofertaId = document.getElementById('ofertaId').value;
      const isEdicao = ofertaId !== '';
      
      const dadosOferta = {
        nome: document.getElementById('ofertaNome').value,
        tipo: document.getElementById('ofertaTipo').value,
        velocidade: document.getElementById('ofertaVelocidade').value,
        beneficios: document.getElementById('ofertaBeneficios').value,
        preco: parseFloat(document.getElementById('ofertaPreco').value),
        preco_promocional: document.getElementById('ofertaPrecoPromocional').value ? 
          parseFloat(document.getElementById('ofertaPrecoPromocional').value) : null,
        ordem: document.getElementById('ofertaOrdem').value ? 
          parseInt(document.getElementById('ofertaOrdem').value) : null,
        ativo: document.getElementById('ofertaAtivo').checked
      };
      
      try {
        const url = isEdicao ? 
          `https://chegar-primeiro.onrender.com/api/ofertas/${ofertaId}` :
          'https://chegar-primeiro.onrender.com/api/ofertas';
        
        const method = isEdicao ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(dadosOferta)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          showNotification(
            isEdicao ? 'Oferta atualizada com sucesso!' : 'Oferta criada com sucesso!', 
            'success'
          );
          fecharModal();
          carregarOfertas();
        } else {
          showNotification(result.error || 'Erro ao salvar oferta', 'error');
        }
      } catch (error) {
        console.error('Erro ao salvar oferta:', error);
        showNotification('Erro de conex√£o ao salvar oferta', 'error');
      }
    }

    // Fun√ß√£o para ativar/desativar oferta
    async function toggleOfertaStatus(id, novoStatus) {
      try {
        const response = await fetch(`https://chegar-primeiro.onrender.com/api/ofertas/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ ativo: novoStatus })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          showNotification(
            novoStatus ? 'Oferta ativada com sucesso!' : 'Oferta desativada com sucesso!', 
            'success'
          );
          carregarOfertas();
        } else {
          showNotification(result.error || 'Erro ao alterar status da oferta', 'error');
        }
      } catch (error) {
        console.error('Erro ao alterar status da oferta:', error);
        showNotification('Erro de conex√£o', 'error');
      }
    }

    // Fun√ß√£o para popular ofertas padr√£o
    async function popularOfertasPadrao() {
      try {
        const response = await fetch('https://chegar-primeiro.onrender.com/api/ofertas/popular-padrao', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          showNotification('Ofertas padr√£o adicionadas com sucesso!', 'success');
          carregarOfertas();
        } else {
          showNotification(result.error || 'Erro ao popular ofertas padr√£o', 'error');
        }
      } catch (error) {
        console.error('Erro ao popular ofertas padr√£o:', error);
        showNotification('Erro de conex√£o', 'error');
      }
    }

    // Fun√ß√£o para inicializar sistema completo
    async function inicializarSistema() {
      try {
        showNotification('Inicializando sistema...', 'info');
        
        // Primeiro inicializar tabela
        await fetch('https://chegar-primeiro.onrender.com/api/ofertas/inicializar-tabela', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        // Depois popular com dados padr√£o
        setTimeout(async () => {
          await popularOfertasPadrao();
        }, 1000);
        
      } catch (error) {
        console.error('Erro ao inicializar sistema:', error);
        showNotification('Erro ao inicializar sistema', 'error');
      }
    }

    // Fun√ß√£o para fechar modal
    function fecharModal() {
      document.getElementById('modalOferta').style.display = 'none';
    }

    // Fun√ß√£o para mostrar notifica√ß√µes
    function showNotification(message, type = 'info', duration = 5000) {
      const notification = document.getElementById('notification');
      notification.className = `notification show ${type}`;
      notification.textContent = message;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }

    // Fechar modal ao clicar fora
    window.onclick = function(event) {
      const modal = document.getElementById('modalOferta');
      if (event.target === modal) {
        fecharModal();
      }
    }
  </script>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .badge {
      background: #007bff;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }
  </style>
</body>
</html>
