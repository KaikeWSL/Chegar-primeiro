<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Dashboard - Chegar Primeiro - Sistema seguro para clientes Claro solicitarem servi√ßos e manuten√ß√µes">
  <meta name="keywords" content="Claro, servi√ßos, manuten√ß√£o, clientes, internet, telefone, dashboard">
  <meta name="author" content="Claro">
  <meta name="robots" content="noindex, nofollow">
  
  <!-- Seguran√ßa -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://chegar-primeiro.onrender.com https://viacep.com.br https://brasilapi.com.br; font-src 'self' data:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  
  <!-- PWA Support -->
  <meta name="theme-color" content="#d31a20">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <title>Dashboard - Chegar Primeiro</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì±</text></svg>">
</head>
<body>
  <div class="container">
    <!-- Header com logout -->
    <div class="dashboard-header">
      <img src="https://upload.wikimedia.org/wikipedia/commons/9/9c/LogoClaro2017.png" class="logo" alt="Logo Claro">
      <div class="user-info">
        <span id="welcomeUser">Bem-vindo, Cliente!</span>
        <button onclick="logout()" class="btn-logout">üö™ Sair</button>
      </div>
    </div>
    
    <h2 style="text-align:center; margin-bottom: 18px;">√Årea do Cliente</h2>
    
    <div id="areaAutenticada">
      <div class="tabs">
        <div class="tab active" onclick="showTab(0)">üîß Manuten√ß√£o</div>
        <div class="tab" onclick="showTab(1)">üì° Troca de Servi√ßo</div>
        <div class="tab" onclick="showTab(2)">üìã Acompanhar Solicita√ß√£o</div>
      </div>
      
      <!-- Formul√°rio de Manuten√ß√£o -->
      <form id="formVistoria" class="active">
        <h3>üîß Solicitar Manuten√ß√£o</h3>
        
        <div class="field-container">
          <label>Nome</label>
          <input type="text" id="vistoriaNomeCliente" readonly style="background: #f8f9fa;">
        </div>
        
        <div class="field-container">
          <label>CPF</label>
          <input type="text" id="vistoriaCpf" readonly style="background: #f8f9fa;">
        </div>
        
        <div class="field-container">
          <label>CEP</label>
          <input type="text" id="vistoriaCep" maxlength="9" autocomplete="postal-code" placeholder="00000-000">
        </div>
        
        <div class="field-container">
          <label>Endere√ßo</label>
          <input type="text" id="vistoriaEndereco" autocomplete="street-address">
        </div>
        
        <div class="row">
          <div class="field-container">
            <label>Apartamento</label>
            <input type="text" id="vistoriaApartamento" autocomplete="address-line2">
          </div>
          <div class="field-container">
            <label>Bloco</label>
            <input type="text" id="vistoriaBloco" autocomplete="address-line3">
          </div>
        </div>
        
        <div class="field-container">
          <label>Servi√ßo atual</label>
          <input type="text" id="vistoriaServicoAtual" readonly style="background: #f8f9fa;">
        </div>
        
        <div class="field-container">
          <label>Telefone de contato</label>
          <input type="text" id="vistoriaTelefone" autocomplete="tel" placeholder="(11) 99999-9999">
          <small style="color: #666; font-size: 11px;">Formato: (11) 99999-9999</small>
        </div>
        
        <div class="field-container">
          <label>Descri√ß√£o do problema</label>
          <textarea id="vistoriaDescricao" required rows="3" style="resize: vertical; min-height: 60px;" placeholder="Descreva detalhadamente o problema que est√° enfrentando..."></textarea>
          <small style="color: #666; font-size: 11px;">Seja espec√≠fico para um atendimento mais r√°pido</small>
        </div>
        
        <div class="field-container">
          <label>Melhor hor√°rio de contato</label>
          <input type="time" id="vistoriaHorario" min="08:00" max="18:00">
          <small style="color: #666; font-size: 11px;">Hor√°rio comercial: 08:00 √†s 18:00</small>
        </div>
        
        <button class="submit-btn" type="submit">üì§ Enviar Solicita√ß√£o</button>
      </form>
      
      <!-- Formul√°rio de Troca de Servi√ßo -->
      <form id="formTrocaServico">
        <h3>üì° Troca de Servi√ßo</h3>
        
        <div class="field-container">
          <label>Nome</label>
          <input type="text" id="trocaNomeCliente" readonly style="background: #f8f9fa;">
        </div>
        
        <div class="field-container">
          <label>CPF</label>
          <input type="text" id="trocaCpf" readonly style="background: #f8f9fa;">
        </div>
        
        <div class="field-container">
          <label>Endere√ßo</label>
          <input type="text" id="trocaEndereco" readonly style="background: #f8f9fa;">
        </div>
        
        <div class="row">
          <div class="field-container">
            <label>Apartamento</label>
            <input type="text" id="trocaApartamento" readonly style="background: #f8f9fa;">
          </div>
          <div class="field-container">
            <label>Bloco</label>
            <input type="text" id="trocaBloco" readonly style="background: #f8f9fa;">
          </div>
        </div>
        
        <div class="field-container">
          <label>Servi√ßo atual</label>
          <input type="text" id="trocaServicoAtual" readonly style="background: #f8f9fa;">
        </div>
        
        <div class="field-container">
          <label>Novo servi√ßo</label>
          <div class="servico-contratado-row" id="trocaServicoContainer">
            <button type="button" class="select-service-btn" onclick="abrirModalServicos('troca')" id="btnSelecionarNovoServico">Selecionar novo servi√ßo</button>
          </div>
          <small style="color: #666; font-size: 11px;">Escolha o plano que melhor atende suas necessidades</small>
        </div>
        
        <button class="submit-btn" type="submit">üîÑ Solicitar Troca</button>
      </form>
      
      <!-- Acompanhar Solicita√ß√£o -->
      <div id="acompanharSolicitacao" style="display:none; margin-top:24px;">
        <h3>üìã Acompanhar Solicita√ß√£o</h3>
        <label for="inputProtocolo">Digite o n√∫mero do protocolo:</label>
        <div style="display:flex;flex-direction:column;align-items:flex-start;max-width:350px;gap:10px;">
          <input type="text" id="inputProtocolo" style="width:100%;" placeholder="N√∫mero do protocolo">
          <button type="button" class="submit-btn" id="btnBuscarProtocolo" style="align-self:flex-end;">üîç Buscar</button>
        </div>
        <div id="resultadoAcompanhamento" style="margin-top:18px;"></div>
      </div>
    </div>

    <!-- Modal de sele√ß√£o de servi√ßos -->
    <div class="modal-servicos" id="modalServicos">
      <div class="modal-content">
        <span class="close-modal" onclick="fecharModalServicos()">&times;</span>
        <h3 style="color: #fff; text-align: center; margin-bottom: 25px; font-size: 24px;">
          üì± Escolha seu Plano Claro
        </h3>
        <div class="servicos-grid" id="servicosGrid">
          <!-- Ofertas ser√£o carregadas dinamicamente do banco de dados -->
          <div class="loading-servicos" style="display: flex; justify-content: center; align-items: center; height: 200px; color: #fff;">
            <div class="spinner" style="border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-right: 15px;"></div>
            <span>Carregando planos...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Overlay de loading -->
    <div id="loadingOverlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.7);z-index:10000;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:32px 40px;border-radius:12px;box-shadow:0 2px 16px #0002;display:flex;flex-direction:column;align-items:center;gap:16px;">
        <div class="spinner" style="border:6px solid #eee;border-top:6px solid #ff0000;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;"></div>
        <span style="font-size:1.1em;color:#333;">Carregando...</span>
      </div>
    </div>

    <!-- Notifica√ß√£o -->
    <div class="notification" id="notification"></div>
  </div>
  
  <style>
    @keyframes spin { 
      0% { transform: rotate(0deg);} 
      100% { transform: rotate(360deg);} 
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Usar o mesmo padr√£o do projeto Claro */
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #000;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .container {
      width: 100vw;
      height: 100vh;
      background: linear-gradient(to bottom, #4d0607 20%, #d31a20 100%);
      color: #fff;
      padding: 24px 20px;
      text-align: center;
      box-sizing: border-box;
      overflow-y: auto;
    }
    
    /* Header do dashboard seguindo padr√£o Claro */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      margin-bottom: 30px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    }
    
    .dashboard-header .logo {
      height: 45px;
      filter: brightness(0) invert(1);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 20px;
      color: #fff;
      font-weight: 500;
    }
    
    .user-info span {
      font-size: 16px;
    }
    
    .btn-logout {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .btn-logout:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: scale(1.05);
    }
    
    /* T√≠tulo seguindo padr√£o */
    h2 {
      color: #fff;
      font-size: 28px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 30px;
    }
    
    /* Sistema de abas seguindo padr√£o do projeto */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      gap: 2px;
    }
    
    .tab {
      flex: 1;
      padding: 15px 20px;
      text-align: center;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px 12px 0 0;
      font-weight: 500;
      font-size: 15px;
      transition: all 0.3s ease;
      color: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .tab:hover {
      background: rgba(255, 255, 255, 0.3);
      color: #fff;
    }
    
    .tab.active {
      background: rgba(255, 255, 255, 0.95);
      color: #d31a20;
      font-weight: 600;
    }
    
    /* Formul√°rios seguindo padr√£o das se√ß√µes */
    #areaAutenticada > form, 
    #areaAutenticada > div {
      animation: slideIn 0.5s ease-out;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    
    #areaAutenticada > form h3,
    #areaAutenticada > div h3 {
      color: #fff;
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 20px 0;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Campos seguindo padr√£o do projeto */
    .field-container {
      margin-bottom: 20px;
      text-align: left;
    }
    
    .field-container label {
      display: block;
      margin-bottom: 8px;
      color: #fff;
      font-weight: 500;
      font-size: 14px;
    }
    
    .field-container input,
    .field-container textarea,
    .field-container select {
      width: 100%;
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 14px;
      color: #333;
      transition: all 0.3s ease;
      font-family: inherit;
      box-sizing: border-box;
    }
    
    .field-container input:focus,
    .field-container textarea:focus,
    .field-container select:focus {
      outline: none;
      border-color: #fff;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
    }
    
    .field-container input[readonly] {
      background: rgba(255, 255, 255, 0.7) !important;
      color: #666 !important;
      cursor: not-allowed;
    }
    
    .field-container small {
      display: block;
      margin-top: 5px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
    }
    
    /* Bot√µes seguindo padr√£o do projeto */
    .submit-btn {
      margin-top: 18px;
      padding: 12px 30px;
      background: #ffffff;
      color: #690000;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.1em;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s, box-shadow 0.2s;
      text-decoration: none;
      width: 100%;
    }
    
    .submit-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .submit-btn:active {
      transform: scale(0.95);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    /* Servi√ßos selecionados */
    .select-service-btn {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border: 2px dashed rgba(255, 255, 255, 0.5);
      border-radius: 8px;
      padding: 20px;
      width: 100%;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .select-service-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.8);
    }
    
    .servico-selecionado {
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      border-radius: 8px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .servico-nome {
      font-weight: 600;
    }
    
    .btn-alterar-servico {
      background: #d31a20;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .btn-alterar-servico:hover {
      background: #b71717;
    }
    
    /* Modal seguindo padr√£o */
    .modal-servicos {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      animation: fadeIn 0.3s ease;
    }
    
    .modal-content {
      background: linear-gradient(to bottom, #4d0607 20%, #d31a20 100%);
      border-radius: 12px;
      padding: 30px;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      position: relative;
      animation: slideIn 0.4s ease;
      color: #fff;
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      transition: color 0.3s ease;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .close-modal:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.2);
    }
    
    /* Cards de servi√ßo */
    .servicos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .servico-card {
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #333;
    }
    
    .servico-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
      border-color: #fff;
    }
    
    .servico-titulo {
      font-size: 20px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    
    .servico-mega {
      font-size: 32px;
      font-weight: 800;
      color: #d31a20;
      margin: 15px 0;
    }
    
    .servico-benef {
      color: #6c757d;
      font-size: 14px;
      margin: 15px 0;
      line-height: 1.4;
    }
    
    .servico-preco {
      font-size: 24px;
      font-weight: 700;
      color: #28a745;
      margin: 15px 0;
    }
    
    .servico-btn {
      background: #d31a20;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    .servico-btn:hover {
      background: #b71717;
      transform: translateY(-2px);
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .dashboard-header {
        flex-direction: column;
        gap: 15px;
      }
      
      .tabs {
        flex-direction: column;
        gap: 8px;
      }
      
      .tab {
        border-radius: 8px;
      }
      
      .servicos-grid {
        grid-template-columns: 1fr;
      }
      
      h2 {
        font-size: 24px;
      }
    }
    
    /* Loading e notifica√ß√µes seguindo padr√£o */
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 10002;
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.4s ease;
      max-width: 350px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    
    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .notification.success {
      background: #28a745;
    }
    
    .notification.error {
      background: #dc3545;
    }
    
    .notification.info {
      background: #17a2b8;
    }
    
    /* Estilo espec√≠fico para linhas de campos */
    .row {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .row .field-container {
      flex: 1;
      margin-bottom: 0;
    }
    
    /* Protocolo display */
    #resultadoAcompanhamento {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
  </style>
  
  <script src="navigation.js"></script>
  <script src="script.js"></script>
  <script>
    // Inicializar dashboard
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar se o usu√°rio est√° autenticado
      checkAuth();
      
      // Carregar dados do usu√°rio
      loadUserData();
      
      // Inicializar funcionalidades espec√≠ficas do dashboard
      if (typeof initializeDashboard === 'function') {
        initializeDashboard();
      }
      
      // Adicionar event listeners para formul√°rios
      initializeFormHandlers();
      
      // Adicionar busca de CEP autom√°tica
      initializeCepSearch();
      
      // Inicializar sistema de ofertas
      initializeServicos();
      
      // Mostrar primeira aba por padr√£o
      showTab(0);
    });

    // Fun√ß√£o para inicializar sistema de ofertas
    async function initializeServicos() {
      try {
        // Primeiro, tentar inicializar a estrutura da tabela
        await fetch('https://chegar-primeiro.onrender.com/api/ofertas/inicializar-tabela', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        // Aguardar um pouco e depois popular com dados padr√£o se necess√°rio
        setTimeout(async () => {
          try {
            await fetch('https://chegar-primeiro.onrender.com/api/ofertas/popular-padrao', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
          } catch (err) {
            console.log('Ofertas padr√£o j√° existem ou erro na popula√ß√£o:', err);
          }
        }, 1000);
      } catch (error) {
        console.log('Erro na inicializa√ß√£o de ofertas:', error);
      }
    }

    // Inicializar handlers dos formul√°rios
    function initializeFormHandlers() {
      // Form de manuten√ß√£o
      const formVistoria = document.getElementById('formVistoria');
      if (formVistoria) {
        formVistoria.addEventListener('submit', handleVistoriaSubmit);
      }
      
      // Form de troca de servi√ßo
      const formTroca = document.getElementById('formTrocaServico');
      if (formTroca) {
        formTroca.addEventListener('submit', handleTrocaSubmit);
      }
      
      // Busca de protocolo
      const btnBuscarProtocolo = document.getElementById('btnBuscarProtocolo');
      if (btnBuscarProtocolo) {
        btnBuscarProtocolo.addEventListener('click', buscarProtocolo);
      }
    }

    // Inicializar busca de CEP
    function initializeCepSearch() {
      const cepField = document.getElementById('vistoriaCep');
      if (cepField) {
        cepField.addEventListener('blur', function() {
          const cep = this.value.replace(/\D/g, '');
          if (cep.length === 8) {
            buscarEnderecoPorCep(cep);
          }
        });
      }
    }

    // Buscar endere√ßo por CEP
    async function buscarEnderecoPorCep(cep) {
      try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();
        
        if (!data.erro) {
          const enderecoCompleto = `${data.logradouro}, ${data.bairro}, ${data.localidade} - ${data.uf}`;
          document.getElementById('vistoriaEndereco').value = enderecoCompleto;
          
          // Salvar no localStorage para usar em outras abas
          const userData = JSON.parse(localStorage.getItem('userData') || '{}');
          userData.endereco = enderecoCompleto;
          userData.cep = cep;
          localStorage.setItem('userData', JSON.stringify(userData));
          
          showNotification('Endere√ßo preenchido automaticamente!', 'success');
        }
      } catch (error) {
        console.error('Erro ao buscar CEP:', error);
        showNotification('N√£o foi poss√≠vel buscar o endere√ßo', 'error');
      }
    }

    // Handler para submit do formul√°rio de manuten√ß√£o
    async function handleVistoriaSubmit(e) {
      e.preventDefault();
      
      const formData = {
        tipo: 'manutencao',
        cpf: document.getElementById('vistoriaCpf').value.replace(/\D/g, ''),
        nome: document.getElementById('vistoriaNomeCliente').value,
        cep: document.getElementById('vistoriaCep').value.replace(/\D/g, ''),
        endereco: document.getElementById('vistoriaEndereco').value,
        apartamento: document.getElementById('vistoriaApartamento').value,
        bloco: document.getElementById('vistoriaBloco').value,
        telefone: document.getElementById('vistoriaTelefone').value.replace(/\D/g, ''),
        descricao: document.getElementById('vistoriaDescricao').value,
        horario_contato: document.getElementById('vistoriaHorario').value,
        servico_atual: document.getElementById('vistoriaServicoAtual').value
      };
      
      await submitSolicitacao(formData, 'Solicita√ß√£o de manuten√ß√£o enviada com sucesso!');
    }

    // Handler para submit do formul√°rio de troca
    async function handleTrocaSubmit(e) {
      e.preventDefault();
      
      const novoServicoElement = document.querySelector('#trocaServicoContainer .servico-nome');
      if (!novoServicoElement) {
        showNotification('Por favor, selecione um novo servi√ßo', 'error');
        return;
      }
      
      const formData = {
        tipo: 'troca_servico',
        cpf: document.getElementById('trocaCpf').value.replace(/\D/g, ''),
        nome: document.getElementById('trocaNomeCliente').value,
        endereco: document.getElementById('trocaEndereco').value,
        apartamento: document.getElementById('trocaApartamento').value,
        bloco: document.getElementById('trocaBloco').value,
        servico_atual: document.getElementById('trocaServicoAtual').value,
        novo_servico: novoServicoElement.textContent
      };
      
      await submitSolicitacao(formData, 'Solicita√ß√£o de troca de servi√ßo enviada com sucesso!');
    }

    // Enviar solicita√ß√£o para o servidor
    async function submitSolicitacao(formData, successMessage) {
      try {
        showLoading(true);
        
        const response = await fetch('https://chegar-primeiro.onrender.com/api/solicitacoes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showNotification(successMessage, 'success');
          if (result.protocolo) {
            showNotification(`Protocolo: ${result.protocolo}`, 'info');
          }
          // Limpar formul√°rio espec√≠fico
          clearForm(formData.tipo);
        } else {
          showNotification(result.error || 'Erro ao enviar solicita√ß√£o', 'error');
        }
      } catch (error) {
        console.error('Erro ao enviar solicita√ß√£o:', error);
        showNotification('Erro de conex√£o. Tente novamente.', 'error');
      } finally {
        showLoading(false);
      }
    }

    // Limpar formul√°rio ap√≥s envio
    function clearForm(tipo) {
      if (tipo === 'manutencao') {
        document.getElementById('vistoriaDescricao').value = '';
        document.getElementById('vistoriaHorario').value = '';
      } else if (tipo === 'troca_servico') {
        const container = document.getElementById('trocaServicoContainer');
        container.innerHTML = '<button type="button" class="select-service-btn" onclick="abrirModalServicos(\'troca\')" id="btnSelecionarNovoServico">Selecionar novo servi√ßo</button>';
      }
    }

    // Buscar protocolo
    async function buscarProtocolo() {
      const protocolo = document.getElementById('inputProtocolo').value.trim();
      
      if (!protocolo) {
        showNotification('Digite um n√∫mero de protocolo', 'error');
        return;
      }
      
      try {
        showLoading(true);
        
        const response = await fetch(`https://chegar-primeiro.onrender.com/api/solicitacoes/${protocolo}`);
        const result = await response.json();
        
        const resultDiv = document.getElementById('resultadoAcompanhamento');
        
        if (response.ok) {
          resultDiv.innerHTML = `
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
              <h4 style="color: #28a745; margin-bottom: 15px;">‚úÖ Protocolo Encontrado</h4>
              <p><strong>Protocolo:</strong> ${result.protocolo}</p>
              <p><strong>Tipo:</strong> ${result.tipo}</p>
              <p><strong>Status:</strong> ${result.status || 'Em andamento'}</p>
              <p><strong>Data:</strong> ${new Date(result.data_criacao).toLocaleDateString('pt-BR')}</p>
              ${result.descricao ? `<p><strong>Descri√ß√£o:</strong> ${result.descricao}</p>` : ''}
            </div>
          `;
        } else {
          resultDiv.innerHTML = `
            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107;">
              <h4 style="color: #856404;">‚ö†Ô∏è Protocolo n√£o encontrado</h4>
              <p>Verifique se o n√∫mero do protocolo est√° correto e tente novamente.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Erro ao buscar protocolo:', error);
        showNotification('Erro ao buscar protocolo', 'error');
      } finally {
        showLoading(false);
      }
    }

    // Fun√ß√£o para mostrar/ocultar loading
    function showLoading(show) {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.style.display = show ? 'flex' : 'none';
      }
    }

    // Fun√ß√£o para mostrar notifica√ß√µes
    function showNotification(message, type = 'info', duration = 5000) {
      const notification = document.getElementById('notification');
      if (!notification) return;
      
      notification.className = `notification show ${type}`;
      notification.textContent = message;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }

    // Fun√ß√£o para verificar autentica√ß√£o
    function checkAuth() {
      // Se n√£o estiver autenticado, redirecionar para login
      const isAuthenticated = localStorage.getItem('userAuthenticated');
      if (!isAuthenticated) {
        window.location.href = 'index-principal.html';
        return;
      }
    }

    // Fun√ß√£o para carregar dados do usu√°rio
    function loadUserData() {
      const userData = JSON.parse(localStorage.getItem('userData') || '{}');
      console.log('Dados do usu√°rio carregados:', userData);
      
      if (userData.nome) {
        document.getElementById('welcomeUser').textContent = `Bem-vindo, ${userData.nome}!`;
        
        // Preencher todos os campos com dados do usu√°rio
        const fields = {
          'vistoriaNomeCliente': userData.nome,
          'trocaNomeCliente': userData.nome,
          'vistoriaCpf': userData.cpf || '',
          'trocaCpf': userData.cpf || '',
          'vistoriaEndereco': userData.endereco || '',
          'trocaEndereco': userData.endereco || '',
          'vistoriaApartamento': userData.apartamento || '',
          'trocaApartamento': userData.apartamento || '',
          'vistoriaBloco': userData.bloco || '',
          'trocaBloco': userData.bloco || '',
          'vistoriaTelefone': userData.telefone || '',
          'vistoriaServicoAtual': userData.servico_atual || 'Claro fibra 350 MEGA',
          'trocaServicoAtual': userData.servico_atual || 'Claro fibra 350 MEGA',
          'vistoriaCep': userData.cep || ''
        };
        
        Object.entries(fields).forEach(([fieldId, value]) => {
          const field = document.getElementById(fieldId);
          if (field && value) {
            field.value = value;
          }
        });
        
        // Formatar CPF e telefone se necess√°rio
        if (userData.cpf) {
          const cpfFormatado = formatCPF(userData.cpf);
          document.getElementById('vistoriaCpf').value = cpfFormatado;
          document.getElementById('trocaCpf').value = cpfFormatado;
        }
        
        if (userData.telefone) {
          const telefoneFormatado = formatTelefone(userData.telefone);
          document.getElementById('vistoriaTelefone').value = telefoneFormatado;
        }
        
        if (userData.cep) {
          const cepFormatado = formatCEP(userData.cep);
          document.getElementById('vistoriaCep').value = cepFormatado;
        }
      }
    }

    // Fun√ß√µes de formata√ß√£o
    function formatCPF(cpf) {
      const cleanCpf = cpf.replace(/\D/g, '');
      return cleanCpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }

    function formatTelefone(telefone) {
      const cleanTel = telefone.replace(/\D/g, '');
      if (cleanTel.length === 11) {
        return cleanTel.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
      }
      return telefone;
    }

    function formatCEP(cep) {
      const cleanCep = cep.replace(/\D/g, '');
      return cleanCep.replace(/(\d{5})(\d{3})/, '$1-$2');
    }

    // Fun√ß√£o de logout
    function logout() {
      localStorage.removeItem('userAuthenticated');
      localStorage.removeItem('userData');
      window.location.href = 'index-principal.html';
    }

    // Fun√ß√£o para trocar abas (melhorada)
    function showTab(index) {
      // Remover classe active de todas as abas
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      
      // Ocultar todos os formul√°rios e se√ß√µes
      const forms = document.querySelectorAll('#formVistoria, #formTrocaServico, #acompanharSolicitacao');
      forms.forEach(form => {
        form.style.display = 'none';
        form.classList.remove('active');
      });
      
      // Ativar aba selecionada
      const tabs = document.querySelectorAll('.tab');
      if (tabs[index]) {
        tabs[index].classList.add('active');
      }
      
      // Mostrar conte√∫do correspondente
      switch(index) {
        case 0:
          const formVistoria = document.getElementById('formVistoria');
          if (formVistoria) {
            formVistoria.style.display = 'flex';
            formVistoria.classList.add('active');
          }
          break;
        case 1:
          const formTroca = document.getElementById('formTrocaServico');
          if (formTroca) {
            formTroca.style.display = 'flex';
            formTroca.classList.add('active');
          }
          break;
        case 2:
          const acompanhar = document.getElementById('acompanharSolicitacao');
          if (acompanhar) {
            acompanhar.style.display = 'block';
            acompanhar.classList.add('active');
          }
          break;
      }
      
      // Recarregar dados do usu√°rio ao trocar de aba
      loadUserData();
    }

    // Fun√ß√£o para abrir modal de servi√ßos
    async function abrirModalServicos(contexto) {
      window.modalServicoContexto = contexto;
      document.getElementById('modalServicos').style.display = 'flex';
      
      // Carregar ofertas do banco de dados
      await carregarServicos();
    }

    // Fun√ß√£o para carregar ofertas do banco de dados
    async function carregarServicos() {
      try {
        const servicosGrid = document.getElementById('servicosGrid');
        
        // Mostrar loading
        servicosGrid.innerHTML = `
          <div class="loading-servicos" style="display: flex; justify-content: center; align-items: center; height: 200px; color: #fff; grid-column: 1 / -1;">
            <div class="spinner" style="border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-right: 15px;"></div>
            <span>Carregando planos...</span>
          </div>
        `;
        
        // Fazer requisi√ß√£o para buscar ofertas
        const response = await fetch('https://chegar-primeiro.onrender.com/api/ofertas');
        const result = await response.json();
        
        if (response.ok && result.success) {
          // Renderizar ofertas
          renderizarServicos(result.ofertas);
        } else {
          // Em caso de erro, usar ofertas padr√£o
          console.warn('Erro ao carregar ofertas do banco, usando padr√µes:', result.error);
          usarServicosPadrao();
        }
      } catch (error) {
        console.error('Erro ao carregar ofertas:', error);
        // Em caso de erro de conex√£o, usar ofertas padr√£o
        usarServicosPadrao();
      }
    }

    // Fun√ß√£o para renderizar ofertas vindas do banco de dados
    function renderizarServicos(ofertas) {
      const servicosGrid = document.getElementById('servicosGrid');
      
      if (!ofertas || ofertas.length === 0) {
        servicosGrid.innerHTML = `
          <div style="color: #fff; text-align: center; grid-column: 1 / -1; padding: 40px;">
            <h4>‚ö†Ô∏è Nenhum plano dispon√≠vel</h4>
            <p>Os planos est√£o sendo atualizados. Tente novamente em alguns minutos.</p>
          </div>
        `;
        return;
      }
      
      const servicosHTML = ofertas.map(oferta => {
        const precoFormatado = formatarPreco(oferta.preco);
        const precoPromocional = oferta.preco_promocional ? formatarPreco(oferta.preco_promocional) : null;
        
        return `
          <div class="servico-card" onclick="selecionarServico('${oferta.nome}', window.modalServicoContexto)">
            <div class="servico-titulo">
              Claro<span style='color:#ff0000'> ${oferta.tipo}</span>
            </div>
            <div class="servico-mega">${oferta.velocidade || ''}</div>
            <div class="servico-benef">${oferta.beneficios || ''}</div>
            <div class="servico-preco">
              ${precoPromocional ? `
                <span style="text-decoration: line-through; color: #999; font-size: 18px;">${precoFormatado}</span><br>
                <span style="color: #28a745; font-size: 24px; font-weight: 700;">${precoPromocional}</span>
              ` : precoFormatado}
            </div>
            <button type="button" class="servico-btn">
              ${oferta.tipo === 'fibra' ? 'Assine' : 'Contrate'}
            </button>
          </div>
        `;
      }).join('');
      
      servicosGrid.innerHTML = servicosHTML;
    }

    // Fun√ß√£o para usar ofertas padr√£o em caso de erro
    function usarServicosPadrao() {
      const servicosGrid = document.getElementById('servicosGrid');
      
      servicosGrid.innerHTML = `
        <div class="servico-card" onclick="selecionarServico('Claro fibra 350 MEGA + globoplay', window.modalServicoContexto)">
          <div class="servico-titulo">Claro<span style='color:#ff0000'> fibra</span></div>
          <div class="servico-mega">350 MEGA</div>
          <div class="servico-benef">globoplay + Wi-Fi Gr√°tis + McAfee + E-books</div>
          <div class="servico-preco">R$ 79,90/m√™s</div>
          <button type="button" class="servico-btn">Assine</button>
        </div>
        <div class="servico-card" onclick="selecionarServico('Claro fibra 600 MEGA + globoplay + Claro p√≥s 60GB', window.modalServicoContexto)">
          <div class="servico-titulo">Claro<span style='color:#ff0000'> fibra</span></div>
          <div class="servico-mega">600 MEGA</div>
          <div class="servico-benef">globoplay + Wi-Fi Gr√°tis + Claro p√≥s 60GB</div>
          <div class="servico-preco">R$ 159,90/m√™s</div>
          <button type="button" class="servico-btn">Assine</button>
        </div>
        <div class="servico-card" onclick="selecionarServico('Claro controle 30GB + b√¥nus', window.modalServicoContexto)">
          <div class="servico-titulo">Claro<span style='color:#ff0000'> controle</span></div>
          <div class="servico-mega">30GB</div>
          <div class="servico-benef">15GB + 5GB redes sociais + WhatsApp ilimitado + 10GB b√¥nus</div>
          <div class="servico-preco">R$ 59,90/m√™s</div>
          <button type="button" class="servico-btn">Contrate</button>
        </div>
        <div class="servico-card" onclick="selecionarServico('Claro p√≥s 50GB', window.modalServicoContexto)">
          <div class="servico-titulo">Claro<span style='color:#ff0000'> p√≥s</span></div>
          <div class="servico-mega">50GB</div>
          <div class="servico-benef">25GB + 25GB + WhatsApp ilimitado</div>
          <div class="servico-preco">R$ 119,90/m√™s</div>
          <button type="button" class="servico-btn">Contrate</button>
        </div>
      `;
    }

    // Fun√ß√£o auxiliar para formatar pre√ßo
    function formatarPreco(preco) {
      return `R$ ${parseFloat(preco).toFixed(2).replace('.', ',')}/m√™s`;
    }

    // Fun√ß√£o para fechar modal de servi√ßos
    function fecharModalServicos() {
      document.getElementById('modalServicos').style.display = 'none';
    }

    // Fun√ß√£o para selecionar servi√ßo (melhorada)
    function selecionarServico(nomeServico, contexto) {
      const container = document.getElementById(contexto + 'ServicoContainer');
      if (container) {
        container.innerHTML = `
          <div class="servico-selecionado" style="background: linear-gradient(135deg, #e8f5e8, #f0f9ff); border: 2px solid #28a745; border-radius: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <span class="servico-nome" style="font-weight: 600; color: #155724; display: block;">${nomeServico}</span>
              <small style="color: #6c757d;">Servi√ßo selecionado</small>
            </div>
            <button type="button" onclick="abrirModalServicos('${contexto}')" class="btn-alterar-servico" style="background: #ffc107; border: none; border-radius: 20px; padding: 8px 15px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.3s ease;">
              üîÑ Alterar
            </button>
          </div>
        `;
      }
      fecharModalServicos();
      showNotification('Servi√ßo selecionado com sucesso!', 'success');
    }

    // Melhorar estilo dos bot√µes de sele√ß√£o de servi√ßo
    function updateServiceButtonStyle() {
      const selectButtons = document.querySelectorAll('.select-service-btn');
      selectButtons.forEach(button => {
        button.style.cssText = `
          background: linear-gradient(135deg, #6c757d, #495057);
          color: white;
          border: none;
          border-radius: 10px;
          padding: 15px 20px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.3s ease;
          width: 100%;
          font-size: 14px;
        `;
      });
    }

    // Atualizar estilos na inicializa√ß√£o
    setTimeout(updateServiceButtonStyle, 100);
  </script>
</body>
</html>
