<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Dashboard - Chegar Primeiro - Sistema seguro para clientes Claro solicitarem servi√ßos e manuten√ß√µes">
  <meta name="keywords" content="Claro, servi√ßos, manuten√ß√£o, clientes, internet, telefone, dashboard">
  <meta name="author" content="Claro">
  <meta name="robots" content="noindex, nofollow">
  
  <!-- Seguran√ßa -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://chegar-primeiro.onrender.com https://viacep.com.br https://brasilapi.com.br; font-src 'self' data:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  
  <!-- PWA Support -->
  <meta name="theme-color" content="#d31a20">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <title>Dashboard - Chegar Primeiro</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì±</text></svg>">
</head>
<body>
  <div class="container">
    <!-- Header com logout -->
    <div class="dashboard-header">
      <img src="https://upload.wikimedia.org/wikipedia/commons/9/9c/LogoClaro2017.png" class="logo" alt="Logo Claro">
      <div class="user-info">
        <span id="welcomeUser">Bem-vindo, Cliente!</span>
        <button onclick="logout()" class="btn-logout">üö™ Sair</button>
      </div>
    </div>
    
    <h2 style="text-align:center; margin-bottom: 18px;">√Årea do Cliente</h2>
    
    <div id="areaAutenticada">
      <div class="tabs">
        <div class="tab active" onclick="showTab(0)">üîß Manuten√ß√£o</div>
        <div class="tab" onclick="showTab(1)">üì° Troca de Servi√ßo</div>
        <div class="tab" onclick="showTab(2)">üìã Acompanhar Solicita√ß√£o</div>
      </div>
      
      <!-- Formul√°rio de Manuten√ß√£o -->
      <form id="formVistoria" class="active">
        <h3>üîß Solicitar Manuten√ß√£o</h3>
        
        <div class="field-container">
          <label>Nome</label>
          <input type="text" id="vistoriaNomeCliente" readonly style="background: #f8f9fa;">
        </div>
        
        <div class="field-container">
          <label>CPF</label>
          <input type="text" id="vistoriaCpf" readonly style="background: #f8f9fa;">
        </div>
        
        <div class="field-container">
          <label>CEP</label>
          <input type="text" id="vistoriaCep" maxlength="9" autocomplete="postal-code" placeholder="00000-000">
        </div>
        
        <div class="field-container">
          <label>Endere√ßo</label>
          <input type="text" id="vistoriaEndereco" autocomplete="street-address">
        </div>
        
        <div class="row">
          <div class="field-container">
            <label>Apartamento</label>
            <input type="text" id="vistoriaApartamento" autocomplete="address-line2">
          </div>
          <div class="field-container">
            <label>Bloco</label>
            <input type="text" id="vistoriaBloco" autocomplete="address-line3">
          </div>
        </div>
        
        <div class="field-container">
          <label>Servi√ßo atual</label>
          <input type="text" id="vistoriaServicoAtual" readonly style="background: #f8f9fa;">
        </div>
        
        <div class="field-container">
          <label>Telefone de contato</label>
          <input type="text" id="vistoriaTelefone" autocomplete="tel" placeholder="(11) 99999-9999">
          <small style="color: #666; font-size: 11px;">Formato: (11) 99999-9999</small>
        </div>
        
        <div class="field-container">
          <label>Descri√ß√£o do problema</label>
          <textarea id="vistoriaDescricao" required rows="3" style="resize: vertical; min-height: 60px;" placeholder="Descreva detalhadamente o problema que est√° enfrentando..."></textarea>
          <small style="color: #666; font-size: 11px;">Seja espec√≠fico para um atendimento mais r√°pido</small>
        </div>
        
        <div class="field-container">
          <label>Melhor hor√°rio de contato</label>
          <input type="time" id="vistoriaHorario" min="08:00" max="18:00">
          <small style="color: #666; font-size: 11px;">Hor√°rio comercial: 08:00 √†s 18:00</small>
        </div>
        
        <button class="submit-btn" type="submit">üì§ Enviar Solicita√ß√£o</button>
      </form>
      
      <!-- Formul√°rio de Troca de Servi√ßo -->
      <form id="formTrocaServico">
        <h3>üì° Troca de Servi√ßo</h3>
        
        <div class="field-container">
          <label>Nome</label>
          <input type="text" id="trocaNomeCliente" readonly style="background: #f8f9fa;">
        </div>
        
        <div class="field-container">
          <label>CPF</label>
          <input type="text" id="trocaCpf" readonly style="background: #f8f9fa;">
        </div>
        
        <div class="field-container">
          <label>Endere√ßo</label>
          <input type="text" id="trocaEndereco" readonly style="background: #f8f9fa;">
        </div>
        
        <div class="row">
          <div class="field-container">
            <label>Apartamento</label>
            <input type="text" id="trocaApartamento" readonly style="background: #f8f9fa;">
          </div>
          <div class="field-container">
            <label>Bloco</label>
            <input type="text" id="trocaBloco" readonly style="background: #f8f9fa;">
          </div>
        </div>
        
        <div class="field-container">
          <label>Servi√ßo atual</label>
          <input type="text" id="trocaServicoAtual" readonly style="background: #f8f9fa;">
        </div>
        
        <div class="field-container">
          <label>Novo servi√ßo</label>
          <div class="servico-contratado-row" id="trocaServicoContainer">
            <button type="button" class="select-service-btn" onclick="abrirModalServicos('troca')" id="btnSelecionarNovoServico">Selecionar novo servi√ßo</button>
          </div>
          <small style="color: #666; font-size: 11px;">Escolha o plano que melhor atende suas necessidades</small>
        </div>
        
        <button class="submit-btn" type="submit">üîÑ Solicitar Troca</button>
      </form>
      
      <!-- Acompanhar Solicita√ß√£o -->
      <div id="acompanharSolicitacao" style="display:none; margin-top:24px;">
        <h3>üìã Acompanhar Solicita√ß√£o</h3>
        <label for="inputProtocolo">Digite o n√∫mero do protocolo:</label>
        <div style="display:flex;flex-direction:column;align-items:flex-start;max-width:350px;gap:10px;">
          <input type="text" id="inputProtocolo" style="width:100%;" placeholder="N√∫mero do protocolo">
          <button type="button" class="submit-btn" id="btnBuscarProtocolo" style="align-self:flex-end;">üîç Buscar</button>
        </div>
        <div id="resultadoAcompanhamento" style="margin-top:18px;"></div>
      </div>
    </div>

    <!-- Modal de sele√ß√£o de servi√ßos -->
    <div class="modal-servicos" id="modalServicos">
      <div class="modal-content">
        <span class="close-modal" onclick="fecharModalServicos()">&times;</span>
        <div class="servicos-grid">
          <div class="servico-card" onclick="selecionarServico('Claro fibra 350 MEGA + globoplay', window.modalServicoContexto)">
            <div class="servico-titulo">Claro<span style='color:#ff0000'> fibra</span></div>
            <div class="servico-mega">350 MEGA</div>
            <div class="servico-benef">globoplay + Wi-Fi Gr√°tis + McAfee + E-books</div>
            <div class="servico-preco">R$ 79,90/m√™s</div>
            <button type="button" class="servico-btn">Assine</button>
          </div>
          <div class="servico-card" onclick="selecionarServico('Claro fibra 600 MEGA + globoplay + Claro p√≥s 60GB', window.modalServicoContexto)">
            <div class="servico-titulo">Claro<span style='color:#ff0000'> fibra</span></div>
            <div class="servico-mega">600 MEGA</div>
            <div class="servico-benef">globoplay + Wi-Fi Gr√°tis + Claro p√≥s 60GB</div>
            <div class="servico-preco">R$ 159,90/m√™s</div>
            <button type="button" class="servico-btn">Assine</button>
          </div>
          <div class="servico-card" onclick="selecionarServico('Claro controle 30GB + b√¥nus', window.modalServicoContexto)">
            <div class="servico-titulo">Claro<span style='color:#ff0000'> controle</span></div>
            <div class="servico-mega">30GB</div>
            <div class="servico-benef">15GB + 5GB redes sociais + WhatsApp ilimitado + 10GB b√¥nus</div>
            <div class="servico-preco">R$ 59,90/m√™s</div>
            <button type="button" class="servico-btn">Contrate</button>
          </div>
          <div class="servico-card" onclick="selecionarServico('Claro p√≥s 50GB', window.modalServicoContexto)">
            <div class="servico-titulo">Claro<span style='color:#ff0000'> p√≥s</span></div>
            <div class="servico-mega">50GB</div>
            <div class="servico-benef">25GB + 25GB + WhatsApp ilimitado</div>
            <div class="servico-preco">R$ 119,90/m√™s</div>
            <button type="button" class="servico-btn">Contrate</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Overlay de loading -->
    <div id="loadingOverlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.7);z-index:10000;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:32px 40px;border-radius:12px;box-shadow:0 2px 16px #0002;display:flex;flex-direction:column;align-items:center;gap:16px;">
        <div class="spinner" style="border:6px solid #eee;border-top:6px solid #ff0000;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;"></div>
        <span style="font-size:1.1em;color:#333;">Carregando...</span>
      </div>
    </div>

    <!-- Notifica√ß√£o -->
    <div class="notification" id="notification"></div>
  </div>
  
  <style>
    @keyframes spin { 
      0% { transform: rotate(0deg);} 
      100% { transform: rotate(360deg);} 
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Container principal melhorado */
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      margin: 20px auto;
      max-width: 1000px;
      padding: 30px;
    }
    
    /* Header do dashboard melhorado */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      margin-bottom: 30px;
      border-bottom: 2px solid #f1f3f4;
      background: linear-gradient(135deg, #d31a20 0%, #ff4757 100%);
      border-radius: 15px;
      padding: 20px 25px;
      color: white;
      box-shadow: 0 8px 25px rgba(211, 26, 32, 0.3);
    }
    
    .dashboard-header .logo {
      height: 45px;
      filter: brightness(0) invert(1);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 20px;
      color: #fff;
      font-weight: 500;
    }
    
    .user-info span {
      font-size: 16px;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }
    
    .btn-logout {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 25px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .btn-logout:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    /* T√≠tulo principal */
    h2 {
      color: #2c3e50;
      font-size: 28px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* Sistema de abas melhorado */
    .tabs {
      display: flex;
      background: #f8f9fa;
      border-radius: 15px;
      padding: 8px;
      margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      gap: 5px;
    }
    
    .tab {
      flex: 1;
      padding: 15px 20px;
      text-align: center;
      cursor: pointer;
      border-radius: 10px;
      font-weight: 500;
      font-size: 15px;
      transition: all 0.3s ease;
      color: #6c757d;
      background: transparent;
      border: none;
      position: relative;
      overflow: hidden;
    }
    
    .tab:hover {
      background: rgba(211, 26, 32, 0.1);
      color: #d31a20;
      transform: translateY(-2px);
    }
    
    .tab.active {
      background: linear-gradient(135deg, #d31a20, #ff4757);
      color: white;
      box-shadow: 0 8px 20px rgba(211, 26, 32, 0.4);
      transform: translateY(-3px);
    }
    
    .tab.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
      pointer-events: none;
    }
    
    /* Formul√°rios melhorados */
    #areaAutenticada > form, 
    #areaAutenticada > div {
      animation: slideIn 0.5s ease-out;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid #e9ecef;
    }
    
    #areaAutenticada > form h3,
    #areaAutenticada > div h3 {
      color: #2c3e50;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 3px solid #d31a20;
      display: inline-block;
    }
    
    /* Campos de entrada melhorados */
    .field-container {
      margin-bottom: 20px;
    }
    
    .field-container label {
      display: block;
      margin-bottom: 8px;
      color: #495057;
      font-weight: 500;
      font-size: 14px;
    }
    
    .field-container input,
    .field-container textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: #fff;
    }
    
    .field-container input:focus,
    .field-container textarea:focus {
      outline: none;
      border-color: #d31a20;
      box-shadow: 0 0 0 3px rgba(211, 26, 32, 0.1);
      transform: translateY(-1px);
    }
    
    .field-container input[readonly] {
      background: #f8f9fa !important;
      color: #6c757d;
      cursor: not-allowed;
    }
    
    .field-container small {
      display: block;
      margin-top: 5px;
      color: #6c757d;
      font-size: 12px;
    }
    
    /* Bot√µes melhorados */
    .submit-btn {
      background: linear-gradient(135deg, #d31a20, #ff4757);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 20px rgba(211, 26, 32, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      width: 100%;
      margin-top: 20px;
    }
    
    .submit-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 25px rgba(211, 26, 32, 0.4);
      background: linear-gradient(135deg, #ff4757, #d31a20);
    }
    
    .submit-btn:active {
      transform: translateY(-1px);
    }
    
    /* Modal de servi√ßos melhorado */
    .modal-servicos {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      animation: fadeIn 0.3s ease;
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      position: relative;
      animation: slideIn 0.4s ease;
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      color: #adb5bd;
      cursor: pointer;
      transition: color 0.3s ease;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: #f8f9fa;
    }
    
    .close-modal:hover {
      color: #d31a20;
      background: #ffebee;
    }
    
    /* Cards de servi√ßo melhorados */
    .servicos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .servico-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 2px solid #e9ecef;
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .servico-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
      border-color: #d31a20;
    }
    
    .servico-titulo {
      font-size: 20px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    
    .servico-mega {
      font-size: 32px;
      font-weight: 800;
      color: #d31a20;
      margin: 15px 0;
    }
    
    .servico-benef {
      color: #6c757d;
      font-size: 14px;
      margin: 15px 0;
      line-height: 1.4;
    }
    
    .servico-preco {
      font-size: 24px;
      font-weight: 700;
      color: #28a745;
      margin: 15px 0;
    }
    
    .servico-btn {
      background: linear-gradient(135deg, #d31a20, #ff4757);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 12px 25px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    .servico-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(211, 26, 32, 0.3);
    }
    
    /* Responsividade melhorada */
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 20px;
        border-radius: 15px;
      }
      
      .dashboard-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .tabs {
        flex-direction: column;
        gap: 8px;
      }
      
      .tab {
        padding: 12px 15px;
      }
      
      .servicos-grid {
        grid-template-columns: 1fr;
      }
      
      h2 {
        font-size: 24px;
      }
    }
    
    /* Indicadores de loading melhorados */
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #d31a20;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    
    /* Notifica√ß√µes melhoradas */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 12px;
      color: white;
      font-weight: 500;
      z-index: 10002;
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.4s ease;
      max-width: 350px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
    }
    
    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .notification.success {
      background: linear-gradient(135deg, #28a745, #20c997);
    }
    
    .notification.error {
      background: linear-gradient(135deg, #dc3545, #e74c3c);
    }
    
    .notification.info {
      background: linear-gradient(135deg, #17a2b8, #3498db);
    }
  </style>
  
  <script src="navigation.js"></script>
  <script src="script.js"></script>
  <script>
    // Inicializar dashboard
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar se o usu√°rio est√° autenticado
      checkAuth();
      
      // Carregar dados do usu√°rio
      loadUserData();
      
      // Inicializar funcionalidades espec√≠ficas do dashboard
      if (typeof initializeDashboard === 'function') {
        initializeDashboard();
      }
      
      // Adicionar event listeners para formul√°rios
      initializeFormHandlers();
      
      // Adicionar busca de CEP autom√°tica
      initializeCepSearch();
      
      // Mostrar primeira aba por padr√£o
      showTab(0);
    });

    // Inicializar handlers dos formul√°rios
    function initializeFormHandlers() {
      // Form de manuten√ß√£o
      const formVistoria = document.getElementById('formVistoria');
      if (formVistoria) {
        formVistoria.addEventListener('submit', handleVistoriaSubmit);
      }
      
      // Form de troca de servi√ßo
      const formTroca = document.getElementById('formTrocaServico');
      if (formTroca) {
        formTroca.addEventListener('submit', handleTrocaSubmit);
      }
      
      // Busca de protocolo
      const btnBuscarProtocolo = document.getElementById('btnBuscarProtocolo');
      if (btnBuscarProtocolo) {
        btnBuscarProtocolo.addEventListener('click', buscarProtocolo);
      }
    }

    // Inicializar busca de CEP
    function initializeCepSearch() {
      const cepField = document.getElementById('vistoriaCep');
      if (cepField) {
        cepField.addEventListener('blur', function() {
          const cep = this.value.replace(/\D/g, '');
          if (cep.length === 8) {
            buscarEnderecoPorCep(cep);
          }
        });
      }
    }

    // Buscar endere√ßo por CEP
    async function buscarEnderecoPorCep(cep) {
      try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();
        
        if (!data.erro) {
          const enderecoCompleto = `${data.logradouro}, ${data.bairro}, ${data.localidade} - ${data.uf}`;
          document.getElementById('vistoriaEndereco').value = enderecoCompleto;
          
          // Salvar no localStorage para usar em outras abas
          const userData = JSON.parse(localStorage.getItem('userData') || '{}');
          userData.endereco = enderecoCompleto;
          userData.cep = cep;
          localStorage.setItem('userData', JSON.stringify(userData));
          
          showNotification('Endere√ßo preenchido automaticamente!', 'success');
        }
      } catch (error) {
        console.error('Erro ao buscar CEP:', error);
        showNotification('N√£o foi poss√≠vel buscar o endere√ßo', 'error');
      }
    }

    // Handler para submit do formul√°rio de manuten√ß√£o
    async function handleVistoriaSubmit(e) {
      e.preventDefault();
      
      const formData = {
        tipo: 'manutencao',
        cpf: document.getElementById('vistoriaCpf').value.replace(/\D/g, ''),
        nome: document.getElementById('vistoriaNomeCliente').value,
        cep: document.getElementById('vistoriaCep').value.replace(/\D/g, ''),
        endereco: document.getElementById('vistoriaEndereco').value,
        apartamento: document.getElementById('vistoriaApartamento').value,
        bloco: document.getElementById('vistoriaBloco').value,
        telefone: document.getElementById('vistoriaTelefone').value.replace(/\D/g, ''),
        descricao: document.getElementById('vistoriaDescricao').value,
        horario_contato: document.getElementById('vistoriaHorario').value,
        servico_atual: document.getElementById('vistoriaServicoAtual').value
      };
      
      await submitSolicitacao(formData, 'Solicita√ß√£o de manuten√ß√£o enviada com sucesso!');
    }

    // Handler para submit do formul√°rio de troca
    async function handleTrocaSubmit(e) {
      e.preventDefault();
      
      const novoServicoElement = document.querySelector('#trocaServicoContainer .servico-nome');
      if (!novoServicoElement) {
        showNotification('Por favor, selecione um novo servi√ßo', 'error');
        return;
      }
      
      const formData = {
        tipo: 'troca_servico',
        cpf: document.getElementById('trocaCpf').value.replace(/\D/g, ''),
        nome: document.getElementById('trocaNomeCliente').value,
        endereco: document.getElementById('trocaEndereco').value,
        apartamento: document.getElementById('trocaApartamento').value,
        bloco: document.getElementById('trocaBloco').value,
        servico_atual: document.getElementById('trocaServicoAtual').value,
        novo_servico: novoServicoElement.textContent
      };
      
      await submitSolicitacao(formData, 'Solicita√ß√£o de troca de servi√ßo enviada com sucesso!');
    }

    // Enviar solicita√ß√£o para o servidor
    async function submitSolicitacao(formData, successMessage) {
      try {
        showLoading(true);
        
        const response = await fetch('https://chegar-primeiro.onrender.com/api/solicitacoes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showNotification(successMessage, 'success');
          if (result.protocolo) {
            showNotification(`Protocolo: ${result.protocolo}`, 'info');
          }
          // Limpar formul√°rio espec√≠fico
          clearForm(formData.tipo);
        } else {
          showNotification(result.error || 'Erro ao enviar solicita√ß√£o', 'error');
        }
      } catch (error) {
        console.error('Erro ao enviar solicita√ß√£o:', error);
        showNotification('Erro de conex√£o. Tente novamente.', 'error');
      } finally {
        showLoading(false);
      }
    }

    // Limpar formul√°rio ap√≥s envio
    function clearForm(tipo) {
      if (tipo === 'manutencao') {
        document.getElementById('vistoriaDescricao').value = '';
        document.getElementById('vistoriaHorario').value = '';
      } else if (tipo === 'troca_servico') {
        const container = document.getElementById('trocaServicoContainer');
        container.innerHTML = '<button type="button" class="select-service-btn" onclick="abrirModalServicos(\'troca\')" id="btnSelecionarNovoServico">Selecionar novo servi√ßo</button>';
      }
    }

    // Buscar protocolo
    async function buscarProtocolo() {
      const protocolo = document.getElementById('inputProtocolo').value.trim();
      
      if (!protocolo) {
        showNotification('Digite um n√∫mero de protocolo', 'error');
        return;
      }
      
      try {
        showLoading(true);
        
        const response = await fetch(`https://chegar-primeiro.onrender.com/api/solicitacoes/${protocolo}`);
        const result = await response.json();
        
        const resultDiv = document.getElementById('resultadoAcompanhamento');
        
        if (response.ok) {
          resultDiv.innerHTML = `
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
              <h4 style="color: #28a745; margin-bottom: 15px;">‚úÖ Protocolo Encontrado</h4>
              <p><strong>Protocolo:</strong> ${result.protocolo}</p>
              <p><strong>Tipo:</strong> ${result.tipo}</p>
              <p><strong>Status:</strong> ${result.status || 'Em andamento'}</p>
              <p><strong>Data:</strong> ${new Date(result.data_criacao).toLocaleDateString('pt-BR')}</p>
              ${result.descricao ? `<p><strong>Descri√ß√£o:</strong> ${result.descricao}</p>` : ''}
            </div>
          `;
        } else {
          resultDiv.innerHTML = `
            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107;">
              <h4 style="color: #856404;">‚ö†Ô∏è Protocolo n√£o encontrado</h4>
              <p>Verifique se o n√∫mero do protocolo est√° correto e tente novamente.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Erro ao buscar protocolo:', error);
        showNotification('Erro ao buscar protocolo', 'error');
      } finally {
        showLoading(false);
      }
    }

    // Fun√ß√£o para mostrar/ocultar loading
    function showLoading(show) {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.style.display = show ? 'flex' : 'none';
      }
    }

    // Fun√ß√£o para mostrar notifica√ß√µes
    function showNotification(message, type = 'info', duration = 5000) {
      const notification = document.getElementById('notification');
      if (!notification) return;
      
      notification.className = `notification show ${type}`;
      notification.textContent = message;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }

    // Fun√ß√£o para verificar autentica√ß√£o
    function checkAuth() {
      // Se n√£o estiver autenticado, redirecionar para login
      const isAuthenticated = localStorage.getItem('userAuthenticated');
      if (!isAuthenticated) {
        window.location.href = 'index-principal.html';
        return;
      }
    }

    // Fun√ß√£o para carregar dados do usu√°rio
    function loadUserData() {
      const userData = JSON.parse(localStorage.getItem('userData') || '{}');
      console.log('Dados do usu√°rio carregados:', userData);
      
      if (userData.nome) {
        document.getElementById('welcomeUser').textContent = `Bem-vindo, ${userData.nome}!`;
        
        // Preencher todos os campos com dados do usu√°rio
        const fields = {
          'vistoriaNomeCliente': userData.nome,
          'trocaNomeCliente': userData.nome,
          'vistoriaCpf': userData.cpf || '',
          'trocaCpf': userData.cpf || '',
          'vistoriaEndereco': userData.endereco || '',
          'trocaEndereco': userData.endereco || '',
          'vistoriaApartamento': userData.apartamento || '',
          'trocaApartamento': userData.apartamento || '',
          'vistoriaBloco': userData.bloco || '',
          'trocaBloco': userData.bloco || '',
          'vistoriaTelefone': userData.telefone || '',
          'vistoriaServicoAtual': userData.servico_atual || 'Claro fibra 350 MEGA',
          'trocaServicoAtual': userData.servico_atual || 'Claro fibra 350 MEGA',
          'vistoriaCep': userData.cep || ''
        };
        
        Object.entries(fields).forEach(([fieldId, value]) => {
          const field = document.getElementById(fieldId);
          if (field && value) {
            field.value = value;
          }
        });
        
        // Formatar CPF e telefone se necess√°rio
        if (userData.cpf) {
          const cpfFormatado = formatCPF(userData.cpf);
          document.getElementById('vistoriaCpf').value = cpfFormatado;
          document.getElementById('trocaCpf').value = cpfFormatado;
        }
        
        if (userData.telefone) {
          const telefoneFormatado = formatTelefone(userData.telefone);
          document.getElementById('vistoriaTelefone').value = telefoneFormatado;
        }
        
        if (userData.cep) {
          const cepFormatado = formatCEP(userData.cep);
          document.getElementById('vistoriaCep').value = cepFormatado;
        }
      }
    }

    // Fun√ß√µes de formata√ß√£o
    function formatCPF(cpf) {
      const cleanCpf = cpf.replace(/\D/g, '');
      return cleanCpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }

    function formatTelefone(telefone) {
      const cleanTel = telefone.replace(/\D/g, '');
      if (cleanTel.length === 11) {
        return cleanTel.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
      }
      return telefone;
    }

    function formatCEP(cep) {
      const cleanCep = cep.replace(/\D/g, '');
      return cleanCep.replace(/(\d{5})(\d{3})/, '$1-$2');
    }

    // Fun√ß√£o de logout
    function logout() {
      localStorage.removeItem('userAuthenticated');
      localStorage.removeItem('userData');
      window.location.href = 'index-principal.html';
    }

    // Fun√ß√£o para trocar abas (melhorada)
    function showTab(index) {
      // Remover classe active de todas as abas
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      
      // Ocultar todos os formul√°rios e se√ß√µes
      const forms = document.querySelectorAll('#formVistoria, #formTrocaServico, #acompanharSolicitacao');
      forms.forEach(form => {
        form.style.display = 'none';
        form.classList.remove('active');
      });
      
      // Ativar aba selecionada
      const tabs = document.querySelectorAll('.tab');
      if (tabs[index]) {
        tabs[index].classList.add('active');
      }
      
      // Mostrar conte√∫do correspondente
      switch(index) {
        case 0:
          const formVistoria = document.getElementById('formVistoria');
          if (formVistoria) {
            formVistoria.style.display = 'flex';
            formVistoria.classList.add('active');
          }
          break;
        case 1:
          const formTroca = document.getElementById('formTrocaServico');
          if (formTroca) {
            formTroca.style.display = 'flex';
            formTroca.classList.add('active');
          }
          break;
        case 2:
          const acompanhar = document.getElementById('acompanharSolicitacao');
          if (acompanhar) {
            acompanhar.style.display = 'block';
            acompanhar.classList.add('active');
          }
          break;
      }
      
      // Recarregar dados do usu√°rio ao trocar de aba
      loadUserData();
    }

    // Fun√ß√£o para abrir modal de servi√ßos
    function abrirModalServicos(contexto) {
      window.modalServicoContexto = contexto;
      document.getElementById('modalServicos').style.display = 'flex';
    }

    // Fun√ß√£o para fechar modal de servi√ßos
    function fecharModalServicos() {
      document.getElementById('modalServicos').style.display = 'none';
    }

    // Fun√ß√£o para selecionar servi√ßo (melhorada)
    function selecionarServico(nomeServico, contexto) {
      const container = document.getElementById(contexto + 'ServicoContainer');
      if (container) {
        container.innerHTML = `
          <div class="servico-selecionado" style="background: linear-gradient(135deg, #e8f5e8, #f0f9ff); border: 2px solid #28a745; border-radius: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <span class="servico-nome" style="font-weight: 600; color: #155724; display: block;">${nomeServico}</span>
              <small style="color: #6c757d;">Servi√ßo selecionado</small>
            </div>
            <button type="button" onclick="abrirModalServicos('${contexto}')" class="btn-alterar-servico" style="background: #ffc107; border: none; border-radius: 20px; padding: 8px 15px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.3s ease;">
              üîÑ Alterar
            </button>
          </div>
        `;
      }
      fecharModalServicos();
      showNotification('Servi√ßo selecionado com sucesso!', 'success');
    }

    // Melhorar estilo dos bot√µes de sele√ß√£o de servi√ßo
    function updateServiceButtonStyle() {
      const selectButtons = document.querySelectorAll('.select-service-btn');
      selectButtons.forEach(button => {
        button.style.cssText = `
          background: linear-gradient(135deg, #6c757d, #495057);
          color: white;
          border: none;
          border-radius: 10px;
          padding: 15px 20px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.3s ease;
          width: 100%;
          font-size: 14px;
        `;
      });
    }

    // Atualizar estilos na inicializa√ß√£o
    setTimeout(updateServiceButtonStyle, 100);
  </script>
</body>
</html>
