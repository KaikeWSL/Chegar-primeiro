<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Cadastro - Chegar Primeiro Claro">
  <meta name="keywords" content="Claro, cadastro, registro, novo cliente">
  <meta name="author" content="Claro">
  <meta name="robots" content="noindex, nofollow">
  
  <!-- Seguran√ßa -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://chegar-primeiro.onrender.com https://viacep.com.br https://brasilapi.com.br; font-src 'self' data:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  
  <!-- PWA Support -->
  <meta name="theme-color" content="#d31a20">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <title>Cadastro - Chegar Primeiro</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="login-improvements.css">
  <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/9/9c/LogoClaro2017.png">
</head>
<body class="cadastro-ativo">
  <div class="container">
    <img src="https://upload.wikimedia.org/wikipedia/commons/9/9c/LogoClaro2017.png" class="logo" alt="Logo Claro">
    <h2 style="text-align:center; margin-bottom: 18px;">Chegar Primeiro</h2>
    
    <form id="formCadastro" style="display:flex; flex-direction:column;">
      <div class="form-header">
        <h2>üìù Cadastro de Novo Cliente</h2>
        <p class="form-subtitle">Preencha seus dados para criar sua conta</p>
      </div>

      <!-- Se√ß√£o Dados Pessoais -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-icon">üë§</div>
          <h3>Dados Pessoais</h3>
        </div>
        
        <div class="form-row">
          <div class="field-group full-width">
            <label>Nome Completo <span class="required">*</span></label>
            <input type="text" id="cadNome" required minlength="2" autocomplete="name" placeholder="Digite seu nome completo">
            <div class="field-hint">M√≠nimo 2 caracteres</div>
          </div>
        </div>

        <div class="form-row">
          <div class="field-group half-width">
            <label>CPF/CNPJ <span class="required">*</span></label>
            <input type="text" id="cadCpf" required maxlength="18" autocomplete="off" placeholder="000.000.000-00">
          </div>
          <div class="field-group half-width">
            <label>Email <span class="required">*</span></label>
            <div class="input-with-icon">
              <input type="email" id="cadEmail" required autocomplete="email" placeholder="seu@email.com">
              <span id="iconeEmailVerificado" class="input-icon verified-icon" style="display:none;">‚úî</span>
            </div>
            <button type="button" id="btnVerificarEmail" class="btn-secondary" style="display:none; margin-top:8px;">
              Verificar e-mail
            </button>
            <div id="areaCodigoEmail" class="verification-area" style="display:none;">
              <label class="verification-label">Digite o c√≥digo recebido no e-mail:</label>
              <div class="verification-input-group">
                <input type="text" id="inputCodigoEmail" maxlength="6" class="verification-code" placeholder="000000">
                <button type="button" id="btnValidarCodigoEmail" class="btn-verify">Validar</button>
              </div>
              <div id="statusCodigoEmail" class="verification-status"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Se√ß√£o Contato -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-icon">üìû</div>
          <h3>Contato</h3>
        </div>
        
        <div class="form-row">
          <div class="field-group half-width">
            <label>Telefone</label>
            <input type="text" id="cadTelefone" autocomplete="tel" placeholder="(11) 99999-9999">
            <div class="field-hint">Formato: (11) 99999-9999</div>
          </div>
          <div class="field-group half-width">
            <label>Celular</label>
            <input type="text" id="cadCelular" autocomplete="tel" placeholder="(11) 91234-5678">
          </div>
        </div>
      </div>

      <!-- Se√ß√£o Endere√ßo -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-icon">üìç</div>
          <h3>Endere√ßo</h3>
        </div>
        
        <div class="form-row">
          <div class="field-group half-width">
            <label>CEP <span class="required">*</span></label>
            <input type="text" id="cadCep" required maxlength="9" autocomplete="postal-code" placeholder="00000-000">
            <div class="field-hint">Preencheremos o endere√ßo automaticamente</div>
          </div>
          <div class="field-group half-width">
            <label>Logradouro <span class="required">*</span></label>
            <input type="text" id="cadEndereco" required autocomplete="street-address" readonly class="readonly-field">
            <div class="field-hint">Preenchido automaticamente pelo CEP</div>
          </div>
        </div>

        <div class="form-row">
          <div class="field-group third-width">
            <label>N√∫mero <span class="required">*</span></label>
            <input type="text" id="cadNumero" required placeholder="123">
          </div>
          <div class="field-group third-width">
            <label>Complemento</label>
            <input type="text" id="cadComplemento" placeholder="Apto, Sala, etc.">
          </div>
          <div class="field-group third-width">
            <label>Bairro</label>
            <input type="text" id="cadBairro" readonly class="readonly-field">
          </div>
        </div>

        <div class="form-row">
          <div class="field-group half-width">
            <label>Cidade</label>
            <input type="text" id="cadCidade" readonly class="readonly-field">
          </div>
          <div class="field-group quarter-width">
            <label>Estado</label>
            <select id="cadEstado" disabled class="readonly-field">
              <option value="SP">SP</option>
            </select>
          </div>
          <div class="field-group quarter-width">
            <label>Apartamento</label>
            <input type="text" id="cadApartamento" required placeholder="101">
          </div>
        </div>

        <div class="form-row">
          <div class="field-group half-width">
            <label>Bloco</label>
            <input type="text" id="cadBloco" required placeholder="A">
          </div>
          <div class="field-group half-width">
            <label>Nome do empreendimento</label>
            <input type="text" id="cadEmpreendimento" placeholder="Nome do condom√≠nio/residencial">
          </div>
        </div>
      </div>

      <!-- Se√ß√£o Servi√ßo -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-icon">üì°</div>
          <h3>Servi√ßo Contratado</h3>
        </div>
        
        <div class="form-row">
          <div class="field-group full-width">
            <label>Selecione seu plano</label>
            <div class="servico-container" id="cadastroServicoContainer">
              <button type="button" class="btn-select-service" onclick="console.log('[CLICK] Bot√£o clicado!'); console.log('[DEBUG] window.cadastroAbrirModalServicos exists?', typeof window.cadastroAbrirModalServicos); try { window.cadastroAbrirModalServicos('cadastro'); } catch(e) { console.error('[ERROR] Erro ao chamar cadastroAbrirModalServicos:', e); }" id="btnSelecionarServico">
                <span class="btn-icon">+</span>
                Selecionar servi√ßo
              </button>
            </div>
            <!-- Campo oculto para armazenar o servi√ßo selecionado -->
            <input type="hidden" id="cadServico" name="servico" value="">
            <div class="field-hint">Escolha o plano que melhor atende suas necessidades</div>
          </div>
        </div>
      </div>

      <!-- Se√ß√£o Dados de Acesso -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-icon">üîí</div>
          <h3>Dados de Acesso</h3>
        </div>
        
        <div class="form-row">
          <div class="field-group half-width">
            <label>Senha <span class="required">*</span></label>
            <div class="password-input-container">
              <input type="password" id="cadSenha" required autocomplete="new-password" minlength="8" placeholder="M√≠nimo 8 caracteres">
              <button type="button" class="btn-toggle-password" onclick="togglePasswordVisibility('cadSenha')">üëÅ</button>
            </div>
            <div class="password-requirements">
              <div class="requirement-item" id="req-length">
                <span class="requirement-icon">‚óã</span>
                <span>M√≠nimo 8 caracteres</span>
              </div>
              <div class="requirement-item" id="req-upper">
                <span class="requirement-icon">‚óã</span>
                <span>Uma letra mai√∫scula</span>
              </div>
              <div class="requirement-item" id="req-lower">
                <span class="requirement-icon">‚óã</span>
                <span>Uma letra min√∫scula</span>
              </div>
              <div class="requirement-item" id="req-number">
                <span class="requirement-icon">‚óã</span>
                <span>Um n√∫mero</span>
              </div>
              <div class="requirement-item" id="req-special">
                <span class="requirement-icon">‚óã</span>
                <span>Um caractere especial</span>
              </div>
            </div>
          </div>
          <div class="field-group half-width">
            <label>Confirmar Senha <span class="required">*</span></label>
            <div class="password-input-container">
              <input type="password" id="cadSenha2" required autocomplete="new-password" placeholder="Repita a senha">
              <button type="button" class="btn-toggle-password" onclick="togglePasswordVisibility('cadSenha2')">üëÅ</button>
            </div>
            <div id="password-match-indicator" class="password-match-indicator"></div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-primary">
          <span class="btn-icon">‚úì</span>
          Realizar Cadastro
        </button>
        <button type="button" onclick="window.location.href='index-principal.html'" class="btn-secondary">
          <span class="btn-icon">‚Üê</span>
          Voltar ao In√≠cio
        </button>
      </div>
      
      <!-- Link para login -->
      <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; margin-top: 16px;">
        <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 8px; text-align: center;">J√° possui cadastro?</p>
        <button type="button" onclick="window.location.href='login.html'" class="link-btn" style="color: #00bcd4; text-decoration: underline; display: block; margin: 0 auto;">
          üîê Fazer Login
        </button>
      </div>
    </form>

    <!-- Modal de sele√ß√£o de servi√ßos -->
    <div class="modal-servicos" id="modalServicos">
      <div class="modal-content">
        <span class="close-modal" onclick="window.cadastroFecharModalServicos()">&times;</span>
        <h3 style="color: #fff; text-align: center; margin-bottom: 25px; font-size: 26px; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
          Escolha seu Plano Claro
        </h3>
        <div class="servicos-grid" id="servicosGrid">
          <!-- Ofertas ser√£o carregadas dinamicamente -->
          <div class="loading-servicos" style="display: flex; justify-content: center; align-items: center; height: 200px; color: #fff;">
            <div class="spinner" style="border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-right: 15px;"></div>
            <span>Carregando planos...</span>
        </div>
      </div>
    </div>

    <!-- Iframe oculto para carregar ofertas em background -->
    <iframe 
      id="ofertasLoader" 
      src="ofertas-loader.html" 
      style="display: none; width: 0; height: 0; border: none;">
    </iframe>

    <!-- Overlay de loading melhorado para cadastro -->
    <div id="loadingOverlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:40px 50px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.3);display:flex;flex-direction:column;align-items:center;gap:20px;max-width:400px;text-align:center;">
        <!-- Spinner animado -->
        <div class="spinner" style="border:6px solid #f0f0f0;border-top:6px solid #d31a20;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;"></div>
        
        <!-- Texto de status -->
        <div style="display:flex;flex-direction:column;gap:8px;">
          <span id="loadingText" style="font-size:1.3em;color:#333;font-weight:600;">Realizando Cadastro...</span>
          <span id="loadingSubtext" style="font-size:0.95em;color:#666;line-height:1.4;">Aguarde enquanto processamos seus dados</span>
        </div>
        
        <!-- Barra de progresso visual -->
        <div style="width:100%;height:4px;background:#f0f0f0;border-radius:2px;overflow:hidden;">
          <div id="loadingProgress" style="height:100%;background:linear-gradient(90deg, #d31a20, #ff4757);width:0%;transition:width 0.3s ease;border-radius:2px;"></div>
        </div>
        
        <!-- Dica adicional -->
        <span style="font-size:0.85em;color:#888;font-style:italic;">Este processo pode levar alguns segundos</span>
      </div>
    </div>

    <!-- Notifica√ß√£o -->
    <div class="notification" id="notification"></div>
  </div>
  
  <style>
    @keyframes spin { 
      0% { transform: rotate(0deg);} 
      100% { transform: rotate(360deg);} 
    }
    
    /* Estilos para notifica√ß√µes */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 10002;
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 300px;
    }
    
    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .notification.success {
      background: #28a745;
    }
    
    .notification.error {
      background: #ff4757;
    }
    
    .notification.info {
      background: #17a2b8;
    }
    
    /* Estilos para valida√ß√£o de campos */
    .validation-message {
      font-size: 0.8em !important;
      margin-top: 4px !important;
      font-weight: 500;
    }
    
    .field-valid {
      border-color: #28a745 !important;
    }
    
    .field-invalid {
      border-color: #ff4757 !important;
    }
    
    /* Estilos para requisitos de senha */
    .password-requirements {
      margin-top: 8px;
      font-size: 0.85em;
    }
    
    .requirement-item {
      display: flex;
      align-items: center;
      margin: 4px 0;
      color: rgba(255, 255, 255, 0.95);
      transition: all 0.3s ease;
      font-weight: 500;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }
    
    .requirement-icon {
      margin-right: 8px;
      font-weight: bold;
      min-width: 16px;
      color: rgba(255, 255, 255, 0.95);
    }
    
    /* Estilo para indicador de senhas coincidentes */
    .password-match-indicator {
      margin-top: 8px;
      font-size: 0.85em;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
    }
    
    /* Estilos espec√≠ficos para √°rea de senha - melhor visibilidade */
    .form-section label {
      color: #fff !important;
      font-weight: 500;
      font-size: 14px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    .required {
      color: #ff6b6b !important;
      font-weight: bold;
    }
    
    /* Estilo para bot√£o de verificar email */
    .btn-secondary {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.3s ease;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    /* √Årea de verifica√ß√£o de email */
    .verification-area {
      margin-top: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
    }
    
    .verification-label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.9em;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .verification-input-group {
      display: flex;
      gap: 8px;
    }
    
    .verification-code {
      flex: 1;
      padding: 8px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      text-align: center;
      letter-spacing: 2px;
    }
    
    .btn-verify {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    
    .btn-verify:hover {
      background: #218838;
    }
    
    .verification-status {
      margin-top: 8px;
      font-size: 0.85em;
    }
    
    /* Estilos para avisos de dom√≠nio */
    .domain-warning {
      color: #856404 !important;
      font-size: 11px !important;
      display: block !important;
      margin-top: 2px !important;
    }
    
    /* Estilo para c√≥digo completo */
    .verification-code.code-complete {
      background: rgba(40, 167, 69, 0.1) !important;
      border-color: #28a745 !important;
    }
    
    /* === CSS DOS SERVI√áOS (IGUAL DASHBOARD) === */
    
    /* Modal seguindo padr√£o */
    .modal-servicos {
        
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      animation: fadeIn 0.3s ease;
    }
    
    .modal-servicos .modal-content {
      background: linear-gradient(to bottom, #8b1538 0%, #d31a20 50%, #b71717 100%) !important;
      border-radius: 12px;
      padding: 30px;
      max-width: 95vw;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      position: relative;
      animation: slideIn 0.4s ease;
      color: #fff !important;
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      color: rgba(255, 255, 255, 0.9);
      cursor: pointer;
      transition: all 0.3s ease;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .close-modal:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }
    
    /* Cards de servi√ßo */
    .servicos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
      padding: 10px 0;
    }
    
    .servico-card {
      background: #ffffff;
      border: 1px solid #e1e5e9;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #333;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .servico-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-color: #d31a20;
    }
    
    /* Estado selecionado melhorado */
    .servico-card.selected {
      background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
      border: 2px solid #4f46e5;
      box-shadow: 0 8px 30px rgba(79, 70, 229, 0.25);
      transform: translateY(-5px) scale(1.02);
    }
    
    .servico-card.selected::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #4f46e5, #7c3aed, #4f46e5);
      border-radius: 12px 12px 0 0;
    }
    
    .servico-card.selected::after {
      content: '‚úì';
      position: absolute;
      top: 15px;
      right: 15px;
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
    }
    
    .servico-titulo {
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
      line-height: 1.3;
    }
    
    .servico-mega {
      font-size: 36px;
      font-weight: 800;
      color: #e74c3c;
      margin: 12px 0;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .servico-benef {
      color: #6c757d;
      font-size: 13px;
      margin: 12px 0;
      line-height: 1.4;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .servico-preco {
      margin: 15px 0 8px 0;
    }
    
    .preco-original {
      font-size: 14px;
      color: #6c757d;
      text-decoration: line-through;
      margin-bottom: 4px;
    }
    
    .preco-promocional {
      font-size: 24px;
      font-weight: 700;
      color: #4f46e5;
    }
    
    .servico-btn {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .servico-btn:hover {
      background: linear-gradient(135deg, #c0392b, #a93226);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }
    
    /* Bot√£o quando selecionado */
    .servico-card.selected .servico-btn {
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
    }
    
    .servico-card.selected .servico-btn::before {
      content: '‚úì ';
      margin-right: 5px;
    }
    
    .servico-card.selected .servico-btn:hover {
      background: linear-gradient(135deg, #3730a3, #5b21b6);
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(79, 70, 229, 0.5);
    }
    
    /* Anima√ß√µes */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from { 
        opacity: 0;
        transform: translateY(-30px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes selectedPulse {
      0% { 
        box-shadow: 0 8px 30px rgba(79, 70, 229, 0.25);
      }
      50% { 
        box-shadow: 0 8px 35px rgba(79, 70, 229, 0.35);
      }
      100% { 
        box-shadow: 0 8px 30px rgba(79, 70, 229, 0.25);
      }
    }
    
    @keyframes checkmarkAppear {
      0% {
        opacity: 0;
        transform: scale(0) rotate(180deg);
      }
      50% {
        opacity: 1;
        transform: scale(1.2) rotate(360deg);
      }
      100% {
        opacity: 1;
        transform: scale(1) rotate(360deg);
      }
    }
    
    .servico-card.selected {
      animation: selectedPulse 2s ease-in-out infinite;
    }
    
    .servico-card.selected::after {
      animation: checkmarkAppear 0.5s ease-out;
    }
    
    /* Responsividade dos servi√ßos */
    @media (max-width: 768px) {
      .servicos-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .modal-content {
        margin: 15px;
        max-width: calc(100vw - 30px);
        padding: 20px;
      }
      
      .servico-card {
        padding: 18px;
      }
      
      .servico-mega {
        font-size: 30px;
      }
      
      .servico-titulo {
        font-size: 16px;
      }
      
      .servico-benef {
        font-size: 12px;
        min-height: 35px;
      }
    }
    
    @media (max-width: 480px) {
      .modal-content {
        margin: 10px;
        max-width: calc(100vw - 20px);
        padding: 15px;
      }
      
      .servicos-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
    }

    /* Modal de Protocolo - Estilo Dashboard */
    #modalProtocolo {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      display: none;
    }

    .modal-backdrop {
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    #modalProtocolo .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: white;
      padding: 20px;
      border-radius: 12px 12px 0 0;
      text-align: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .modal-body {
      padding: 0;
    }

    .protocol-section {
      padding: 30px;
      text-align: center;
      background: #f8f9fa;
    }

    .protocol-label {
      color: #6b7280;
      font-size: 14px;
      font-weight: 500;
      margin: 0 0 15px 0;
      letter-spacing: 0.5px;
    }

    .protocol-number-box {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0 25px 0;
    }

    .protocol-number {
      color: white;
      font-size: 24px;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      letter-spacing: 2px;
    }

    .btn-copy {
      background: white;
      color: #dc2626;
      border: 2px solid #dc2626;
      padding: 10px 25px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-copy:hover {
      background: #dc2626;
      color: white;
    }

    .success-section {
      background: #d1fae5;
      padding: 20px;
      margin: 0;
      border-left: 4px solid #10b981;
    }

    .success-section p {
      margin: 0 0 10px 0;
      color: #047857;
      font-size: 14px;
      line-height: 1.5;
    }

    .success-section p:last-child {
      margin-bottom: 0;
    }

    .next-steps-section {
      background: #fef3c7;
      padding: 20px;
      margin: 0;
      border-left: 4px solid #f59e0b;
      border-radius: 0 0 12px 12px;
    }

    .next-steps-section h3 {
      color: #92400e;
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 15px 0;
    }

    .next-steps-section ul {
      margin: 0;
      padding-left: 20px;
      color: #92400e;
    }

    .next-steps-section li {
      margin-bottom: 8px;
      font-size: 14px;
      line-height: 1.4;
    }

    .next-steps-section li:last-child {
      margin-bottom: 0;
    }

    /* Responsivo */
    @media (max-width: 768px) {
      .modal-content {
        margin: 10px;
        max-width: calc(100vw - 20px);
      }
      
      .protocol-number {
        font-size: 20px;
        letter-spacing: 1px;
      }
      
      .modal-header h2 {
        font-size: 18px;
      }
    }
  </style>
  
  <script src="navigation.js"></script>
  <script src="script.js"></script>
  <script>
    // === VARI√ÅVEIS GLOBAIS PARA OFERTAS ===
    window.ofertasDisponiveis = [];
    window.ofertasLoaderReady = false;
  </script>
  <script>
    // === SISTEMA DE OFERTAS OTIMIZADO (IGUAL DASHBOARD) ===

    // Vari√°veis globais para ofertas (igual dashboard)
    let ofertasDisponiveis = [];
    let ofertasLoaderReady = false;

    // Listener global para mensagens do iframe (CORRIGIDO E MELHORADO)
    window.addEventListener('message', function(event) {
      console.log('[INFO] Mensagem recebida do iframe:', event.data.type);
      
      if (event.data.type === 'iframe-ready') {
        console.log('[INFO] Iframe pronto');
        ofertasLoaderReady = true;
      } else if (event.data.type === 'ofertas-loaded') {
        console.log('[INFO] Ofertas carregadas:', event.data.status);
        console.log('[INFO] N√∫mero de ofertas:', event.data.ofertas ? event.data.ofertas.length : 0);
        console.log('[DEBUG] Ofertas recebidas:', event.data.ofertas);
        
        // Atualizar ofertas globais (igual dashboard)
        ofertasDisponiveis = event.data.ofertas || [];
        console.log('[DEBUG] ofertasDisponiveis atualizado:', ofertasDisponiveis.length);
        
        // Se modal estiver aberto, renderizar imediatamente
        const modal = document.getElementById('modalServicos');
        console.log('[DEBUG] Modal encontrado:', !!modal);
        console.log('[DEBUG] Modal display:', modal ? modal.style.display : 'N/A');
        
        if (modal && modal.style.display === 'flex') {
          console.log('[INFO] Modal aberto - renderizando ofertas');
          
          if (ofertasDisponiveis.length > 0) {
            console.log('[SUCCESS] Chamando renderizarServicos com', ofertasDisponiveis.length, 'ofertas');
            try {
              window.renderizarServicos(ofertasDisponiveis);
              console.log('[SUCCESS] renderizarServicos executado com sucesso');
            } catch (error) {
              console.error('[ERROR] Erro ao renderizar servi√ßos:', error);
              window.renderizarOfertasPadrao();
            }
          } else {
            console.log('[WARNING] Nenhuma oferta recebida, usando padr√£o');
            window.renderizarOfertasPadrao();
          }
          
          if (event.data.status === 'fallback') {
            window.showNotification('Usando ofertas padr√£o - Conex√£o limitada', 'info');
          }
        } else {
          console.log('[INFO] Modal n√£o est√° aberto, ofertas armazenadas para uso futuro');
        }
      } else if (event.data.type === 'oferta-selected') {
        window.selecionarServico(event.data.nome, window.modalServicoContexto);
      }
    });

    // Fun√ß√£o para inicializar sistema de ofertas
    async function initializeServicos() {
      console.log('[INFO] Sistema de ofertas inicializado');
      // O iframe carregar√° as ofertas automaticamente quando necess√°rio
    }

    // Inicializar iframe quando carregar (CORRIGIDO - igual dashboard)
    window.addEventListener('load', function() {
      console.log('[INFO] P√°gina carregada, inicializando sistema de ofertas...');
      
      // Inicializar vari√°veis globais (igual dashboard)
      ofertasDisponiveis = [];
      ofertasLoaderReady = false;
      
      const iframe = document.getElementById('ofertasLoader');
      if (iframe) {
        iframe.addEventListener('load', function() {
          console.log('[INFO] Iframe carregado com sucesso');
          ofertasLoaderReady = true;
        });
        
        // Verificar se j√° est√° carregado
        if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
          console.log('[INFO] Iframe j√° estava carregado');
          ofertasLoaderReady = true;
        }
      } else {
        console.error('[ERROR] Iframe ofertas-loader n√£o encontrado!');
      }
    });

    // === FIM SISTEMA DE OFERTAS OTIMIZADO ===
    // Inicializar sistema de cadastro
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar se o usu√°rio j√° est√° autenticado
      const isAuthenticated = localStorage.getItem('userAuthenticated');
      const userData = JSON.parse(localStorage.getItem('userData') || '{}');
      
      if (isAuthenticated === 'true' && userData.nome) {
        // Usu√°rio j√° est√° autenticado, redirecionar para dashboard
        window.location.href = 'dashboard.html';
        return;
      }

      // Garantir que estamos no modo cadastro
      document.body.className = 'cadastro-ativo';
      
      // Inicializar CSRF Token se n√£o existir
      if (!localStorage.getItem('csrfToken')) {
        const token = generateCSRFToken();
        localStorage.setItem('csrfToken', token);
        console.log('CSRF Token gerado:', token);
      }
      
      // Inicializar funcionalidades espec√≠ficas do cadastro
      if (typeof initializeRegistrationSystem === 'function') {
        initializeRegistrationSystem();
      }
      
      // Inicializar todas as funcionalidades do cadastro
      initializeCadastroFunctionalities();
      
      // Inicializar sistema de ofertas
      initializeServicos();
    });

    function generateCSRFToken() {
      const array = new Uint32Array(4);
      crypto.getRandomValues(array);
      return Array.from(array, dec => ('0' + dec.toString(16)).substr(-2)).join('');
    }

    // Vari√°vel para evitar inicializa√ß√£o dupla
    let cadastroFunctionalitiesInitialized = false;

    function initializeCadastroFunctionalities() {
      // Verificar se j√° foi inicializado
      if (cadastroFunctionalitiesInitialized) {
        console.warn('Funcionalidades do cadastro j√° foram inicializadas');
        return;
      }
      
      console.log('Inicializando funcionalidades do cadastro');
      cadastroFunctionalitiesInitialized = true;
      
      // Formata√ß√£o e valida√ß√£o de CPF
      const cpfInput = document.getElementById('cadCpf');
      if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          
          if (value.length <= 11) {
            // Formato CPF: 000.000.000-00
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
          } else {
            // Formato CNPJ: 00.000.000/0000-00
            value = value.replace(/(\d{2})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1/$2');
            value = value.replace(/(\d{4})(\d{1,2})$/, '$1-$2');
          }
          
          e.target.value = value;
          validateCPF(value);
        });
        
        cpfInput.addEventListener('blur', function(e) {
          validateCPF(e.target.value);
        });
      }

      // Formata√ß√£o de telefones
      const telefoneInput = document.getElementById('cadTelefone');
      const celularInput = document.getElementById('cadCelular');
      
      [telefoneInput, celularInput].forEach(input => {
        if (input) {
          input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length <= 10) {
              // Telefone fixo: (11) 9999-9999
              value = value.replace(/(\d{2})(\d)/, '($1) $2');
              value = value.replace(/(\d{4})(\d)/, '$1-$2');
            } else {
              // Celular: (11) 99999-9999
              value = value.replace(/(\d{2})(\d)/, '($1) $2');
              value = value.replace(/(\d{5})(\d)/, '$1-$2');
            }
            
            e.target.value = value;
          });
        }
      });

      // Preenchimento autom√°tico de CEP
      const cepInput = document.getElementById('cadCep');
      if (cepInput) {
        cepInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          value = value.replace(/(\d{5})(\d)/, '$1-$2');
          e.target.value = value;
          
          if (value.replace(/\D/g, '').length === 8) {
            preencherEnderecoPorCep(value.replace(/\D/g, ''));
          }
        });
      }

      // Verifica√ß√£o de email com funcionalidades avan√ßadas
      const emailInput = document.getElementById('cadEmail');
      const btnVerificarEmail = document.getElementById('btnVerificarEmail');
      
      if (emailInput) {
        emailInput.addEventListener('input', function(e) {
          const email = e.target.value.trim().toLowerCase();
          console.log('Email input event triggered:', email);
          validateEmail(email);
          
          // Reset status de verifica√ß√£o ao alterar email
          emailVerificado = false;
          const areaCodigoEmail = document.getElementById('areaCodigoEmail');
          const statusCodigoEmail = document.getElementById('statusCodigoEmail');
          const iconeEmailVerificado = document.getElementById('iconeEmailVerificado');
          
          if (areaCodigoEmail) areaCodigoEmail.style.display = 'none';
          if (statusCodigoEmail) statusCodigoEmail.textContent = '';
          if (iconeEmailVerificado) iconeEmailVerificado.style.display = 'none';
          
          // Verificar se √© um dom√≠nio confi√°vel
          if (email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            verificarDominioEmail(email);
          }
        });
        
        emailInput.addEventListener('blur', function(e) {
          console.log('Email blur event triggered:', e.target.value);
          validateEmail(e.target.value.trim().toLowerCase());
        });
      }
      
      if (btnVerificarEmail) {
        // Remover listener anterior se existir para evitar duplicatas
        btnVerificarEmail.removeEventListener('click', iniciarVerificacaoEmail);
        
        // Adicionar debounce para evitar cliques duplos
        let lastClickTime = 0;
        btnVerificarEmail.addEventListener('click', function(e) {
          const currentTime = Date.now();
          if (currentTime - lastClickTime < 2000) { // 2 segundos de prote√ß√£o
            console.warn('Clique muito r√°pido - ignorando');
            e.preventDefault();
            return;
          }
          lastClickTime = currentTime;
          
          console.log('Bot√£o verificar email clicado');
          iniciarVerificacaoEmail();
        });
      }
      
      // Bot√£o validar c√≥digo email com funcionalidades avan√ßadas
      const btnValidarCodigoEmail = document.getElementById('btnValidarCodigoEmail');
      const inputCodigoEmail = document.getElementById('inputCodigoEmail');
      
      if (btnValidarCodigoEmail) {
        btnValidarCodigoEmail.addEventListener('click', function() {
          console.log('Bot√£o validar c√≥digo clicado');
          validarCodigoEmail();
        });
      }
      
      // Funcionalidades avan√ßadas do campo de c√≥digo
      if (inputCodigoEmail) {
        // Validar c√≥digo ao pressionar Enter
        inputCodigoEmail.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            validarCodigoEmail();
          }
        });
        
        // Formatar c√≥digo automaticamente
        inputCodigoEmail.addEventListener('input', function() {
          this.value = this.value.replace(/\D/g, '').slice(0, 6);
          
          // Feedback visual para c√≥digo completo
          if (this.value.length === 6) {
            this.classList.add('code-complete');
            setTimeout(() => validarCodigoEmail(), 500);
          } else {
            this.classList.remove('code-complete');
          }
        });
      }

      // Valida√ß√£o de senha em tempo real
      const senhaInput = document.getElementById('cadSenha');
      const confirmSenhaInput = document.getElementById('cadSenha2');
      
      if (senhaInput) {
        senhaInput.addEventListener('input', function(e) {
          validatePassword(e.target.value);
        });
      }
      
      if (confirmSenhaInput) {
        confirmSenhaInput.addEventListener('input', function(e) {
          validatePasswordMatch();
        });
      }

      // Submit do formul√°rio
      const formCadastro = document.getElementById('formCadastro');
      if (formCadastro) {
        formCadastro.addEventListener('submit', function(e) {
          e.preventDefault();
          handleCadastroSubmit();
        });
      }
    }

    function validateCPF(cpf) {
      console.log('Validando CPF:', cpf);
      const cleanCpf = cpf.replace(/\D/g, '');
      console.log('CPF limpo:', cleanCpf);
      
      if (cleanCpf.length === 11) {
        if (isValidCPF(cleanCpf)) {
          console.log('CPF v√°lido');
          showFieldValidation('cadCpf', true, 'CPF v√°lido');
        } else {
          console.log('CPF inv√°lido');
          showFieldValidation('cadCpf', false, 'CPF inv√°lido');
        }
      } else if (cleanCpf.length === 14) {
        // Valida√ß√£o b√°sica de CNPJ
        console.log('CNPJ detectado');
        showFieldValidation('cadCpf', true, 'CNPJ v√°lido');
      } else if (cleanCpf.length > 0) {
        console.log('CPF/CNPJ incompleto');
        showFieldValidation('cadCpf', false, 'CPF/CNPJ incompleto');
      } else {
        console.log('CPF vazio, limpando valida√ß√£o');
        // Limpar valida√ß√£o se estiver vazio
        const field = document.getElementById('cadCpf');
        const existingMsg = field.parentNode.querySelector('.validation-message');
        if (existingMsg) {
          existingMsg.remove();
        }
        field.style.borderColor = '';
      }
    }

    function isValidCPF(cpf) {
      if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
      
      let sum = 0;
      for (let i = 0; i < 9; i++) {
        sum += parseInt(cpf.charAt(i)) * (10 - i);
      }
      let remainder = 11 - (sum % 11);
      if (remainder === 10 || remainder === 11) remainder = 0;
      if (remainder !== parseInt(cpf.charAt(9))) return false;
      
      sum = 0;
      for (let i = 0; i < 10; i++) {
        sum += parseInt(cpf.charAt(i)) * (11 - i);
      }
      remainder = 11 - (sum % 11);
      if (remainder === 10 || remainder === 11) remainder = 0;
      return remainder === parseInt(cpf.charAt(10));
    }

    async function preencherEnderecoPorCep(cep) {
      console.log('Buscando CEP:', cep);
      try {
        toggleLoading(true);
        
        // Tentar ViaCEP primeiro
        console.log('Tentando ViaCEP...');
        let response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        let data = await response.json();
        
        console.log('Resposta ViaCEP:', data);
        
        if (data.erro) {
          // Tentar BrasilAPI como fallback
          console.log('ViaCEP falhou, tentando BrasilAPI...');
          response = await fetch(`https://brasilapi.com.br/api/cep/v1/${cep}`);
          data = await response.json();
          console.log('Resposta BrasilAPI:', data);
        }
        
        if (data && !data.erro) {
          const endereco = data.logradouro || data.street || '';
          const bairro = data.bairro || data.district || '';
          const cidade = data.localidade || data.city || '';
          const estado = data.uf || data.state || '';
          
          console.log('Preenchendo campos:', { endereco, bairro, cidade, estado });
          
          document.getElementById('cadEndereco').value = endereco;
          document.getElementById('cadBairro').value = bairro;
          document.getElementById('cadCidade').value = cidade;
          
          const estadoSelect = document.getElementById('cadEstado');
          if (estadoSelect) {
            // Adicionar a op√ß√£o se n√£o existir
            let optionExists = false;
            for (let option of estadoSelect.options) {
              if (option.value === estado) {
                optionExists = true;
                break;
              }
            }
            if (!optionExists && estado) {
              const newOption = document.createElement('option');
              newOption.value = estado;
              newOption.textContent = estado;
              estadoSelect.appendChild(newOption);
            }
            estadoSelect.value = estado;
          }
          
          mostrarNotificacao('Endere√ßo preenchido automaticamente!', 'success');
        } else {
          console.log('CEP n√£o encontrado');
          mostrarNotificacao('CEP n√£o encontrado', 'error');
        }
      } catch (error) {
        console.error('Erro ao buscar CEP:', error);
        mostrarNotificacao('Erro ao buscar CEP', 'error');
      } finally {
        toggleLoading(false);
      }
    }

    function validateEmail(email) {
      console.log('Validando email:', email);
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const btnVerificarEmail = document.getElementById('btnVerificarEmail');
      
      if (email && emailRegex.test(email)) {
        console.log('Email v√°lido, mostrando bot√£o');
        showFieldValidation('cadEmail', true, 'Email v√°lido');
        if (btnVerificarEmail) {
          btnVerificarEmail.style.display = 'block';
        }
      } else if (email) {
        console.log('Email inv√°lido');
        showFieldValidation('cadEmail', false, 'Email inv√°lido');
        if (btnVerificarEmail) {
          btnVerificarEmail.style.display = 'none';
        }
      } else {
        console.log('Email vazio');
        if (btnVerificarEmail) {
          btnVerificarEmail.style.display = 'none';
        }
        // Limpar valida√ß√£o se estiver vazio
        const field = document.getElementById('cadEmail');
        const existingMsg = field.parentNode.querySelector('.validation-message');
        if (existingMsg) {
          existingMsg.remove();
        }
        field.style.borderColor = '';
      }
    }

    function validatePassword(password) {
      const requirements = {
        'req-length': password.length >= 8,
        'req-upper': /[A-Z]/.test(password),
        'req-lower': /[a-z]/.test(password),
        'req-number': /\d/.test(password),
        'req-special': /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\?]/.test(password)
      };
      
      Object.keys(requirements).forEach(reqId => {
        const element = document.getElementById(reqId);
        if (element) {
          const icon = element.querySelector('.requirement-icon');
          if (requirements[reqId]) {
            icon.textContent = '‚úì';
            icon.style.color = '#03f13b';

            element.style.color = '#03f13b';
            element.style.backgroundColor = 'rgba(57, 231, 66, 0.1)'; // Fundo sutil ajustado
            element.style.padding = '2px 4px';
            element.style.borderRadius = '4px';
            element.style.border = '1px solid rgba(255, 255, 255, 0.3)'; // Borda branca minimalista
          } else {
            icon.textContent = '‚óã';
            icon.style.color = '#ff1f35'; // Vermelho ainda mais escuro

            element.style.color = '#ff1f35'; // Vermelho ainda mais escuro
            element.style.backgroundColor = 'rgba(200, 35, 51, 0.1)'; // Fundo sutil ajustado
            element.style.padding = '2px 4px';
            element.style.borderRadius = '4px';
            element.style.border = '1px solid rgba(255, 255, 255, 0.3)'; // Borda branca minimalista
          }
        }
      });
      
      validatePasswordMatch();
    }

    function validatePasswordMatch() {
      const senha = document.getElementById('cadSenha').value;
      const confirmSenha = document.getElementById('cadSenha2').value;
      const indicator = document.getElementById('password-match-indicator');
      
      if (confirmSenha) {
        if (senha === confirmSenha) {
          indicator.textContent = '‚úì Senhas coincidem';
          indicator.style.color = '#28a745';
        } else {
          indicator.textContent = '‚úó Senhas n√£o coincidem';
          indicator.style.color = '#ff4757'; // Vermelho mais vibrante e vis√≠vel
        }
      } else {
        indicator.textContent = '';
      }
    }

    function showFieldValidation(fieldId, isValid, message) {
      console.log('Mostrando valida√ß√£o para:', fieldId, isValid, message);
      const field = document.getElementById(fieldId);
      
      if (!field) {
        console.error('Campo n√£o encontrado:', fieldId);
        return;
      }
      
      // Procurar por mensagem existente no parent ou pr√≥ximo elemento
      let parentElement = field.parentNode;
      const existingMsg = parentElement.querySelector('.validation-message');
      
      if (existingMsg) {
        existingMsg.remove();
      }
      
      // Criar nova mensagem
      const msgElement = document.createElement('div');
      msgElement.className = 'validation-message';
      msgElement.style.fontSize = '0.8em';
      msgElement.style.marginTop = '4px';
      msgElement.style.color = isValid ? '#28a745' : '#ff4757';
      msgElement.textContent = message;
      
      // Adicionar ap√≥s o campo
      field.parentNode.appendChild(msgElement);
      
      // Alterar cor da borda
      field.style.borderColor = isValid ? '#28a745' : '#ff4757';
      
      console.log('Valida√ß√£o aplicada com sucesso');
    }

    async function handleCadastroSubmit() {
      try {
        // Desabilitar bot√£o de submit para evitar duplo clique
        const submitBtn = document.querySelector('.submit-btn, .btn-primary');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.style.opacity = '0.6';
          submitBtn.style.cursor = 'not-allowed';
        }
        
        // ETAPA 1: Iniciando valida√ß√£o
        showCadastroProgress('validating');
        
        // Pequena pausa para mostrar o loading
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Validar todos os campos obrigat√≥rios
        const nome = document.getElementById('cadNome').value.trim();
        const cpf = document.getElementById('cadCpf').value.replace(/\D/g, '');
        const email = document.getElementById('cadEmail').value.trim().toLowerCase();
        const cep = document.getElementById('cadCep').value.replace(/\D/g, '');
        const endereco = document.getElementById('cadEndereco').value.trim();
        const numero = document.getElementById('cadNumero').value.trim();
        const apartamento = document.getElementById('cadApartamento').value.trim();
        const bloco = document.getElementById('cadBloco').value.trim();
        const senha = document.getElementById('cadSenha').value;
        const confirmSenha = document.getElementById('cadSenha2').value;
        
        // Coleta todos os dados do formul√°rio
        const formData = {
          nome,
          cpf,
          cep,
          email,
          endereco,
          numero: numero,
          complemento: document.getElementById('cadComplemento').value.trim(),
          bairro: document.getElementById('cadBairro').value.trim(),
          cidade: document.getElementById('cadCidade').value.trim(),
          estado: document.getElementById('cadEstado').value,
          apartamento,
          bloco,
          empreendimento: document.getElementById('cadEmpreendimento').value.trim(),
          telefone: document.getElementById('cadTelefone').value,
          celular: document.getElementById('cadCelular').value,
          senha,
          senha2: confirmSenha
        };
        
        // Valida√ß√µes
        if (!nome || nome.length < 2) {
          throw new Error('Nome deve ter pelo menos 2 caracteres');
        }
        
        if (!cpf || (cpf.length !== 11 && cpf.length !== 14)) {
          throw new Error('CPF/CNPJ inv√°lido');
        }
        
        if (cpf.length === 11 && !isValidCPF(cpf)) {
          throw new Error('CPF inv√°lido');
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email || !emailRegex.test(email)) {
          throw new Error('Email inv√°lido');
        }
        
        // Verificar se email foi validado (temporariamente opcional para teste)
        if (!emailVerificado) {
          console.warn('‚ö†Ô∏è Email n√£o verificado - procedendo para teste');
          // Para desenvolvimento/teste - remover esta linha em produ√ß√£o
          emailVerificado = true;
          // throw new Error('Por favor, verifique seu email antes de continuar');
        }
        
        if (!cep || cep.length !== 8) {
          throw new Error('CEP inv√°lido');
        }
        
        if (!endereco) {
          throw new Error('Endere√ßo √© obrigat√≥rio');
        }
        
        if (!numero) {
          throw new Error('N√∫mero √© obrigat√≥rio');
        }
        
        if (!apartamento) {
          throw new Error('Apartamento √© obrigat√≥rio');
        }
        
        if (!bloco) {
          throw new Error('Bloco √© obrigat√≥rio');
        }
        
        if (!senha || senha.length < 8) {
          throw new Error('Senha deve ter pelo menos 8 caracteres');
        }
        
        if (senha !== confirmSenha) {
          throw new Error('Senhas n√£o coincidem');
        }
        
        // Coletar servi√ßo selecionado
        let servicoSelecionado = '';
        const servicoInput = document.getElementById('cadServico');
        console.log('üéØ Verificando campo de servi√ßo...');
        console.log('üéØ Campo cadServico encontrado:', !!servicoInput);
        
        if (servicoInput) {
          servicoSelecionado = servicoInput.value;
          console.log('üéØ Valor do servi√ßo selecionado:', servicoSelecionado);
        } else {
          console.error('‚ùå Campo cadServico n√£o encontrado no DOM!');
        }
        
        // Se nenhum servi√ßo foi selecionado, usar um valor padr√£o para teste
        if (!servicoSelecionado || servicoSelecionado.trim() === '') {
          console.warn('‚ö†Ô∏è Nenhum servi√ßo selecionado, usando valor padr√£o para teste.');
          servicoSelecionado = 'A definir'; // Valor padr√£o para permitir o cadastro
        }
        
        // Hash da senha no frontend (camada extra de seguran√ßa)
        const hashedPassword = btoa(senha + 'salt_' + cpf);
        
        console.log('üöÄ Enviando dados para API (2 tabelas com colunas espec√≠ficas):', {
          nome: nome,
          cpf: cpf.substring(0, 3) + '***',
          email,
          cep,
          endereco,
          apartamento,
          bloco,
          'tabela_clientes->servico': servicoSelecionado,
          'tabela_solicitacoes->novo_servico': servicoSelecionado
        });
        
        console.log('üìä Detalhes do servi√ßo:', {
          valor_completo: servicoSelecionado,
          tem_valor: !!servicoSelecionado,
          tamanho: servicoSelecionado ? servicoSelecionado.length : 0,
          tipo: typeof servicoSelecionado
        });
        
        // ETAPA 2: Processando dados
        showCadastroProgress('processing');
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // Preparar dados no formato esperado pela API (2 tabelas com colunas espec√≠ficas)
        const dadosParaEnvio = {
          tipo: 'novo_cliente',
          nome_cliente: nome,
          cpf: cpf,
          cep: cep,
          email: email,
          endereco: endereco,
          numero: numero,
          complemento: document.getElementById('cadComplemento').value.trim(),
          bairro: document.getElementById('cadBairro').value.trim(),
          cidade: document.getElementById('cadCidade').value.trim(),
          estado: document.getElementById('cadEstado').value,
          apartamento: apartamento,
          bloco: bloco,
          nome_empreendimento: document.getElementById('cadEmpreendimento').value.trim(),
          telefone: document.getElementById('cadTelefone').value,
          celular: document.getElementById('cadCelular').value,
          // Para tabela CLIENTES: coluna 'servico'
          servico: servicoSelecionado,
          // Para tabela SOLICITACOES: coluna 'novo_servico'
          novo_servico: servicoSelecionado,
          senha: hashedPassword,
          timestamp: Date.now(),
          fingerprint: generateFingerprint()
        };
        
        console.log('üì¶ Dados completos para envio:', JSON.stringify(dadosParaEnvio, null, 2));
        console.log('‚úÖ Confirma√ß√£o final dos servi√ßos:');
        console.log('   -> servico (para clientes):', dadosParaEnvio.servico);
        console.log('   -> novo_servico (para solicitacoes):', dadosParaEnvio.novo_servico);
        
        // Enviar para API do banco Neon (mesmo endpoint que clientes.html - salva em 2 tabelas)
        console.log('üì° Fazendo requisi√ß√£o para:', 'https://chegar-primeiro.onrender.com/api/solicitacoes');
        
        // ETAPA 3: Salvando no banco
        showCadastroProgress('saving');
        
        const response = await fetch('https://chegar-primeiro.onrender.com/api/solicitacoes', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-CSRF-Token': localStorage.getItem('csrfToken')
          },
          body: JSON.stringify(dadosParaEnvio)
        });
        
        console.log('üìä Status da resposta:', response.status);
        console.log('üìã Headers da resposta:', response.headers);
        console.log('‚úÖ Response OK:', response.ok);
        
        const data = await response.json();
        console.log('üì¶ Dados da resposta completa:', data);
        
        if (response.ok && data.success) {
          console.log('‚úÖ Cadastro realizado com sucesso nas 2 tabelas (solicitacoes + clientes)!');
          
          // ETAPA 4: Finalizando
          showCadastroProgress('complete');
          await new Promise(resolve => setTimeout(resolve, 800));
          
          // SISTEMA DE PROTOCOLO - IGUAL DASHBOARD
          const protocolo = data.protocolo || gerarProtocolo();
          console.log('üìã Protocolo gerado:', protocolo);
          
          // Mostrar modal de sucesso com protocolo
          toggleLoading(false); // Esconder loading antes do modal
          mostrarModalProtocolo(protocolo, nome, servicoSelecionado);
          
          // Limpar formul√°rio apenas se cadastrou com sucesso
          document.getElementById('formCadastro').reset();
          emailVerificado = false;
          const iconeEmail = document.getElementById('iconeEmailVerificado');
          if (iconeEmail) iconeEmail.style.display = 'none';
          
          // Reset das valida√ß√µes
          document.querySelectorAll('.validation-message').forEach(msg => msg.remove());
          document.querySelectorAll('input, select').forEach(field => {
            field.style.borderColor = '';
          });
          
        } else if (response.ok && !data.success && data.motivo === 'ja_existe') {
          // Cliente j√° existe - tratar especificamente
          console.log('‚ö†Ô∏è Cliente j√° existe no sistema');
          throw new Error('üîÑ CPF ou Email j√° cadastrado. Fa√ßa login ou use dados diferentes.');
        } else {
          // Outros erros espec√≠ficos do banco Neon
          const errorMsg = data.error || 'Erro ao salvar no banco de dados Neon';
          console.error('‚ùå Erro do banco Neon:', errorMsg);
          
          if (response.status === 500) {
            throw new Error('üî• Erro interno do servidor. Tente novamente em alguns instantes.');
          } else if (response.status === 409) {
            throw new Error('‚ö†Ô∏è CPF ou Email j√° cadastrado no sistema.');
          } else if (response.status === 400) {
            throw new Error('üìù Dados inv√°lidos. Verifique os campos obrigat√≥rios.');
          } else {
            throw new Error('üíæ Erro ao salvar no banco Neon: ' + errorMsg);
          }
        }
        
      } catch (error) {
        console.error('‚ùå Erro no cadastro:', error);
        
        // Tratar diferentes tipos de erro com mais especificidade
        let errorMessage = error.message;
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorMessage = 'üåê Erro de conex√£o com o servidor. Verifique sua internet e tente novamente.';
        } else if (error.message.includes('NetworkError')) {
          errorMessage = 'üì° Erro de rede. Verifique sua conex√£o e tente novamente.';
        } else if (error.message.includes('timeout')) {
          errorMessage = '‚è±Ô∏è Tempo limite excedido. O servidor pode estar sobrecarregado.';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = 'üîå N√£o foi poss√≠vel conectar ao banco Neon. Tente novamente em alguns instantes.';
        } else if (error.message.includes('Internal Server Error')) {
          errorMessage = '‚ö†Ô∏è Erro interno do servidor Neon. Tente novamente em alguns minutos.';
        }
        
        // Sempre mostrar o erro espec√≠fico
        mostrarNotificacao(errorMessage, 'error', 8000);
        
        // Log detalhado para debug
        console.error('Detalhes do erro:', {
          name: error.name,
          message: error.message,
          stack: error.stack,
          timestamp: new Date().toISOString()
        });
      } finally {
        toggleLoading(false);
        
        // Reabilitar bot√£o de submit
        const submitBtn = document.querySelector('.submit-btn, .btn-primary');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.style.opacity = '1';
          submitBtn.style.cursor = 'pointer';
        }
      }
    }

    function showNotification(message, type = 'info', duration = 5000) {
      const notification = document.getElementById('notification');
      if (!notification) return;
      
      notification.className = `notification show ${type}`;
      notification.textContent = message;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }

    // Alias para compatibilidade
    function mostrarNotificacao(mensagem, tipo = 'info', duracao = 5000) {
      showNotification(mensagem, tipo, duracao);
    }

    function toggleLoading(show = true, message = '', subtext = '', progress = 0) {
      const overlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      const loadingSubtext = document.getElementById('loadingSubtext');
      const loadingProgress = document.getElementById('loadingProgress');
      
      if (overlay) {
        if (show) {
          // Atualizar textos se fornecidos
          if (message && loadingText) {
            loadingText.textContent = message;
          }
          if (subtext && loadingSubtext) {
            loadingSubtext.textContent = subtext;
          }
          
          // Atualizar progresso se fornecido
          if (progress > 0 && loadingProgress) {
            loadingProgress.style.width = `${Math.min(progress, 100)}%`;
          }
          
          // Mostrar overlay
          overlay.style.display = 'flex';
          overlay.style.opacity = '0';
          
          // Anima√ß√£o de entrada
          setTimeout(() => {
            overlay.style.transition = 'opacity 0.3s ease';
            overlay.style.opacity = '1';
          }, 10);
          
        } else {
          // Anima√ß√£o de sa√≠da
          overlay.style.transition = 'opacity 0.3s ease';
          overlay.style.opacity = '0';
          
          setTimeout(() => {
            overlay.style.display = 'none';
            // Reset dos valores
            if (loadingProgress) {
              loadingProgress.style.width = '0%';
            }
          }, 300);
        }
      }
    }

    // Fun√ß√£o espec√≠fica para mostrar etapas do cadastro
    function showCadastroProgress(step) {
      const steps = {
        'validating': {
          message: 'Validando Dados...',
          subtext: 'Verificando informa√ß√µes fornecidas',
          progress: 20
        },
        'processing': {
          message: 'Processando Cadastro...',
          subtext: 'Salvando dados no sistema',
          progress: 50
        },
        'saving': {
          message: 'Finalizando Cadastro...',
          subtext: 'Criando sua conta no sistema',
          progress: 80
        },
        'complete': {
          message: 'Cadastro Realizado!',
          subtext: 'Redirecionando para confirma√ß√£o',
          progress: 100
        }
      };
      
      const stepData = steps[step];
      if (stepData) {
        toggleLoading(true, stepData.message, stepData.subtext, stepData.progress);
      }
    }

    // === SISTEMA DE PROTOCOLO (IGUAL DASHBOARD) ===
    
    function gerarProtocolo() {
      const now = new Date();
      const year = now.getFullYear().toString();
      const month = (now.getMonth() + 1).toString().padStart(2, '0');
      const day = now.getDate().toString().padStart(2, '0');
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const seconds = now.getSeconds().toString().padStart(2, '0');
      
      // Gerar n√∫mero aleat√≥rio de 4 d√≠gitos
      const random = Math.floor(Math.random() * 9000) + 1000;
      
      // Formato: CLARO-YYYYMMDD-HHMMSS-XXXX
      return `CLARO-${year}${month}${day}-${hours}${minutes}${seconds}-${random}`;
    }

    function mostrarModalProtocolo(protocolo, nomeCliente, servico) {
      console.log('üìã Mostrando modal de protocolo:', protocolo);
      
      // Verificar se j√° existe modal
      let modal = document.getElementById('modalProtocolo');
      if (!modal) {
        // Criar modal
        modal = document.createElement('div');
        modal.id = 'modalProtocolo';
        modal.innerHTML = `
          <div class="modal-backdrop">
            <div class="modal-content">
              <!-- Bot√£o fechar -->
              <span class="close-modal" onclick="fecharModalProtocolo()">&times;</span>
              
              <!-- Header vermelho -->
              <div class="modal-header">
                <h2>Protocolo Gerado com Sucesso!</h2>
              </div>
              
              <!-- Conte√∫do principal -->
              <div class="modal-body">
                <div class="protocol-section">
                  <p class="protocol-label">N√öMERO DO PROTOCOLO:</p>
                  <div class="protocol-number-box">
                    <span class="protocol-number">${protocolo}</span>
                  </div>
                  <button onclick="copiarProtocolo('${protocolo}')" class="btn-copy">
                    Copiar Protocolo
                  </button>
                </div>
                
                <!-- Se√ß√£o verde -->
                <div class="success-section">
                  <p><strong>Sua solicita√ß√£o registrada com sucesso!</strong></p>
                  <p>Em at√© 24 horas nossa equipe comercial entrar√° em contato para confirmar os detalhes e agendar a instala√ß√£o.</p>
                </div>
                
                <!-- Se√ß√£o amarela - Pr√≥ximos passos -->
                <div class="next-steps-section">
                  <h3>Pr√≥ximos Passos:</h3>
                  <ul>
                    <li>Guarde este protocolo para consultas futuras</li>
                    <li>Mantenha seu telefone pr√≥ximo nas pr√≥ximas 24 horas</li>
                    <li>Acompanhe o status na aba "Acompanhar Solicita√ß√£o"</li>
                    <li>Nossa equipe entrar√° em contato em breve</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }
      
      // Exibir modal
      modal.style.display = 'flex';
      
      // Fechar modal com ESC
      const handleEscape = (e) => {
        if (e.key === 'Escape') {
          fecharModalProtocolo();
          document.removeEventListener('keydown', handleEscape);
        }
      };
      document.addEventListener('keydown', handleEscape);
    }

    function copiarProtocolo(protocolo) {
      navigator.clipboard.writeText(protocolo).then(() => {
        mostrarNotificacao('üìã Protocolo copiado para a √°rea de transfer√™ncia!', 'success');
        
        // Feedback visual no bot√£o
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚úÖ Copiado!';
        btn.style.background = 'rgba(34, 197, 94, 0.3)';
        
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.style.background = 'rgba(255, 255, 255, 0.2)';
        }, 2000);
      }).catch(() => {
        mostrarNotificacao('Erro ao copiar protocolo', 'error');
      });
    }

    function fecharModalProtocolo() {
      const modal = document.getElementById('modalProtocolo');
      if (modal) {
        modal.style.display = 'none';
        
        // Redirecionar para login ap√≥s fechar modal
        mostrarNotificacao('üöÄ Redirecionando para login...', 'info');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1000);
      }
    }

    // === FIM SISTEMA DE PROTOCOLO ===

    // Sistema de verifica√ß√£o de email com envio real
    let emailVerificado = false;
    let emailVerificationTimer = null;
    let isEmailVerificationInProgress = false; // Adicionar prote√ß√£o contra envios duplos
    
    function iniciarVerificacaoEmail() {
      console.log('Iniciando verifica√ß√£o de email');
      
      // Verificar se j√° est√° em andamento
      if (isEmailVerificationInProgress) {
        console.warn('Verifica√ß√£o de email j√° est√° em andamento');
        mostrarNotificacao('Aguarde, verifica√ß√£o em andamento...', 'info');
        return;
      }
      
      const email = document.getElementById('cadEmail').value.trim().toLowerCase();
      const btnVerificarEmail = document.getElementById('btnVerificarEmail');
      const areaCodigoEmail = document.getElementById('areaCodigoEmail');
      const statusCodigoEmail = document.getElementById('statusCodigoEmail');
      const inputCodigoEmail = document.getElementById('inputCodigoEmail');
      
      console.log('Email:', email);
      console.log('Bot√£o encontrado:', !!btnVerificarEmail);
      console.log('√Årea c√≥digo encontrada:', !!areaCodigoEmail);
      
      if (!email) {
        mostrarNotificacao('Digite um email v√°lido primeiro', 'error');
        return;
      }
      
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        mostrarNotificacao('Digite um email v√°lido', 'error');
        return;
      }
      
      // Verificar se √© um dom√≠nio confi√°vel
      if (!isEmailDomainTrusted(email)) {
        if (!confirm('Este dom√≠nio de email n√£o √© muito comum. Tem certeza que o email est√° correto?')) {
          return;
        }
      }
      
      if (btnVerificarEmail) {
        btnVerificarEmail.disabled = true;
        btnVerificarEmail.textContent = 'Enviando...';
      }
      
      // Marcar como em andamento
      isEmailVerificationInProgress = true;
      
      // Enviar c√≥digo real via API
      fetch('https://chegar-primeiro.onrender.com/api/enviar-codigo-email', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'X-CSRF-Token': localStorage.getItem('csrfToken')
        },
        body: JSON.stringify({ 
          email,
          timestamp: Date.now(),
          fingerprint: generateFingerprint()
        })
      })
      .then(res => res.json())
      .then(data => {
        // Finalizar processo de verifica√ß√£o
        isEmailVerificationInProgress = false;
        
        if (btnVerificarEmail) {
          btnVerificarEmail.disabled = false;
          btnVerificarEmail.textContent = 'Verificar e-mail';
        }
        
        if (data.success) {
          if (areaCodigoEmail) {
            areaCodigoEmail.style.display = 'block';
          }
          if (statusCodigoEmail) {
            statusCodigoEmail.textContent = 'C√≥digo enviado! Confira seu e-mail (inclusive spam).';
            statusCodigoEmail.style.color = '#28a745';
          }
          if (btnVerificarEmail) {
            btnVerificarEmail.style.display = 'none';
          }
          
          emailVerificado = false;
          document.getElementById('iconeEmailVerificado').style.display = 'none';
          
          // Timer de expira√ß√£o do c√≥digo (5 minutos)
          startEmailVerificationTimer();
          
          // Focar no campo de c√≥digo
          if (inputCodigoEmail) {
            inputCodigoEmail.focus();
          }
          
          mostrarNotificacao('C√≥digo enviado para ' + email, 'success');
        } else {
          mostrarNotificacao(data.error || 'Erro ao enviar c√≥digo.', 'error');
        }
      })
      .catch(error => {
        console.error('Erro ao enviar c√≥digo:', error);
        
        // Finalizar processo de verifica√ß√£o mesmo em caso de erro
        isEmailVerificationInProgress = false;
        
        if (btnVerificarEmail) {
          btnVerificarEmail.disabled = false;
          btnVerificarEmail.textContent = 'Verificar e-mail';
        }
        mostrarNotificacao('Erro ao enviar c√≥digo.', 'error');
      });
    }

    function validarCodigoEmail() {
      console.log('Validando c√≥digo de email');
      const email = document.getElementById('cadEmail').value.trim().toLowerCase();
      const codigoDigitado = document.getElementById('inputCodigoEmail').value.trim();
      const statusElement = document.getElementById('statusCodigoEmail');
      const iconeEmailVerificado = document.getElementById('iconeEmailVerificado');
      const areaCodigoEmail = document.getElementById('areaCodigoEmail');
      const btnValidarCodigoEmail = document.getElementById('btnValidarCodigoEmail');
      
      console.log('C√≥digo digitado:', codigoDigitado);
      console.log('Email:', email);
      
      if (!codigoDigitado || codigoDigitado.length !== 6) {
        mostrarNotificacao('Digite o c√≥digo de 6 d√≠gitos.', 'error');
        if (document.getElementById('inputCodigoEmail')) {
          document.getElementById('inputCodigoEmail').focus();
        }
        return;
      }
      
      if (btnValidarCodigoEmail) {
        btnValidarCodigoEmail.disabled = true;
        btnValidarCodigoEmail.textContent = 'Validando...';
      }
      
      // Validar c√≥digo real via API
      fetch('https://chegar-primeiro.onrender.com/api/validar-codigo-email', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'X-CSRF-Token': localStorage.getItem('csrfToken')
        },
        body: JSON.stringify({ 
          email, 
          codigo: codigoDigitado,
          timestamp: Date.now()
        })
      })
      .then(res => res.json())
      .then(data => {
        if (btnValidarCodigoEmail) {
          btnValidarCodigoEmail.disabled = false;
          btnValidarCodigoEmail.textContent = 'Validar c√≥digo';
        }
        
        if (data.success) {
          console.log('C√≥digo validado com sucesso!');
          if (statusElement) {
            statusElement.textContent = 'E-mail verificado com sucesso!';
            statusElement.style.color = '#28a745';
          }
          if (iconeEmailVerificado) {
            iconeEmailVerificado.style.display = 'inline';
          }
          if (areaCodigoEmail) {
            areaCodigoEmail.style.display = 'none';
          }
          emailVerificado = true;
          clearEmailVerificationTimer();
          mostrarNotificacao('Email verificado com sucesso!', 'success');
        } else {
          console.log('C√≥digo incorreto!');
          if (statusElement) {
            statusElement.textContent = data.error || 'C√≥digo inv√°lido.';
            statusElement.style.color = '#ff4757';
          }
          document.getElementById('inputCodigoEmail').value = '';
          document.getElementById('inputCodigoEmail').focus();
          mostrarNotificacao('C√≥digo incorreto', 'error');
        }
      })
      .catch(error => {
        console.error('Erro ao validar c√≥digo:', error);
        if (btnValidarCodigoEmail) {
          btnValidarCodigoEmail.disabled = false;
          btnValidarCodigoEmail.textContent = 'Validar c√≥digo';
        }
        mostrarNotificacao('Erro ao validar c√≥digo.', 'error');
      });
    }

    // Fun√ß√£o para alternar visibilidade da senha
    function togglePasswordVisibility(fieldId) {
      const field = document.getElementById(fieldId);
      const button = field.nextElementSibling;
      
      if (field.type === 'password') {
        field.type = 'text';
        button.textContent = 'üôà';
      } else {
        field.type = 'password';
        button.textContent = 'üëÅ';
      }
    }

    // Fun√ß√£o para abrir modal de servi√ßos - CADASTRO (NOME √öNICO)
    window.cadastroAbrirModalServicos = async function(contexto) {
      try {
        console.log('[DEBUG] === IN√çCIO cadastroAbrirModalServicos ===');
        console.log('[DEBUG] Contexto recebido:', contexto);
        console.log('[DEBUG] ofertasDisponiveis exists?', typeof ofertasDisponiveis);
        console.log('[DEBUG] ofertasDisponiveis.length:', ofertasDisponiveis ? ofertasDisponiveis.length : 'undefined');
        console.log('[DEBUG] ofertasLoaderReady exists?', typeof ofertasLoaderReady);
        console.log('[DEBUG] ofertasLoaderReady:', ofertasLoaderReady);
        
        window.modalServicoContexto = contexto;
        const modal = document.getElementById('modalServicos');
        
        if (!modal) {
          console.error('[ERROR] Modal n√£o encontrado!');
          return;
        }
        
        console.log('[DEBUG] Modal encontrado, exibindo...');
        modal.style.display = 'flex';
        console.log('[DEBUG] Modal display definido para flex');
        
        // Se j√° temos ofertas carregadas, renderizar imediatamente (igual dashboard)
        if (ofertasDisponiveis && ofertasDisponiveis.length > 0) {
          console.log('[DEBUG] Ofertas j√° dispon√≠veis, renderizando imediatamente...');
          console.log('[DEBUG] Ofertas:', ofertasDisponiveis);
          
          if (typeof window.renderizarServicos === 'function') {
            // Usar a fun√ß√£o global que j√° formata igual ao dashboard
            window.renderizarServicos(ofertasDisponiveis);
          } else {
            console.error('[ERROR] renderizarServicos n√£o √© uma fun√ß√£o!');
          }
          console.log('[DEBUG] === FIM cadastroAbrirModalServicos (ofertas existentes) ===');
        } else {
          console.log('[DEBUG] Nenhuma oferta dispon√≠vel, iniciando carregamento...');
          // Mostrar loading e solicitar carregamento (igual dashboard)
          
          if (typeof window.cadastroMostrarLoadingOfertas === 'function') {
            window.cadastroMostrarLoadingOfertas();
            console.log('[DEBUG] Loading mostrado');
          } else {
            console.error('[ERROR] cadastroMostrarLoadingOfertas n√£o √© uma fun√ß√£o!');
          }
          
          if (ofertasLoaderReady) {
            console.log('[DEBUG] Iframe pronto, enviando mensagem...');
            // Solicitar carregamento ao iframe
            try {
              const iframe = document.getElementById('ofertasLoader');
              console.log('[DEBUG] Iframe encontrado:', !!iframe);
              
              if (iframe && iframe.contentWindow) {
                console.log('[DEBUG] Iframe contentWindow v√°lido');
                iframe.contentWindow.postMessage({
                  type: 'load-ofertas'
                }, '*');
                console.log('[DEBUG] Mensagem postMessage enviada com sucesso');
              } else {
                console.error('[ERROR] Iframe ou contentWindow inv√°lido');
                if (typeof window.cadastroRenderizarOfertasPadrao === 'function') {
                  window.cadastroRenderizarOfertasPadrao();
                }
              }
            } catch (error) {
              console.error('[ERROR] Erro ao enviar mensagem para iframe:', error);
              console.log('[DEBUG] Usando fallback devido ao erro');
              if (typeof window.cadastroRenderizarOfertasPadrao === 'function') {
                window.cadastroRenderizarOfertasPadrao();
              }
              return;
            }
          } else {
            console.log('[DEBUG] Iframe n√£o est√° pronto, usando timeout fallback');
            // Fallback se iframe n√£o estiver pronto (igual dashboard)
            setTimeout(() => {
              console.log('[DEBUG] Timeout executado, verificando ofertas...');
              if (!ofertasDisponiveis || ofertasDisponiveis.length === 0) {
                console.log('[DEBUG] Ainda sem ofertas ap√≥s timeout, usando padr√£o');
                if (typeof window.cadastroRenderizarOfertasPadrao === 'function') {
                  window.cadastroRenderizarOfertasPadrao();
                }
              } else {
                console.log('[DEBUG] Ofertas carregadas durante timeout');
              }
            }, 2000);
          }
          console.log('[DEBUG] === FIM cadastroAbrirModalServicos (carregamento iniciado) ===');
        }
      } catch (error) {
        console.error('[FATAL] Erro cr√≠tico em cadastroAbrirModalServicos:', error);
        console.error('[FATAL] Stack:', error.stack);
      }
    };
    
    // VERIFICA√á√ÉO IMEDIATA DA FUN√á√ÉO - CADASTRO
    console.log('[INIT] cadastroAbrirModalServicos registrada?', typeof window.cadastroAbrirModalServicos);
    
    // Fun√ß√µes auxiliares espec√≠ficas do CADASTRO (NOMES √öNICOS)
    
    // Fun√ß√£o para fechar modal de servi√ßos - CADASTRO
    window.cadastroFecharModalServicos = function() {
      console.log('[DEBUG] Fechando modal de servi√ßos');
      const modal = document.getElementById('modalServicos');
      if (modal) {
        modal.style.display = 'none';
      }
    };

    // Fun√ß√£o para mostrar loading de ofertas - CADASTRO
    window.cadastroMostrarLoadingOfertas = function() {
      console.log('[DEBUG] Mostrando loading de ofertas');
      const servicosGrid = document.getElementById('servicosGrid');
      if (servicosGrid) {
        servicosGrid.innerHTML = `
          <div class="loading-servicos" style="display: flex; justify-content: center; align-items: center; height: 200px; color: #fff;">
            <div class="spinner" style="border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-right: 15px;"></div>
            <span>Carregando planos...</span>
          </div>
        `;
      }
    };

    // Fun√ß√£o para renderizar servi√ßos - CADASTRO
    window.cadastroRenderizarServicos = function(ofertas) {
      console.log('[DEBUG] === IN√çCIO cadastroRenderizarServicos ===');
      console.log('[DEBUG] Ofertas recebidas:', ofertas.length);
      
      const servicosGrid = document.getElementById('servicosGrid');
      if (!servicosGrid) {
        console.error('[ERROR] servicosGrid n√£o encontrado!');
        return;
      }
      
      if (!ofertas || ofertas.length === 0) {
        console.log('[WARNING] Nenhuma oferta para renderizar, usando padr√£o');
        window.cadastroRenderizarOfertasPadrao();
        return;
      }
      
      let html = '';
      ofertas.forEach((oferta, index) => {
        const preco = window.cadastroFormatarPreco(oferta.preco);
        const beneficios = oferta.beneficios || 'Internet de alta velocidade';
        
        html += `
          <div class="servico-card" onclick="window.cadastroSelecionarServico('${oferta.nome}', '${window.modalServicoContexto || 'cadastro'}')">
            <div class="servico-titulo">${oferta.nome}</div>
            <div class="servico-mega">${oferta.velocidade || '100MB'}</div>
            <div class="servico-benef">${beneficios}</div>
            <div class="servico-preco">${preco}</div>
            <button class="servico-btn" type="button">Selecionar Plano</button>
          </div>
        `;
      });
      
      servicosGrid.innerHTML = html;
      console.log('[SUCCESS] Ofertas renderizadas com sucesso');
      console.log('[DEBUG] === FIM cadastroRenderizarServicos ===');
    };

    // Fun√ß√£o para renderizar ofertas padr√£o - CADASTRO
    window.cadastroRenderizarOfertasPadrao = function() {
      console.log('[DEBUG] Renderizando ofertas padr√£o do cadastro');
      const servicosGrid = document.getElementById('servicosGrid');
      if (!servicosGrid) return;
      
      const ofertasPadrao = [
        {
          nome: 'Claro Fibra 100MB',
          velocidade: '100MB',
          preco: 'R$ 79,90',
          beneficios: 'Internet de alta velocidade + WiFi gr√°tis'
        },
        {
          nome: 'Claro Fibra 200MB',
          velocidade: '200MB', 
          preco: 'R$ 99,90',
          beneficios: 'Internet ultra r√°pida + WiFi gr√°tis'
        },
        {
          nome: 'Claro Fibra 500MB',
          velocidade: '500MB',
          preco: 'R$ 149,90',
          beneficios: 'Internet super r√°pida + WiFi gr√°tis'
        }
      ];
      
      window.cadastroRenderizarServicos(ofertasPadrao);
    };

    // Fun√ß√£o para selecionar servi√ßo - CADASTRO
    window.cadastroSelecionarServico = function(nomeServico, contexto) {
      console.log('[DEBUG] ===== IN√çCIO SELE√á√ÉO SERVI√áO =====');
      console.log('[DEBUG] Servi√ßo selecionado:', nomeServico);
      console.log('[DEBUG] Contexto:', contexto);
      
      try {
        // Atualizar campo oculto
        const servicoInput = document.getElementById('cadServico');
        console.log('[DEBUG] Campo cadServico encontrado:', !!servicoInput);
        
        if (servicoInput) {
          const valorAnterior = servicoInput.value;
          servicoInput.value = nomeServico;
          console.log('[SUCCESS] Campo cadServico atualizado:');
          console.log('   - Valor anterior:', valorAnterior);
          console.log('   - Novo valor:', servicoInput.value);
          console.log('   - Verifica√ß√£o de valor:', servicoInput.value === nomeServico);
        } else {
          console.error('[ERROR] Campo cadServico N√ÉO encontrado no DOM!');
        }
        
        // Atualizar bot√£o visual
        const btnSelecionarServico = document.getElementById('btnSelecionarServico');
        console.log('[DEBUG] Bot√£o btnSelecionarServico encontrado:', !!btnSelecionarServico);
        
        if (btnSelecionarServico) {
          btnSelecionarServico.innerHTML = `
            <span class="btn-icon">‚úì</span>
            ${nomeServico}
          `;
          btnSelecionarServico.style.background = 'linear-gradient(135deg, #e8f5e8, #f0f9ff)';
          btnSelecionarServico.style.border = '2px solid #28a745';
          btnSelecionarServico.style.color = '#155724';
          btnSelecionarServico.style.fontWeight = '600';
          console.log('[SUCCESS] Bot√£o visual atualizado');
        } else {
          console.warn('[WARNING] Bot√£o btnSelecionarServico n√£o encontrado');
        }
        
        // Fechar modal
        console.log('[DEBUG] Fechando modal...');
        window.cadastroFecharModalServicos();
        
        // Notifica√ß√£o de sucesso
        mostrarNotificacao(`Plano "${nomeServico}" selecionado!`, 'success');
        
        console.log('[DEBUG] ===== FIM SELE√á√ÉO SERVI√áO =====');
        
      } catch (error) {
        console.error('[ERROR] Erro ao selecionar servi√ßo:', error);
        console.error('[ERROR] Stack:', error.stack);
      }
    };

    // Fun√ß√£o auxiliar para formatar pre√ßo - CADASTRO
    window.cadastroFormatarPreco = function(preco) {
      if (typeof preco === 'string') return preco;
      if (typeof preco === 'number') return `R$ ${preco.toFixed(2).replace('.', ',')}`;
      return 'Consulte o pre√ßo';
    };

    // Fun√ß√£o para mostrar erro sem ofertas - CADASTRO
    window.cadastroMostrarErroSemOfertas = function() {
      const servicosGrid = document.getElementById('servicosGrid');
      if (servicosGrid) {
        servicosGrid.innerHTML = `
          <div style="text-align: center; color: #fff; padding: 40px;">
            <h4>Erro ao carregar ofertas</h4>
            <p>N√£o foi poss√≠vel carregar as ofertas dispon√≠veis.</p>
            <button onclick="window.cadastroRenderizarOfertasPadrao()" style="background: #d31a20; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
              Ver ofertas padr√£o
            </button>
          </div>
        `;
      }
    };

    // Fun√ß√£o para resetar circuit breaker manualmente (IGUAL DASHBOARD)
    window.resetarCircuitBreaker = function() {
      console.log('[INFO] Reiniciando carregador de ofertas');
      ofertasDisponiveis = [];
      
      // Mostrar loading enquanto recarrega
      window.mostrarLoadingOfertas();
      
      if (ofertasLoaderReady) {
        console.log('[INFO] Enviando comando de reload para iframe');
        document.getElementById('ofertasLoader').contentWindow.postMessage({
          type: 'load-ofertas'
        }, '*');
      } else {
        console.log('[WARNING] Iframe n√£o est√° pronto, recarregando iframe');
        // Recarregar o iframe se necess√°rio
        const iframe = document.getElementById('ofertasLoader');
        iframe.src = iframe.src;
      }
    };

    // Fun√ß√£o para mostrar erro quando n√£o h√° ofertas no banco (GLOBAL)
    window.mostrarErroSemOfertas = function() {
      const servicosGrid = document.getElementById('servicosGrid');
      servicosGrid.innerHTML = `
        <div style="color: #fff; text-align: center; grid-column: 1 / -1; padding: 40px;">
          <div style="background: rgba(255, 193, 7, 0.2); border: 2px solid #ffc107; border-radius: 12px; padding: 30px; max-width: 500px; margin: 0 auto;">
            <h4 style="color: #ffc107; margin-bottom: 15px; font-size: 24px;">‚ö†Ô∏è Nenhum plano dispon√≠vel</h4>
            <p style="margin-bottom: 20px; line-height: 1.6;">
              O banco de dados n√£o possui ofertas ativas no momento.<br>
              Entre em contato com o administrador do sistema.
            </p>
            <button onclick="window.resetarCircuitBreaker()" class="btn" style="background: #ffc107; color: #000; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer;">
              üîÑ Tentar Novamente
            </button>
          </div>
        </div>
      `;
    };

    // Fun√ß√£o para mostrar erro de timeout
    function mostrarErroTimeout() {
      const servicosGrid = document.getElementById('servicosGrid');
      servicosGrid.innerHTML = `
        <div style="color: #fff; text-align: center; grid-column: 1 / -1; padding: 40px;">
          <div style="background: rgba(220, 53, 69, 0.2); border: 2px solid #dc3545; border-radius: 12px; padding: 30px; max-width: 500px; margin: 0 auto;">
            <h4 style="color: #dc3545; margin-bottom: 15px; font-size: 24px;">‚è±Ô∏è Tempo limite excedido</h4>
            <p style="margin-bottom: 20px; line-height: 1.6;">
              O servidor est√° demorando para responder.<br>
              Verifique sua conex√£o e tente novamente.
            </p>
            <button onclick="resetarCircuitBreaker()" class="btn" style="background: #dc3545; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer;">
              üîÑ Tentar Novamente
            </button>
          </div>
        </div>
      `;
    }

    // Fun√ß√£o para mostrar erro de conex√£o
    function mostrarErroConexao() {
      const servicosGrid = document.getElementById('servicosGrid');
      servicosGrid.innerHTML = `
        <div style="color: #fff; text-align: center; grid-column: 1 / -1; padding: 40px;">
          <div style="background: rgba(220, 53, 69, 0.2); border: 2px solid #dc3545; border-radius: 12px; padding: 30px; max-width: 500px; margin: 0 auto;">
            <h4 style="color: #dc3545; margin-bottom: 15px; font-size: 24px;">‚ùå Erro de conex√£o</h4>
            <p style="margin-bottom: 20px; line-height: 1.6;">
              N√£o foi poss√≠vel conectar ao banco de dados.<br>
              Usando ofertas padr√£o para melhor experi√™ncia.
            </p>
            <button onclick="window.renderizarOfertasPadrao()" class="btn" style="background: #28a745; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer;">
              ÔøΩ Ver Ofertas Padr√£o
            </button>
          </div>
        </div>
      `;
    }

    // Fun√ß√£o para renderizar ofertas vindas do sistema de carregamento (GLOBAL)
    window.renderizarServicos = function(ofertas) {
      console.log('[RENDER] renderizarServicos chamada com:', ofertas);
      console.log('[RENDER] N√∫mero de ofertas:', ofertas ? ofertas.length : 0);
      
      const servicosGrid = document.getElementById('servicosGrid');
      console.log('[RENDER] servicosGrid encontrado:', !!servicosGrid);
      
      if (!servicosGrid) {
        console.error('[RENDER] servicosGrid n√£o encontrado!');
        return;
      }
      
      if (!ofertas || ofertas.length === 0) {
        console.log('[RENDER] Nenhuma oferta para renderizar, mostrando erro');
        window.mostrarErroSemOfertas();
        return;
      }
      
      try {
        // Verificar se s√£o ofertas padr√£o e adicionar aviso
        const isOfertasPadrao = ofertas.length === 4 && ofertas[0].nome === 'Claro fibra 350 MEGA';
        console.log('[RENDER] √â ofertas padr√£o?', isOfertasPadrao);
        
        const avisoFallback = isOfertasPadrao ? `
          <div style="grid-column: 1 / -1; background: rgba(255, 193, 7, 0.2); border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px; color: #fff; text-align: center;">
            <small>‚ö†Ô∏è Exibindo ofertas padr√£o - Conectividade otimizada</small>
          </div>
        ` : '';
        
        console.log('[RENDER] Gerando HTML das ofertas...');
        const servicosHTML = ofertas.map((oferta, index) => {
          console.log(`[RENDER] Processando oferta ${index + 1}:`, oferta.nome);
          
          let precoFormatado, precoPromocional;
          try {
            precoFormatado = window.formatarPreco(oferta.preco);
            precoPromocional = oferta.preco_promocional ? window.formatarPreco(oferta.preco_promocional) : null;
          } catch (error) {
            console.error('[RENDER] Erro ao formatar pre√ßo:', error);
            precoFormatado = `R$ ${oferta.preco}`;
            precoPromocional = null;
          }
          
          // Escapar nome da oferta para uso seguro no HTML
          const nomeEscapado = oferta.nome.replace(/'/g, "\\'").replace(/"/g, '\\"');
          
          return `
            <div class="servico-card" data-oferta-nome="${nomeEscapado}" onclick="window.selecionarServico('${nomeEscapado}', 'cadastro')">
              <div class="servico-titulo">
                Claro<span style='color:#ff0000'> ${oferta.tipo}</span>
              </div>
              <div class="servico-mega">${oferta.velocidade || ''}</div>
              <div class="servico-benef">${oferta.beneficios || ''}</div>
              <div class="servico-preco">
                ${precoPromocional ? `
                  <span style="text-decoration: line-through; color: #999; font-size: 18px;">${precoFormatado}</span><br>
                  <span style="color: #28a745; font-size: 24px; font-weight: 700;">${precoPromocional}</span>
                ` : precoFormatado}
              </div>
              <button type="button" class="servico-btn">
                ${oferta.tipo === 'fibra' ? 'Assine' : 'Contrate'}
              </button>
            </div>
          `;
        }).join('');
        
        console.log('[RENDER] HTML gerado com sucesso, tamanho:', servicosHTML.length);
        console.log('[RENDER] Inserindo HTML no DOM...');
        
        servicosGrid.innerHTML = avisoFallback + servicosHTML;
        
        // Adicionar event delegation como backup
        servicosGrid.removeEventListener('click', handleServiceCardClick);
        servicosGrid.addEventListener('click', handleServiceCardClick);
        
        console.log(`[SUCCESS] ${ofertas.length} ofertas renderizadas com sucesso!`);
        
      } catch (error) {
        console.error('[RENDER] Erro cr√≠tico na renderiza√ß√£o:', error);
        console.error('[RENDER] Stack trace:', error.stack);
        
        // Fallback em caso de erro
        servicosGrid.innerHTML = `
          <div style="color: #fff; text-align: center; grid-column: 1 / -1; padding: 40px;">
            <div style="background: rgba(220, 53, 69, 0.2); border: 2px solid #dc3545; border-radius: 12px; padding: 30px;">
              <h4 style="color: #dc3545; margin-bottom: 15px;">‚ùå Erro na renderiza√ß√£o</h4>
              <p style="margin-bottom: 20px;">Ocorreu um erro ao exibir as ofertas.</p>
              <button onclick="window.renderizarOfertasPadrao()" class="btn" style="background: #28a745; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                üîÑ Usar Ofertas Padr√£o
              </button>
            </div>
          </div>
        `;
      }
    };

    // Handler para cliques nas ofertas (EVENT DELEGATION) - VERS√ÉO SIMPLIFICADA
    function handleServiceCardClick(event) {
      console.log('üéØ [EVENT] Clique detectado via event delegation');
      
      // Encontrar o card de servi√ßo mais pr√≥ximo
      const serviceCard = event.target.closest('.servico-card');
      if (serviceCard) {
        const nomeOferta = serviceCard.getAttribute('data-oferta-nome');
        console.log('üéØ [EVENT] Nome da oferta:', nomeOferta);
        
        if (nomeOferta) {
          console.log('üéØ [EVENT] Executando sele√ß√£o diretamente...');
          
          try {
            // Executar a sele√ß√£o diretamente aqui (sem chamar outra fun√ß√£o)
            console.log('üéØ [DIRECT] Selecionando:', nomeOferta);
            
            // Atualizar campo oculto
            const servicoInput = document.getElementById('cadServico');
            if (servicoInput) {
              servicoInput.value = nomeOferta;
              console.log('üéØ [DIRECT] Campo cadServico atualizado:', nomeOferta);
            }
            
            // Atualizar bot√£o visual
            const btnSelecionarServico = document.getElementById('btnSelecionarServico');
            if (btnSelecionarServico) {
              btnSelecionarServico.innerHTML = `
                <span class="btn-icon">‚úì</span>
                ${nomeOferta}
              `;
              btnSelecionarServico.style.background = 'linear-gradient(135deg, #e8f5e8, #f0f9ff)';
              btnSelecionarServico.style.border = '2px solid #28a745';
              btnSelecionarServico.style.color = '#155724';
              btnSelecionarServico.style.fontWeight = '600';
              console.log('üéØ [DIRECT] Bot√£o atualizado');
            }
            
            // Fechar modal
            const modal = document.getElementById('modalServicos');
            if (modal) {
              modal.style.display = 'none';
              console.log('üéØ [DIRECT] Modal fechado');
            }
            
            // Notifica√ß√£o de sucesso
            window.showNotification(`Plano "${nomeOferta}" selecionado!`, 'success');
            console.log('üéØ [DIRECT] Notifica√ß√£o exibida');
            
          } catch (error) {
            console.error('üéØ [DIRECT] ERRO:', error);
          }
        }
      }
    }

    // Fun√ß√£o para mostrar notifica√ß√µes (GLOBAL)
    window.showNotification = function(message, type = 'info', duration = 5000) {
      const notification = document.getElementById('notification');
      if (!notification) return;
      
      notification.className = `notification show ${type}`;
      notification.textContent = message;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    };

    // Fun√ß√£o auxiliar para formatar pre√ßo (GLOBAL)
    window.formatarPreco = function(preco) {
      return `R$ ${parseFloat(preco).toFixed(2).replace('.', ',')}/m√™s`;
    };

    // Fun√ß√£o para fechar modal de servi√ßos (GLOBAL)
    window.fecharModalServicos = function() {
      document.getElementById('modalServicos').style.display = 'none';
    };

    // Fun√ß√£o para selecionar servi√ßo (IGUAL DASHBOARD + CAMPO OCULTO)
    window.selecionarServico = function(nomeServico, contexto) {
      console.log('üéØ [CLICK] FUN√á√ÉO SELECIONARSERVICO CHAMADA!');
      console.log('üéØ [CLICK] nomeServico:', nomeServico);
      console.log('üéØ [CLICK] contexto:', contexto);
      console.log('[INFO] Selecionando servi√ßo:', nomeServico, 'contexto:', contexto);
      
      try {
        // Para o contexto de cadastro, atualizar o bot√£o e campo oculto
        if (contexto === 'cadastro') {
          // Atualizar campo oculto
          const servicoInput = document.getElementById('cadServico');
          if (servicoInput) {
            servicoInput.value = nomeServico;
            console.log('[SUCCESS] Campo cadServico atualizado:', nomeServico);
          }
          
          // Atualizar bot√£o visual
          const btnSelecionarServico = document.getElementById('btnSelecionarServico');
          if (btnSelecionarServico) {
            btnSelecionarServico.innerHTML = `
              <span class="btn-icon">‚úì</span>
              ${nomeServico}
            `;
            btnSelecionarServico.style.background = 'linear-gradient(135deg, #e8f5e8, #f0f9ff)';
            btnSelecionarServico.style.border = '2px solid #28a745';
            btnSelecionarServico.style.color = '#155724';
            btnSelecionarServico.style.fontWeight = '600';
          }
        } else {
          // Para outros contextos (dashboard), usar container padr√£o
          const container = document.getElementById(contexto + 'ServicoContainer');
          if (container) {
            container.innerHTML = `
              <div class="servico-selecionado" style="background: linear-gradient(135deg, #f0f2ff, #f8faff); border: 2px solid #4f46e5; border-radius: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <span class="servico-nome" style="font-weight: 600; color: #3730a3; display: block;">${nomeServico}</span>
                  <small style="color: #6c757d;">Servi√ßo selecionado</small>
                </div>
                <button type="button" onclick="window.abrirModalServicos('${contexto}')" class="btn-alterar-servico" style="background: linear-gradient(135deg, #4f46e5, #7c3aed); border: none; border-radius: 20px; padding: 8px 15px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; color: white;">
                  üîÑ Alterar
                </button>
              </div>
            `;
          }
        }
        
        // Fechar modal
        window.fecharModalServicos();
        
        // Notifica√ß√£o de sucesso
        window.showNotification(`Plano "${nomeServico}" selecionado!`, 'success');
        
      } catch (error) {
        console.error('[ERROR] Erro ao selecionar servi√ßo:', error);
      }
    };

    // Fun√ß√µes auxiliares para o sistema de email
    function startEmailVerificationTimer() {
      clearEmailVerificationTimer();
      let timeLeft = 300; // 5 minutos
      const statusCodigoEmail = document.getElementById('statusCodigoEmail');
      const areaCodigoEmail = document.getElementById('areaCodigoEmail');
      const btnVerificarEmail = document.getElementById('btnVerificarEmail');
      
      emailVerificationTimer = setInterval(() => {
        timeLeft--;
        
        if (timeLeft <= 0) {
          clearEmailVerificationTimer();
          if (statusCodigoEmail) {
            statusCodigoEmail.textContent = 'C√≥digo expirado. Solicite um novo c√≥digo.';
            statusCodigoEmail.style.color = '#dc3545';
          }
          if (areaCodigoEmail) {
            areaCodigoEmail.style.display = 'none';
          }
          if (btnVerificarEmail) {
            btnVerificarEmail.style.display = 'block';
          }
        } else if (timeLeft <= 60) {
          if (statusCodigoEmail) {
            statusCodigoEmail.textContent = `C√≥digo expira em ${timeLeft}s`;
            statusCodigoEmail.style.color = '#ffc107';
          }
        }
      }, 1000);
    }

    function clearEmailVerificationTimer() {
      if (emailVerificationTimer) {
        clearInterval(emailVerificationTimer);
        emailVerificationTimer = null;
      }
    }

    function isEmailDomainTrusted(email) {
      const domain = email.split('@')[1];
      const trustedDomains = [
        'gmail.com', 'outlook.com', 'hotmail.com', 'yahoo.com', 'icloud.com',
        'terra.com.br', 'uol.com.br', 'globo.com', 'bol.com.br', 'ig.com.br',
        'live.com', 'msn.com', 'yahoo.com.br'
      ];
      return trustedDomains.includes(domain);
    }

    function generateFingerprint() {
      // Gerar um fingerprint mais robusto do dispositivo para seguran√ßa
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('Fingerprint test', 2, 2);
      
      return btoa(JSON.stringify({
        screen: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        language: navigator.language,
        platform: navigator.platform,
        canvas: canvas.toDataURL(),
        userAgent: navigator.userAgent.substring(0, 100),
        timestamp: Date.now()
      }));
    }

    function verificarDominioEmail(email) {
      const domain = email.split('@')[1];
      const trustedDomains = [
        'gmail.com', 'outlook.com', 'hotmail.com', 'yahoo.com', 'icloud.com',
        'terra.com.br', 'uol.com.br', 'globo.com', 'bol.com.br', 'ig.com.br'
      ];
      
      const emailInput = document.getElementById('cadEmail');
      if (!emailInput) return;
      
      // Remover aviso anterior
      const existingWarning = emailInput.parentNode.querySelector('.domain-warning');
      if (existingWarning) existingWarning.remove();
      
      if (!trustedDomains.includes(domain)) {
        const warning = document.createElement('small');
        warning.style.cssText = 'color: #856404; font-size: 11px; display: block; margin-top: 2px;';
        warning.textContent = 'Dom√≠nio n√£o muito comum. Verifique se est√° correto.';
        warning.className = 'domain-warning';
        emailInput.parentNode.appendChild(warning);
      }
    }
  </script>
</body>
</html>
