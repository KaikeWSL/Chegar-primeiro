<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Cadastro - Chegar Primeiro Claro">
  <meta name="keywords" content="Claro, cadastro, registro, novo cliente">
  <meta name="author" content="Claro">
  <meta name="robots" content="noindex, nofollow">
  
  <!-- Seguran√ßa -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://chegar-primeiro.onrender.com https://viacep.com.br https://brasilapi.com.br; font-src 'self' data:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  
  <!-- PWA Support -->
  <meta name="theme-color" content="#d31a20">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <title>Cadastro - Chegar Primeiro</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="login-improvements.css">
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì±</text></svg>">
</head>
<body class="cadastro-ativo">
  <div class="container">
    <img src="https://upload.wikimedia.org/wikipedia/commons/9/9c/LogoClaro2017.png" class="logo" alt="Logo Claro">
    <h2 style="text-align:center; margin-bottom: 18px;">Chegar Primeiro</h2>
    
    <form id="formCadastro" style="display:flex; flex-direction:column;">
      <div class="form-header">
        <h2>üìù Cadastro de Novo Cliente</h2>
        <p class="form-subtitle">Preencha seus dados para criar sua conta</p>
      </div>

      <!-- Se√ß√£o Dados Pessoais -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-icon">üë§</div>
          <h3>Dados Pessoais</h3>
        </div>
        
        <div class="form-row">
          <div class="field-group full-width">
            <label>Nome Completo <span class="required">*</span></label>
            <input type="text" id="cadNome" required minlength="2" autocomplete="name" placeholder="Digite seu nome completo">
            <div class="field-hint">M√≠nimo 2 caracteres</div>
          </div>
        </div>

        <div class="form-row">
          <div class="field-group half-width">
            <label>CPF/CNPJ <span class="required">*</span></label>
            <input type="text" id="cadCpf" required maxlength="18" autocomplete="off" placeholder="000.000.000-00">
          </div>
          <div class="field-group half-width">
            <label>Email <span class="required">*</span></label>
            <div class="input-with-icon">
              <input type="email" id="cadEmail" required autocomplete="email" placeholder="seu@email.com">
              <span id="iconeEmailVerificado" class="input-icon verified-icon" style="display:none;">‚úî</span>
            </div>
            <button type="button" id="btnVerificarEmail" class="btn-secondary" style="display:none; margin-top:8px;">
              Verificar e-mail
            </button>
            <div id="areaCodigoEmail" class="verification-area" style="display:none;">
              <label class="verification-label">Digite o c√≥digo recebido no e-mail:</label>
              <div class="verification-input-group">
                <input type="text" id="inputCodigoEmail" maxlength="6" class="verification-code" placeholder="000000">
                <button type="button" id="btnValidarCodigoEmail" class="btn-verify">Validar</button>
              </div>
              <div id="statusCodigoEmail" class="verification-status"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Se√ß√£o Contato -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-icon">üìû</div>
          <h3>Contato</h3>
        </div>
        
        <div class="form-row">
          <div class="field-group half-width">
            <label>Telefone</label>
            <input type="text" id="cadTelefone" autocomplete="tel" placeholder="(11) 99999-9999">
            <div class="field-hint">Formato: (11) 99999-9999</div>
          </div>
          <div class="field-group half-width">
            <label>Celular</label>
            <input type="text" id="cadCelular" autocomplete="tel" placeholder="(11) 91234-5678">
          </div>
        </div>
      </div>

      <!-- Se√ß√£o Endere√ßo -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-icon">üìç</div>
          <h3>Endere√ßo</h3>
        </div>
        
        <div class="form-row">
          <div class="field-group half-width">
            <label>CEP <span class="required">*</span></label>
            <input type="text" id="cadCep" required maxlength="9" autocomplete="postal-code" placeholder="00000-000">
            <div class="field-hint">Preencheremos o endere√ßo automaticamente</div>
          </div>
          <div class="field-group half-width">
            <label>Logradouro <span class="required">*</span></label>
            <input type="text" id="cadEndereco" required autocomplete="street-address" readonly class="readonly-field">
            <div class="field-hint">Preenchido automaticamente pelo CEP</div>
          </div>
        </div>

        <div class="form-row">
          <div class="field-group third-width">
            <label>N√∫mero <span class="required">*</span></label>
            <input type="text" id="cadNumero" required placeholder="123">
          </div>
          <div class="field-group third-width">
            <label>Complemento</label>
            <input type="text" id="cadComplemento" placeholder="Apto, Sala, etc.">
          </div>
          <div class="field-group third-width">
            <label>Bairro</label>
            <input type="text" id="cadBairro" readonly class="readonly-field">
          </div>
        </div>

        <div class="form-row">
          <div class="field-group half-width">
            <label>Cidade</label>
            <input type="text" id="cadCidade" readonly class="readonly-field">
          </div>
          <div class="field-group quarter-width">
            <label>Estado</label>
            <select id="cadEstado" disabled class="readonly-field">
              <option value="SP">SP</option>
            </select>
          </div>
          <div class="field-group quarter-width">
            <label>Apartamento</label>
            <input type="text" id="cadApartamento" required placeholder="101">
          </div>
        </div>

        <div class="form-row">
          <div class="field-group half-width">
            <label>Bloco</label>
            <input type="text" id="cadBloco" required placeholder="A">
          </div>
          <div class="field-group half-width">
            <label>Nome do empreendimento</label>
            <input type="text" id="cadEmpreendimento" placeholder="Nome do condom√≠nio/residencial">
          </div>
        </div>
      </div>

      <!-- Se√ß√£o Servi√ßo -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-icon">üì°</div>
          <h3>Servi√ßo Contratado</h3>
        </div>
        
        <div class="form-row">
          <div class="field-group full-width">
            <label>Selecione seu plano</label>
            <div class="servico-container" id="cadServicoContainer">
              <button type="button" class="btn-select-service" onclick="abrirModalServicos('cadastro')" id="btnSelecionarServico">
                <span class="btn-icon">+</span>
                Selecionar servi√ßo
              </button>
            </div>
            <div class="field-hint">Escolha o plano que melhor atende suas necessidades</div>
          </div>
        </div>
      </div>

      <!-- Se√ß√£o Dados de Acesso -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-icon">üîí</div>
          <h3>Dados de Acesso</h3>
        </div>
        
        <div class="form-row">
          <div class="field-group half-width">
            <label>Senha <span class="required">*</span></label>
            <div class="password-input-container">
              <input type="password" id="cadSenha" required autocomplete="new-password" minlength="8" placeholder="M√≠nimo 8 caracteres">
              <button type="button" class="btn-toggle-password" onclick="togglePasswordVisibility('cadSenha')">üëÅ</button>
            </div>
            <div class="password-requirements">
              <div class="requirement-item" id="req-length">
                <span class="requirement-icon">‚óã</span>
                <span>M√≠nimo 8 caracteres</span>
              </div>
              <div class="requirement-item" id="req-upper">
                <span class="requirement-icon">‚óã</span>
                <span>Uma letra mai√∫scula</span>
              </div>
              <div class="requirement-item" id="req-lower">
                <span class="requirement-icon">‚óã</span>
                <span>Uma letra min√∫scula</span>
              </div>
              <div class="requirement-item" id="req-number">
                <span class="requirement-icon">‚óã</span>
                <span>Um n√∫mero</span>
              </div>
              <div class="requirement-item" id="req-special">
                <span class="requirement-icon">‚óã</span>
                <span>Um caractere especial</span>
              </div>
            </div>
          </div>
          <div class="field-group half-width">
            <label>Confirmar Senha <span class="required">*</span></label>
            <div class="password-input-container">
              <input type="password" id="cadSenha2" required autocomplete="new-password" placeholder="Repita a senha">
              <button type="button" class="btn-toggle-password" onclick="togglePasswordVisibility('cadSenha2')">üëÅ</button>
            </div>
            <div id="password-match-indicator" class="password-match-indicator"></div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-primary">
          <span class="btn-icon">‚úì</span>
          Realizar Cadastro
        </button>
        <button type="button" onclick="window.location.href='index-principal.html'" class="btn-secondary">
          <span class="btn-icon">‚Üê</span>
          Voltar ao In√≠cio
        </button>
      </div>
      
      <!-- Link para login -->
      <div style="text-align: center; margin-top: 16px;">
        <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 8px;">J√° possui cadastro?</p>
        <button type="button" onclick="window.location.href='login.html'" class="link-btn" style="color: #00bcd4; text-decoration: underline;">
          üîê Fazer Login
        </button>
      </div>
    </form>

    <!-- Modal de sele√ß√£o de servi√ßos -->
    <div class="modal-servicos" id="modalServicos">
      <div class="modal-content">
        <span class="close-modal" onclick="fecharModalServicos()">&times;</span>
        <div class="servicos-grid">
          <div class="servico-card" onclick="selecionarServico('Claro fibra 350 MEGA + globoplay', 'cadastro')">
            <div class="servico-titulo">Claro<span style='color:#ff0000'> fibra</span></div>
            <div class="servico-mega">350 MEGA</div>
            <div class="servico-benef">globoplay + Wi-Fi Gr√°tis + McAfee + E-books</div>
            <div class="servico-preco">R$ 79,90/m√™s</div>
            <button type="button" class="servico-btn">Assine</button>
          </div>
          <div class="servico-card" onclick="selecionarServico('Claro fibra 600 MEGA + globoplay + Claro p√≥s 60GB', 'cadastro')">
            <div class="servico-titulo">Claro<span style='color:#ff0000'> fibra</span></div>
            <div class="servico-mega">600 MEGA</div>
            <div class="servico-benef">globoplay + Wi-Fi Gr√°tis + Claro p√≥s 60GB</div>
            <div class="servico-preco">R$ 159,90/m√™s</div>
            <button type="button" class="servico-btn">Assine</button>
          </div>
          <div class="servico-card" onclick="selecionarServico('Claro controle 30GB + b√¥nus', 'cadastro')">
            <div class="servico-titulo">Claro<span style='color:#ff0000'> controle</span></div>
            <div class="servico-mega">30GB</div>
            <div class="servico-benef">15GB + 5GB redes sociais + WhatsApp ilimitado + 10GB b√¥nus</div>
            <div class="servico-preco">R$ 59,90/m√™s</div>
            <button type="button" class="servico-btn">Contrate</button>
          </div>
          <div class="servico-card" onclick="selecionarServico('Claro p√≥s 50GB', 'cadastro')">
            <div class="servico-titulo">Claro<span style='color:#ff0000'> p√≥s</span></div>
            <div class="servico-mega">50GB</div>
            <div class="servico-benef">25GB + 25GB + WhatsApp ilimitado</div>
            <div class="servico-preco">R$ 119,90/m√™s</div>
            <button type="button" class="servico-btn">Contrate</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Overlay de loading -->
    <div id="loadingOverlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.7);z-index:10000;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:32px 40px;border-radius:12px;box-shadow:0 2px 16px #0002;display:flex;flex-direction:column;align-items:center;gap:16px;">
        <div class="spinner" style="border:6px solid #eee;border-top:6px solid #ff0000;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;"></div>
        <span style="font-size:1.1em;color:#333;">Carregando...</span>
      </div>
    </div>

    <!-- Notifica√ß√£o -->
    <div class="notification" id="notification"></div>
  </div>
  
  <style>
    @keyframes spin { 
      0% { transform: rotate(0deg);} 
      100% { transform: rotate(360deg);} 
    }
    
    /* Estilos para notifica√ß√µes */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 10002;
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 300px;
    }
    
    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .notification.success {
      background: #28a745;
    }
    
    .notification.error {
      background: #dc3545;
    }
    
    .notification.info {
      background: #17a2b8;
    }
    
    /* Estilos para valida√ß√£o de campos */
    .validation-message {
      font-size: 0.8em !important;
      margin-top: 4px !important;
      font-weight: 500;
    }
    
    .field-valid {
      border-color: #28a745 !important;
    }
    
    .field-invalid {
      border-color: #dc3545 !important;
    }
    
    /* Estilos para requisitos de senha */
    .password-requirements {
      margin-top: 8px;
      font-size: 0.85em;
    }
    
    .requirement-item {
      display: flex;
      align-items: center;
      margin: 4px 0;
      color: #666;
      transition: color 0.3s ease;
    }
    
    .requirement-icon {
      margin-right: 8px;
      font-weight: bold;
      min-width: 16px;
    }
    
    /* Estilo para indicador de senhas coincidentes */
    .password-match-indicator {
      margin-top: 8px;
      font-size: 0.85em;
      font-weight: 500;
    }
    
    /* Estilo para bot√£o de verificar email */
    .btn-secondary {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.3s ease;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    /* √Årea de verifica√ß√£o de email */
    .verification-area {
      margin-top: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
    }
    
    .verification-label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.9em;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .verification-input-group {
      display: flex;
      gap: 8px;
    }
    
    .verification-code {
      flex: 1;
      padding: 8px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      text-align: center;
      letter-spacing: 2px;
    }
    
    .btn-verify {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    
    .btn-verify:hover {
      background: #218838;
    }
    
    .verification-status {
      margin-top: 8px;
      font-size: 0.85em;
    }
    
    /* Estilos para avisos de dom√≠nio */
    .domain-warning {
      color: #856404 !important;
      font-size: 11px !important;
      display: block !important;
      margin-top: 2px !important;
    }
    
    /* Estilo para c√≥digo completo */
    .verification-code.code-complete {
      background: rgba(40, 167, 69, 0.1) !important;
      border-color: #28a745 !important;
    }
  </style>
  
  <script src="navigation.js"></script>
  <script src="script.js"></script>
  <script>
    // Inicializar sistema de cadastro
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar se o usu√°rio j√° est√° autenticado
      const isAuthenticated = localStorage.getItem('userAuthenticated');
      const userData = JSON.parse(localStorage.getItem('userData') || '{}');
      
      if (isAuthenticated === 'true' && userData.nome) {
        // Usu√°rio j√° est√° autenticado, redirecionar para dashboard
        window.location.href = 'dashboard.html';
        return;
      }

      // Garantir que estamos no modo cadastro
      document.body.className = 'cadastro-ativo';
      
      // Inicializar CSRF Token se n√£o existir
      if (!localStorage.getItem('csrfToken')) {
        const token = generateCSRFToken();
        localStorage.setItem('csrfToken', token);
        console.log('CSRF Token gerado:', token);
      }
      
      // Inicializar funcionalidades espec√≠ficas do cadastro
      if (typeof initializeRegistrationSystem === 'function') {
        initializeRegistrationSystem();
      }
      
      // Inicializar todas as funcionalidades do cadastro
      initializeCadastroFunctionalities();
    });

    function generateCSRFToken() {
      const array = new Uint32Array(4);
      crypto.getRandomValues(array);
      return Array.from(array, dec => ('0' + dec.toString(16)).substr(-2)).join('');
    }

    // Vari√°vel para evitar inicializa√ß√£o dupla
    let cadastroFunctionalitiesInitialized = false;

    function initializeCadastroFunctionalities() {
      // Verificar se j√° foi inicializado
      if (cadastroFunctionalitiesInitialized) {
        console.warn('Funcionalidades do cadastro j√° foram inicializadas');
        return;
      }
      
      console.log('Inicializando funcionalidades do cadastro');
      cadastroFunctionalitiesInitialized = true;
      
      // Formata√ß√£o e valida√ß√£o de CPF
      const cpfInput = document.getElementById('cadCpf');
      if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          
          if (value.length <= 11) {
            // Formato CPF: 000.000.000-00
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
          } else {
            // Formato CNPJ: 00.000.000/0000-00
            value = value.replace(/(\d{2})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1/$2');
            value = value.replace(/(\d{4})(\d{1,2})$/, '$1-$2');
          }
          
          e.target.value = value;
          validateCPF(value);
        });
        
        cpfInput.addEventListener('blur', function(e) {
          validateCPF(e.target.value);
        });
      }

      // Formata√ß√£o de telefones
      const telefoneInput = document.getElementById('cadTelefone');
      const celularInput = document.getElementById('cadCelular');
      
      [telefoneInput, celularInput].forEach(input => {
        if (input) {
          input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length <= 10) {
              // Telefone fixo: (11) 9999-9999
              value = value.replace(/(\d{2})(\d)/, '($1) $2');
              value = value.replace(/(\d{4})(\d)/, '$1-$2');
            } else {
              // Celular: (11) 99999-9999
              value = value.replace(/(\d{2})(\d)/, '($1) $2');
              value = value.replace(/(\d{5})(\d)/, '$1-$2');
            }
            
            e.target.value = value;
          });
        }
      });

      // Preenchimento autom√°tico de CEP
      const cepInput = document.getElementById('cadCep');
      if (cepInput) {
        cepInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          value = value.replace(/(\d{5})(\d)/, '$1-$2');
          e.target.value = value;
          
          if (value.replace(/\D/g, '').length === 8) {
            preencherEnderecoPorCep(value.replace(/\D/g, ''));
          }
        });
      }

      // Verifica√ß√£o de email com funcionalidades avan√ßadas
      const emailInput = document.getElementById('cadEmail');
      const btnVerificarEmail = document.getElementById('btnVerificarEmail');
      
      if (emailInput) {
        emailInput.addEventListener('input', function(e) {
          const email = e.target.value.trim().toLowerCase();
          console.log('Email input event triggered:', email);
          validateEmail(email);
          
          // Reset status de verifica√ß√£o ao alterar email
          emailVerificado = false;
          const areaCodigoEmail = document.getElementById('areaCodigoEmail');
          const statusCodigoEmail = document.getElementById('statusCodigoEmail');
          const iconeEmailVerificado = document.getElementById('iconeEmailVerificado');
          
          if (areaCodigoEmail) areaCodigoEmail.style.display = 'none';
          if (statusCodigoEmail) statusCodigoEmail.textContent = '';
          if (iconeEmailVerificado) iconeEmailVerificado.style.display = 'none';
          
          // Verificar se √© um dom√≠nio confi√°vel
          if (email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            verificarDominioEmail(email);
          }
        });
        
        emailInput.addEventListener('blur', function(e) {
          console.log('Email blur event triggered:', e.target.value);
          validateEmail(e.target.value.trim().toLowerCase());
        });
      }
      
      if (btnVerificarEmail) {
        // Remover listener anterior se existir para evitar duplicatas
        btnVerificarEmail.removeEventListener('click', iniciarVerificacaoEmail);
        
        // Adicionar debounce para evitar cliques duplos
        let lastClickTime = 0;
        btnVerificarEmail.addEventListener('click', function(e) {
          const currentTime = Date.now();
          if (currentTime - lastClickTime < 2000) { // 2 segundos de prote√ß√£o
            console.warn('Clique muito r√°pido - ignorando');
            e.preventDefault();
            return;
          }
          lastClickTime = currentTime;
          
          console.log('Bot√£o verificar email clicado');
          iniciarVerificacaoEmail();
        });
      }
      
      // Bot√£o validar c√≥digo email com funcionalidades avan√ßadas
      const btnValidarCodigoEmail = document.getElementById('btnValidarCodigoEmail');
      const inputCodigoEmail = document.getElementById('inputCodigoEmail');
      
      if (btnValidarCodigoEmail) {
        btnValidarCodigoEmail.addEventListener('click', function() {
          console.log('Bot√£o validar c√≥digo clicado');
          validarCodigoEmail();
        });
      }
      
      // Funcionalidades avan√ßadas do campo de c√≥digo
      if (inputCodigoEmail) {
        // Validar c√≥digo ao pressionar Enter
        inputCodigoEmail.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            validarCodigoEmail();
          }
        });
        
        // Formatar c√≥digo automaticamente
        inputCodigoEmail.addEventListener('input', function() {
          this.value = this.value.replace(/\D/g, '').slice(0, 6);
          
          // Feedback visual para c√≥digo completo
          if (this.value.length === 6) {
            this.classList.add('code-complete');
            setTimeout(() => validarCodigoEmail(), 500);
          } else {
            this.classList.remove('code-complete');
          }
        });
      }

      // Valida√ß√£o de senha em tempo real
      const senhaInput = document.getElementById('cadSenha');
      const confirmSenhaInput = document.getElementById('cadSenha2');
      
      if (senhaInput) {
        senhaInput.addEventListener('input', function(e) {
          validatePassword(e.target.value);
        });
      }
      
      if (confirmSenhaInput) {
        confirmSenhaInput.addEventListener('input', function(e) {
          validatePasswordMatch();
        });
      }

      // Submit do formul√°rio
      const formCadastro = document.getElementById('formCadastro');
      if (formCadastro) {
        formCadastro.addEventListener('submit', function(e) {
          e.preventDefault();
          handleCadastroSubmit();
        });
      }
    }

    function validateCPF(cpf) {
      console.log('Validando CPF:', cpf);
      const cleanCpf = cpf.replace(/\D/g, '');
      console.log('CPF limpo:', cleanCpf);
      
      if (cleanCpf.length === 11) {
        if (isValidCPF(cleanCpf)) {
          console.log('CPF v√°lido');
          showFieldValidation('cadCpf', true, 'CPF v√°lido');
        } else {
          console.log('CPF inv√°lido');
          showFieldValidation('cadCpf', false, 'CPF inv√°lido');
        }
      } else if (cleanCpf.length === 14) {
        // Valida√ß√£o b√°sica de CNPJ
        console.log('CNPJ detectado');
        showFieldValidation('cadCpf', true, 'CNPJ v√°lido');
      } else if (cleanCpf.length > 0) {
        console.log('CPF/CNPJ incompleto');
        showFieldValidation('cadCpf', false, 'CPF/CNPJ incompleto');
      } else {
        console.log('CPF vazio, limpando valida√ß√£o');
        // Limpar valida√ß√£o se estiver vazio
        const field = document.getElementById('cadCpf');
        const existingMsg = field.parentNode.querySelector('.validation-message');
        if (existingMsg) {
          existingMsg.remove();
        }
        field.style.borderColor = '';
      }
    }

    function isValidCPF(cpf) {
      if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
      
      let sum = 0;
      for (let i = 0; i < 9; i++) {
        sum += parseInt(cpf.charAt(i)) * (10 - i);
      }
      let remainder = 11 - (sum % 11);
      if (remainder === 10 || remainder === 11) remainder = 0;
      if (remainder !== parseInt(cpf.charAt(9))) return false;
      
      sum = 0;
      for (let i = 0; i < 10; i++) {
        sum += parseInt(cpf.charAt(i)) * (11 - i);
      }
      remainder = 11 - (sum % 11);
      if (remainder === 10 || remainder === 11) remainder = 0;
      return remainder === parseInt(cpf.charAt(10));
    }

    async function preencherEnderecoPorCep(cep) {
      console.log('Buscando CEP:', cep);
      try {
        toggleLoading(true);
        
        // Tentar ViaCEP primeiro
        console.log('Tentando ViaCEP...');
        let response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        let data = await response.json();
        
        console.log('Resposta ViaCEP:', data);
        
        if (data.erro) {
          // Tentar BrasilAPI como fallback
          console.log('ViaCEP falhou, tentando BrasilAPI...');
          response = await fetch(`https://brasilapi.com.br/api/cep/v1/${cep}`);
          data = await response.json();
          console.log('Resposta BrasilAPI:', data);
        }
        
        if (data && !data.erro) {
          const endereco = data.logradouro || data.street || '';
          const bairro = data.bairro || data.district || '';
          const cidade = data.localidade || data.city || '';
          const estado = data.uf || data.state || '';
          
          console.log('Preenchendo campos:', { endereco, bairro, cidade, estado });
          
          document.getElementById('cadEndereco').value = endereco;
          document.getElementById('cadBairro').value = bairro;
          document.getElementById('cadCidade').value = cidade;
          
          const estadoSelect = document.getElementById('cadEstado');
          if (estadoSelect) {
            // Adicionar a op√ß√£o se n√£o existir
            let optionExists = false;
            for (let option of estadoSelect.options) {
              if (option.value === estado) {
                optionExists = true;
                break;
              }
            }
            if (!optionExists && estado) {
              const newOption = document.createElement('option');
              newOption.value = estado;
              newOption.textContent = estado;
              estadoSelect.appendChild(newOption);
            }
            estadoSelect.value = estado;
          }
          
          mostrarNotificacao('Endere√ßo preenchido automaticamente!', 'success');
        } else {
          console.log('CEP n√£o encontrado');
          mostrarNotificacao('CEP n√£o encontrado', 'error');
        }
      } catch (error) {
        console.error('Erro ao buscar CEP:', error);
        mostrarNotificacao('Erro ao buscar CEP', 'error');
      } finally {
        toggleLoading(false);
      }
    }

    function validateEmail(email) {
      console.log('Validando email:', email);
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const btnVerificarEmail = document.getElementById('btnVerificarEmail');
      
      if (email && emailRegex.test(email)) {
        console.log('Email v√°lido, mostrando bot√£o');
        showFieldValidation('cadEmail', true, 'Email v√°lido');
        if (btnVerificarEmail) {
          btnVerificarEmail.style.display = 'block';
        }
      } else if (email) {
        console.log('Email inv√°lido');
        showFieldValidation('cadEmail', false, 'Email inv√°lido');
        if (btnVerificarEmail) {
          btnVerificarEmail.style.display = 'none';
        }
      } else {
        console.log('Email vazio');
        if (btnVerificarEmail) {
          btnVerificarEmail.style.display = 'none';
        }
        // Limpar valida√ß√£o se estiver vazio
        const field = document.getElementById('cadEmail');
        const existingMsg = field.parentNode.querySelector('.validation-message');
        if (existingMsg) {
          existingMsg.remove();
        }
        field.style.borderColor = '';
      }
    }

    function validatePassword(password) {
      const requirements = {
        'req-length': password.length >= 8,
        'req-upper': /[A-Z]/.test(password),
        'req-lower': /[a-z]/.test(password),
        'req-number': /\d/.test(password),
        'req-special': /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\?]/.test(password)
      };
      
      Object.keys(requirements).forEach(reqId => {
        const element = document.getElementById(reqId);
        if (element) {
          const icon = element.querySelector('.requirement-icon');
          if (requirements[reqId]) {
            icon.textContent = '‚úì';
            icon.style.color = '#28a745';
            element.style.color = '#28a745';
          } else {
            icon.textContent = '‚óã';
            icon.style.color = '#dc3545';
            element.style.color = '#dc3545';
          }
        }
      });
      
      validatePasswordMatch();
    }

    function validatePasswordMatch() {
      const senha = document.getElementById('cadSenha').value;
      const confirmSenha = document.getElementById('cadSenha2').value;
      const indicator = document.getElementById('password-match-indicator');
      
      if (confirmSenha) {
        if (senha === confirmSenha) {
          indicator.textContent = '‚úì Senhas coincidem';
          indicator.style.color = '#28a745';
        } else {
          indicator.textContent = '‚úó Senhas n√£o coincidem';
          indicator.style.color = '#dc3545';
        }
      } else {
        indicator.textContent = '';
      }
    }

    function showFieldValidation(fieldId, isValid, message) {
      console.log('Mostrando valida√ß√£o para:', fieldId, isValid, message);
      const field = document.getElementById(fieldId);
      
      if (!field) {
        console.error('Campo n√£o encontrado:', fieldId);
        return;
      }
      
      // Procurar por mensagem existente no parent ou pr√≥ximo elemento
      let parentElement = field.parentNode;
      const existingMsg = parentElement.querySelector('.validation-message');
      
      if (existingMsg) {
        existingMsg.remove();
      }
      
      // Criar nova mensagem
      const msgElement = document.createElement('div');
      msgElement.className = 'validation-message';
      msgElement.style.fontSize = '0.8em';
      msgElement.style.marginTop = '4px';
      msgElement.style.color = isValid ? '#28a745' : '#dc3545';
      msgElement.textContent = message;
      
      // Adicionar ap√≥s o campo
      field.parentNode.appendChild(msgElement);
      
      // Alterar cor da borda
      field.style.borderColor = isValid ? '#28a745' : '#dc3545';
      
      console.log('Valida√ß√£o aplicada com sucesso');
    }

    async function handleCadastroSubmit() {
      try {
        toggleLoading(true);
        
        // Validar todos os campos obrigat√≥rios
        const nome = document.getElementById('cadNome').value.trim();
        const cpf = document.getElementById('cadCpf').value.replace(/\D/g, '');
        const email = document.getElementById('cadEmail').value.trim().toLowerCase();
        const cep = document.getElementById('cadCep').value.replace(/\D/g, '');
        const endereco = document.getElementById('cadEndereco').value.trim();
        const numero = document.getElementById('cadNumero').value.trim();
        const apartamento = document.getElementById('cadApartamento').value.trim();
        const bloco = document.getElementById('cadBloco').value.trim();
        const senha = document.getElementById('cadSenha').value;
        const confirmSenha = document.getElementById('cadSenha2').value;
        
        // Coleta todos os dados do formul√°rio
        const formData = {
          nome,
          cpf,
          cep,
          email,
          endereco,
          numero: numero,
          complemento: document.getElementById('cadComplemento').value.trim(),
          bairro: document.getElementById('cadBairro').value.trim(),
          cidade: document.getElementById('cadCidade').value.trim(),
          estado: document.getElementById('cadEstado').value,
          apartamento,
          bloco,
          empreendimento: document.getElementById('cadEmpreendimento').value.trim(),
          telefone: document.getElementById('cadTelefone').value,
          celular: document.getElementById('cadCelular').value,
          senha,
          senha2: confirmSenha
        };
        
        // Valida√ß√µes
        if (!nome || nome.length < 2) {
          throw new Error('Nome deve ter pelo menos 2 caracteres');
        }
        
        if (!cpf || (cpf.length !== 11 && cpf.length !== 14)) {
          throw new Error('CPF/CNPJ inv√°lido');
        }
        
        if (cpf.length === 11 && !isValidCPF(cpf)) {
          throw new Error('CPF inv√°lido');
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email || !emailRegex.test(email)) {
          throw new Error('Email inv√°lido');
        }
        
        // Verificar se email foi validado (temporariamente opcional para teste)
        if (!emailVerificado) {
          console.warn('‚ö†Ô∏è Email n√£o verificado - procedendo para teste');
          // Para desenvolvimento/teste - remover esta linha em produ√ß√£o
          emailVerificado = true;
          // throw new Error('Por favor, verifique seu email antes de continuar');
        }
        
        if (!cep || cep.length !== 8) {
          throw new Error('CEP inv√°lido');
        }
        
        if (!endereco) {
          throw new Error('Endere√ßo √© obrigat√≥rio');
        }
        
        if (!numero) {
          throw new Error('N√∫mero √© obrigat√≥rio');
        }
        
        if (!apartamento) {
          throw new Error('Apartamento √© obrigat√≥rio');
        }
        
        if (!bloco) {
          throw new Error('Bloco √© obrigat√≥rio');
        }
        
        if (!senha || senha.length < 8) {
          throw new Error('Senha deve ter pelo menos 8 caracteres');
        }
        
        if (senha !== confirmSenha) {
          throw new Error('Senhas n√£o coincidem');
        }
        
        // Coletar servi√ßo selecionado
        let servicoSelecionado = '';
        const servicoInput = document.getElementById('cadServico');
        if (servicoInput) {
          servicoSelecionado = servicoInput.value;
        }
        
        // Hash da senha no frontend (camada extra de seguran√ßa)
        const hashedPassword = btoa(senha + 'salt_' + cpf);
        
        console.log('üöÄ Enviando dados para API (igual clientes.html):', {
          nome: nome,
          cpf: cpf.substring(0, 3) + '***',
          email,
          cep,
          endereco,
          apartamento,
          bloco,
          servico: servicoSelecionado
        });
        
        // Preparar dados no formato esperado pela API original (2 tabelas)
        const dadosParaEnvio = {
          tipo: 'novo_cliente',
          nome_cliente: nome,
          cpf: cpf,
          cep: cep,
          email: email,
          endereco: endereco,
          numero: numero,
          complemento: document.getElementById('cadComplemento').value.trim(),
          bairro: document.getElementById('cadBairro').value.trim(),
          cidade: document.getElementById('cadCidade').value.trim(),
          estado: document.getElementById('cadEstado').value,
          apartamento: apartamento,
          bloco: bloco,
          nome_empreendimento: document.getElementById('cadEmpreendimento').value.trim(),
          telefone: document.getElementById('cadTelefone').value,
          celular: document.getElementById('cadCelular').value,
          servico: servicoSelecionado,
          senha: hashedPassword,
          timestamp: Date.now(),
          fingerprint: generateFingerprint()
        };
        
        // Enviar para API do banco Neon (mesmo endpoint que clientes.html - salva em 2 tabelas)
        console.log('üì° Fazendo requisi√ß√£o para:', 'https://chegar-primeiro.onrender.com/api/solicitacoes');
        const response = await fetch('https://chegar-primeiro.onrender.com/api/solicitacoes', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-CSRF-Token': localStorage.getItem('csrfToken')
          },
          body: JSON.stringify(dadosParaEnvio)
        });
        
        console.log('üìä Status da resposta:', response.status);
        console.log('üìã Headers da resposta:', response.headers);
        console.log('‚úÖ Response OK:', response.ok);
        
        const data = await response.json();
        console.log('üì¶ Dados da resposta completa:', data);
        
        if (response.ok && data.success) {
          console.log('‚úÖ Cadastro realizado com sucesso nas 2 tabelas (solicitacoes + clientes)!');
          mostrarNotificacao('‚úÖ Cadastro realizado com sucesso no banco Neon!', 'success');
          
          // Limpar formul√°rio apenas se cadastrou com sucesso
          document.getElementById('formCadastro').reset();
          emailVerificado = false;
          const iconeEmail = document.getElementById('iconeEmailVerificado');
          if (iconeEmail) iconeEmail.style.display = 'none';
          
          // Reset das valida√ß√µes
          document.querySelectorAll('.validation-message').forEach(msg => msg.remove());
          document.querySelectorAll('input, select').forEach(field => {
            field.style.borderColor = '';
          });
          
          // Redirecionar apenas se salvou no banco
          setTimeout(() => {
            mostrarNotificacao('üöÄ Redirecionando para login...', 'info');
            setTimeout(() => {
              window.location.href = 'login.html';
            }, 1000);
          }, 1500);
          
        } else if (response.ok && !data.success && data.motivo === 'ja_existe') {
          // Cliente j√° existe - tratar especificamente
          console.log('‚ö†Ô∏è Cliente j√° existe no sistema');
          throw new Error('üîÑ CPF ou Email j√° cadastrado. Fa√ßa login ou use dados diferentes.');
        } else {
          // Outros erros espec√≠ficos do banco Neon
          const errorMsg = data.error || 'Erro ao salvar no banco de dados Neon';
          console.error('‚ùå Erro do banco Neon:', errorMsg);
          
          if (response.status === 500) {
            throw new Error('üî• Erro interno do servidor. Tente novamente em alguns instantes.');
          } else if (response.status === 409) {
            throw new Error('‚ö†Ô∏è CPF ou Email j√° cadastrado no sistema.');
          } else if (response.status === 400) {
            throw new Error('üìù Dados inv√°lidos. Verifique os campos obrigat√≥rios.');
          } else {
            throw new Error('üíæ Erro ao salvar no banco Neon: ' + errorMsg);
          }
        }
        
      } catch (error) {
        console.error('‚ùå Erro no cadastro:', error);
        
        // Tratar diferentes tipos de erro com mais especificidade
        let errorMessage = error.message;
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorMessage = 'üåê Erro de conex√£o com o servidor. Verifique sua internet e tente novamente.';
        } else if (error.message.includes('NetworkError')) {
          errorMessage = 'üì° Erro de rede. Verifique sua conex√£o e tente novamente.';
        } else if (error.message.includes('timeout')) {
          errorMessage = '‚è±Ô∏è Tempo limite excedido. O servidor pode estar sobrecarregado.';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = 'üîå N√£o foi poss√≠vel conectar ao banco Neon. Tente novamente em alguns instantes.';
        } else if (error.message.includes('Internal Server Error')) {
          errorMessage = '‚ö†Ô∏è Erro interno do servidor Neon. Tente novamente em alguns minutos.';
        }
        
        // Sempre mostrar o erro espec√≠fico
        mostrarNotificacao(errorMessage, 'error', 8000);
        
        // Log detalhado para debug
        console.error('Detalhes do erro:', {
          name: error.name,
          message: error.message,
          stack: error.stack,
          timestamp: new Date().toISOString()
        });
      } finally {
        toggleLoading(false);
      }
    }

    function mostrarNotificacao(mensagem, tipo = 'info', duracao = 5000) {
      const notification = document.getElementById('notification');
      if (!notification) return;
      
      notification.className = `notification show ${tipo}`;
      notification.textContent = mensagem;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, duracao);
    }

    function toggleLoading(show = true) {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.style.display = show ? 'flex' : 'none';
      }
    }

    // Sistema de verifica√ß√£o de email com envio real
    let emailVerificado = false;
    let emailVerificationTimer = null;
    let isEmailVerificationInProgress = false; // Adicionar prote√ß√£o contra envios duplos
    
    function iniciarVerificacaoEmail() {
      console.log('Iniciando verifica√ß√£o de email');
      
      // Verificar se j√° est√° em andamento
      if (isEmailVerificationInProgress) {
        console.warn('Verifica√ß√£o de email j√° est√° em andamento');
        mostrarNotificacao('Aguarde, verifica√ß√£o em andamento...', 'info');
        return;
      }
      
      const email = document.getElementById('cadEmail').value.trim().toLowerCase();
      const btnVerificarEmail = document.getElementById('btnVerificarEmail');
      const areaCodigoEmail = document.getElementById('areaCodigoEmail');
      const statusCodigoEmail = document.getElementById('statusCodigoEmail');
      const inputCodigoEmail = document.getElementById('inputCodigoEmail');
      
      console.log('Email:', email);
      console.log('Bot√£o encontrado:', !!btnVerificarEmail);
      console.log('√Årea c√≥digo encontrada:', !!areaCodigoEmail);
      
      if (!email) {
        mostrarNotificacao('Digite um email v√°lido primeiro', 'error');
        return;
      }
      
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        mostrarNotificacao('Digite um email v√°lido', 'error');
        return;
      }
      
      // Verificar se √© um dom√≠nio confi√°vel
      if (!isEmailDomainTrusted(email)) {
        if (!confirm('Este dom√≠nio de email n√£o √© muito comum. Tem certeza que o email est√° correto?')) {
          return;
        }
      }
      
      if (btnVerificarEmail) {
        btnVerificarEmail.disabled = true;
        btnVerificarEmail.textContent = 'Enviando...';
      }
      
      // Marcar como em andamento
      isEmailVerificationInProgress = true;
      
      // Enviar c√≥digo real via API
      fetch('https://chegar-primeiro.onrender.com/api/enviar-codigo-email', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'X-CSRF-Token': localStorage.getItem('csrfToken')
        },
        body: JSON.stringify({ 
          email,
          timestamp: Date.now(),
          fingerprint: generateFingerprint()
        })
      })
      .then(res => res.json())
      .then(data => {
        // Finalizar processo de verifica√ß√£o
        isEmailVerificationInProgress = false;
        
        if (btnVerificarEmail) {
          btnVerificarEmail.disabled = false;
          btnVerificarEmail.textContent = 'Verificar e-mail';
        }
        
        if (data.success) {
          if (areaCodigoEmail) {
            areaCodigoEmail.style.display = 'block';
          }
          if (statusCodigoEmail) {
            statusCodigoEmail.textContent = 'C√≥digo enviado! Confira seu e-mail (inclusive spam).';
            statusCodigoEmail.style.color = '#28a745';
          }
          if (btnVerificarEmail) {
            btnVerificarEmail.style.display = 'none';
          }
          
          emailVerificado = false;
          document.getElementById('iconeEmailVerificado').style.display = 'none';
          
          // Timer de expira√ß√£o do c√≥digo (5 minutos)
          startEmailVerificationTimer();
          
          // Focar no campo de c√≥digo
          if (inputCodigoEmail) {
            inputCodigoEmail.focus();
          }
          
          mostrarNotificacao('C√≥digo enviado para ' + email, 'success');
        } else {
          mostrarNotificacao(data.error || 'Erro ao enviar c√≥digo.', 'error');
        }
      })
      .catch(error => {
        console.error('Erro ao enviar c√≥digo:', error);
        
        // Finalizar processo de verifica√ß√£o mesmo em caso de erro
        isEmailVerificationInProgress = false;
        
        if (btnVerificarEmail) {
          btnVerificarEmail.disabled = false;
          btnVerificarEmail.textContent = 'Verificar e-mail';
        }
        mostrarNotificacao('Erro ao enviar c√≥digo.', 'error');
      });
    }

    function validarCodigoEmail() {
      console.log('Validando c√≥digo de email');
      const email = document.getElementById('cadEmail').value.trim().toLowerCase();
      const codigoDigitado = document.getElementById('inputCodigoEmail').value.trim();
      const statusElement = document.getElementById('statusCodigoEmail');
      const iconeEmailVerificado = document.getElementById('iconeEmailVerificado');
      const areaCodigoEmail = document.getElementById('areaCodigoEmail');
      const btnValidarCodigoEmail = document.getElementById('btnValidarCodigoEmail');
      
      console.log('C√≥digo digitado:', codigoDigitado);
      console.log('Email:', email);
      
      if (!codigoDigitado || codigoDigitado.length !== 6) {
        mostrarNotificacao('Digite o c√≥digo de 6 d√≠gitos.', 'error');
        if (document.getElementById('inputCodigoEmail')) {
          document.getElementById('inputCodigoEmail').focus();
        }
        return;
      }
      
      if (btnValidarCodigoEmail) {
        btnValidarCodigoEmail.disabled = true;
        btnValidarCodigoEmail.textContent = 'Validando...';
      }
      
      // Validar c√≥digo real via API
      fetch('https://chegar-primeiro.onrender.com/api/validar-codigo-email', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'X-CSRF-Token': localStorage.getItem('csrfToken')
        },
        body: JSON.stringify({ 
          email, 
          codigo: codigoDigitado,
          timestamp: Date.now()
        })
      })
      .then(res => res.json())
      .then(data => {
        if (btnValidarCodigoEmail) {
          btnValidarCodigoEmail.disabled = false;
          btnValidarCodigoEmail.textContent = 'Validar c√≥digo';
        }
        
        if (data.success) {
          console.log('C√≥digo validado com sucesso!');
          if (statusElement) {
            statusElement.textContent = 'E-mail verificado com sucesso!';
            statusElement.style.color = '#28a745';
          }
          if (iconeEmailVerificado) {
            iconeEmailVerificado.style.display = 'inline';
          }
          if (areaCodigoEmail) {
            areaCodigoEmail.style.display = 'none';
          }
          emailVerificado = true;
          clearEmailVerificationTimer();
          mostrarNotificacao('Email verificado com sucesso!', 'success');
        } else {
          console.log('C√≥digo incorreto!');
          if (statusElement) {
            statusElement.textContent = data.error || 'C√≥digo inv√°lido.';
            statusElement.style.color = '#dc3545';
          }
          document.getElementById('inputCodigoEmail').value = '';
          document.getElementById('inputCodigoEmail').focus();
          mostrarNotificacao('C√≥digo incorreto', 'error');
        }
      })
      .catch(error => {
        console.error('Erro ao validar c√≥digo:', error);
        if (btnValidarCodigoEmail) {
          btnValidarCodigoEmail.disabled = false;
          btnValidarCodigoEmail.textContent = 'Validar c√≥digo';
        }
        mostrarNotificacao('Erro ao validar c√≥digo.', 'error');
      });
    }

    // Fun√ß√£o para alternar visibilidade da senha
    function togglePasswordVisibility(fieldId) {
      const field = document.getElementById(fieldId);
      const button = field.nextElementSibling;
      
      if (field.type === 'password') {
        field.type = 'text';
        button.textContent = 'üôà';
      } else {
        field.type = 'password';
        button.textContent = 'üëÅ';
      }
    }

    // Fun√ß√£o para abrir modal de servi√ßos
    function abrirModalServicos(contexto) {
      window.modalServicoContexto = contexto;
      document.getElementById('modalServicos').style.display = 'flex';
    }

    // Fun√ß√£o para fechar modal de servi√ßos
    function fecharModalServicos() {
      document.getElementById('modalServicos').style.display = 'none';
    }

    function selecionarServico(nomeServico, contexto) {
      const container = document.getElementById('cadServicoContainer');
      container.innerHTML = `
        <div class="servico-selecionado">
          <span class="servico-nome">${nomeServico}</span>
          <button type="button" onclick="abrirModalServicos('${contexto}')" class="btn-alterar-servico">Alterar</button>
        </div>
      `;
      fecharModalServicos();
    }

    // Fun√ß√µes auxiliares para o sistema de email
    function startEmailVerificationTimer() {
      clearEmailVerificationTimer();
      let timeLeft = 300; // 5 minutos
      const statusCodigoEmail = document.getElementById('statusCodigoEmail');
      const areaCodigoEmail = document.getElementById('areaCodigoEmail');
      const btnVerificarEmail = document.getElementById('btnVerificarEmail');
      
      emailVerificationTimer = setInterval(() => {
        timeLeft--;
        
        if (timeLeft <= 0) {
          clearEmailVerificationTimer();
          if (statusCodigoEmail) {
            statusCodigoEmail.textContent = 'C√≥digo expirado. Solicite um novo c√≥digo.';
            statusCodigoEmail.style.color = '#dc3545';
          }
          if (areaCodigoEmail) {
            areaCodigoEmail.style.display = 'none';
          }
          if (btnVerificarEmail) {
            btnVerificarEmail.style.display = 'block';
          }
        } else if (timeLeft <= 60) {
          if (statusCodigoEmail) {
            statusCodigoEmail.textContent = `C√≥digo expira em ${timeLeft}s`;
            statusCodigoEmail.style.color = '#ffc107';
          }
        }
      }, 1000);
    }

    function clearEmailVerificationTimer() {
      if (emailVerificationTimer) {
        clearInterval(emailVerificationTimer);
        emailVerificationTimer = null;
      }
    }

    function isEmailDomainTrusted(email) {
      const domain = email.split('@')[1];
      const trustedDomains = [
        'gmail.com', 'outlook.com', 'hotmail.com', 'yahoo.com', 'icloud.com',
        'terra.com.br', 'uol.com.br', 'globo.com', 'bol.com.br', 'ig.com.br',
        'live.com', 'msn.com', 'yahoo.com.br'
      ];
      return trustedDomains.includes(domain);
    }

    function generateFingerprint() {
      // Gerar um fingerprint mais robusto do dispositivo para seguran√ßa
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('Fingerprint test', 2, 2);
      
      return btoa(JSON.stringify({
        screen: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        language: navigator.language,
        platform: navigator.platform,
        canvas: canvas.toDataURL(),
        userAgent: navigator.userAgent.substring(0, 100),
        timestamp: Date.now()
      }));
    }

    function verificarDominioEmail(email) {
      const domain = email.split('@')[1];
      const trustedDomains = [
        'gmail.com', 'outlook.com', 'hotmail.com', 'yahoo.com', 'icloud.com',
        'terra.com.br', 'uol.com.br', 'globo.com', 'bol.com.br', 'ig.com.br'
      ];
      
      const emailInput = document.getElementById('cadEmail');
      if (!emailInput) return;
      
      // Remover aviso anterior
      const existingWarning = emailInput.parentNode.querySelector('.domain-warning');
      if (existingWarning) existingWarning.remove();
      
      if (!trustedDomains.includes(domain)) {
        const warning = document.createElement('small');
        warning.style.cssText = 'color: #856404; font-size: 11px; display: block; margin-top: 2px;';
        warning.textContent = 'Dom√≠nio n√£o muito comum. Verifique se est√° correto.';
        warning.className = 'domain-warning';
        emailInput.parentNode.appendChild(warning);
      }
    }
  </script>
</body>
</html>
