<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Login - Chegar Primeiro Claro">
  <meta name="keywords" content="Claro, login, acesso, cliente">
  <meta name="author" content="Claro">
  <meta name="robots" content="noindex, nofollow">
  
  <!-- Seguran√ßa -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://chegar-primeiro.onrender.com https://viacep.com.br https://brasilapi.com.br; font-src 'self' data:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  
  <!-- PWA Support -->
  <meta name="theme-color" content="#d31a20">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <title>Login - Chegar Primeiro</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="login-improvements.css">
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì±</text></svg>">
</head>
<body class="login-ativo">
  <div class="container">
    <img src="https://upload.wikimedia.org/wikipedia/commons/9/9c/LogoClaro2017.png" class="logo" alt="Logo Claro">
    <h2 style="text-align:center; margin-bottom: 18px;">Chegar Primeiro</h2>
    
    <form id="formLogin" style="display:flex; flex-direction:column;">
      <h2>Login do Cliente</h2>
      
      <div class="field-container">
        <label> CPF</label>
        <div class="input-with-suggestions">
          <input type="text" id="loginCpf" required maxlength="14" autocomplete="username" placeholder="000.000.000-00">
          <div class="suggestions-dropdown" id="cpfSuggestions"></div>
        </div>
        
      </div>
      
      <div class="field-container">
        <label> Senha</label>
        <div class="password-input-container">
          <input type="password" id="loginSenha" required autocomplete="current-password" minlength="6" placeholder="Digite sua senha">
          <button type="button" class="btn-toggle-password" onclick="togglePasswordVisibility('loginSenha')">üëÅÔ∏è</button>
          <div class="password-strength-indicator" id="loginPasswordStrength"></div>
        </div>
        <small>M√≠nimo 6 caracteres</small>
      </div>

      <!-- Op√ß√µes avan√ßadas de login -->
      <div class="login-options">
        <div class="checkbox-container">
          <input type="checkbox" id="rememberMe" class="custom-checkbox">
          <label for="rememberMe" class="checkbox-label">
            <span class="checkbox-icon">‚úì</span>
            Lembrar de mim por 30 dias
          </label>
        </div>
        
        <div class="biometric-section" id="biometricSection" style="display: none;">
          <button type="button" class="biometric-btn" id="biometricBtn">
            üîí Entrar com biometria
          </button>
          <small>Use sua impress√£o digital ou Face ID</small>
        </div>
        
        <div class="two-factor-section" id="twoFactorSection" style="display: none;">
          <label>üîê C√≥digo de verifica√ß√£o</label>
          <div class="verification-input-group">
            <input type="text" id="twoFactorCode" maxlength="6" placeholder="000000" autocomplete="one-time-code">
            <button type="button" id="resendCodeBtn" class="btn-resend">Reenviar</button>
          </div>
          <small>Digite o c√≥digo enviado para seu dispositivo</small>
        </div>
      </div>

      <!-- Bot√µes de a√ß√£o -->
      <div class="login-actions">
        <button type="submit" class="submit-btn primary-btn">
          <span class="btn-icon">üîì</span>
          <span class="btn-text">Entrar</span>
          <div class="loading-spinner" style="display: none;"></div>
        </button>
        
        <button type="button" onclick="window.location.href='index-principal.html'" class="submit-btn secondary-btn">
          <span class="btn-icon">‚Üê</span>
          <span class="btn-text">Voltar ao In√≠cio</span>
        </button>
      </div>

      <!-- Links adicionais -->
      <div class="login-links">
        <button type="button" onclick="openAdvancedRecovery()" class="link-btn">
          üîë Esqueci minha senha
        </button>
        
        <button type="button" onclick="window.location.href='cadastro.html'" class="link-btn">
          ‚ûï N√£o tenho cadastro
        </button>
        
        <button type="button" onclick="testarClienteExiste()" class="link-btn" style="background: #17a2b8; color: white;">
          üîç Testar se CPF existe
        </button>
      </div>

      <!-- Informa√ß√µes de seguran√ßa -->
      <div class="security-info">
        <div class="login-attempts" id="loginAttempts" style="display: none;">
          <span class="warning-icon">‚ö†Ô∏è</span>
          <span id="attemptsText">Restam X tentativas</span>
        </div>
      </div>
    </form>
    
    <!-- Modal de recupera√ß√£o de senha -->
    <div id="modalRecuperarSenha" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:10001;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:32px 28px 24px 28px;border-radius:12px;box-shadow:0 2px 16px #0002;min-width:320px;max-width:95vw;display:flex;flex-direction:column;align-items:center;position:relative;">
        <span style="position:absolute;top:10px;right:18px;font-size:2em;color:#a32c43;cursor:pointer;" onclick="fecharModalRecuperarSenha()">&times;</span>
        <h3 style="color:#d31a20;margin-bottom:18px;">Recuperar senha</h3>
        <div id="recuperarSenhaEtapaCpf">
          <label for="recCpf">Digite seu CPF:</label>
          <input type="text" id="recCpf" maxlength="11" style="width:180px;text-align:center;">
          <button type="button" id="btnBuscarEmailRec" class="submit-btn" style="margin-top:10px;">Buscar e-mail</button>
        </div>
        <div id="recuperarSenhaEtapaEmail" style="display:none;">
          <div style="margin-bottom:10px;">E-mail cadastrado: <span id="recEmailMasc"></span></div>
          <button type="button" id="btnEnviarCodigoRec" class="submit-btn">Enviar verifica√ß√£o</button>
        </div>
        <div id="recuperarSenhaEtapaCodigo" style="display:none;">
          <label for="recCodigo">Digite o c√≥digo recebido:</label>
          <input type="text" id="recCodigo" maxlength="6" style="width:120px;text-align:center;">
          <button type="button" id="btnValidarCodigoRec" class="submit-btn" style="margin-top:10px;">Validar c√≥digo</button>
          <span id="recStatusCodigo" style="margin-left:10px;font-size:0.97em;"></span>
        </div>
        <div id="recuperarSenhaEtapaNovaSenha" style="display:none;">
          <label>Nova senha:</label>
          <input type="password" id="recNovaSenha" autocomplete="new-password">
          <label>Repetir nova senha:</label>
          <input type="password" id="recNovaSenha2" autocomplete="new-password">
          <button type="button" id="btnTrocarSenhaRec" class="submit-btn" style="margin-top:10px;">Trocar senha</button>
        </div>
      </div>
    </div>

    <!-- Overlay de loading -->
    <div id="loadingOverlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.7);z-index:10000;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:32px 40px;border-radius:12px;box-shadow:0 2px 16px #0002;display:flex;flex-direction:column;align-items:center;gap:16px;">
        <div class="spinner" style="border:6px solid #eee;border-top:6px solid #ff0000;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;"></div>
        <span style="font-size:1.1em;color:#333;">Carregando...</span>
      </div>
    </div>

    <!-- Notifica√ß√£o -->
    <div class="notification" id="notification"></div>
  </div>
  
  <style>
    @keyframes spin { 
      0% { transform: rotate(0deg);} 
      100% { transform: rotate(360deg);} 
    }
    
    /* Estilos para notifica√ß√µes */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 10002;
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 300px;
    }
    
    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .notification.success {
      background: #28a745;
    }
    
    .notification.error {
      background: #dc3545;
    }
    
    .notification.info {
      background: #17a2b8;
    }
  </style>
  
  <script src="navigation.js"></script>
  <script src="script.js"></script>
  <script>
    // Inicializar sistema de login
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar se o usu√°rio j√° est√° autenticado
      const isAuthenticated = localStorage.getItem('userAuthenticated');
      const userData = JSON.parse(localStorage.getItem('userData') || '{}');
      
      if (isAuthenticated === 'true' && userData.nome) {
        // Usu√°rio j√° est√° autenticado, redirecionar para dashboard
        window.location.href = 'dashboard.html';
        return;
      }

      // Garantir que estamos no modo login
      document.body.className = 'login-ativo';
      
      // Inicializar funcionalidades espec√≠ficas do login
      if (typeof initializeLoginSystem === 'function') {
        initializeLoginSystem();
      }

      // Usar o sistema de login original do script.js
      if (typeof advancedLoginSystem !== 'undefined') {
        // Sistema de login j√° inicializado
        console.log('Sistema de login avan√ßado carregado');
      }

      // Adicionar event listener para o formul√°rio de login
      const formLogin = document.getElementById('formLogin');
      if (formLogin) {
        formLogin.addEventListener('submit', async function(e) {
          e.preventDefault();
          console.log('Form submit interceptado');
          
          const cpf = document.getElementById('loginCpf').value.replace(/\D/g, '');
          const senha = document.getElementById('loginSenha').value;
          
          if (!cpf || cpf.length !== 11) {
            mostrarNotificacao('CPF inv√°lido', 'error');
            return;
          }
          
          if (!senha || senha.length < 4) {
            mostrarNotificacao('Senha deve ter pelo menos 4 caracteres', 'error');
            return;
          }
          
          try {
            toggleLoading(true);
            
            console.log('Enviando dados de login:', { 
              cpf: cpf, 
              cpfLength: cpf.length,
              senhaLength: senha.length,
              cpfOriginal: document.getElementById('loginCpf').value
            });
            
            // Usar a API de login correta com verifica√ß√£o de senha
            const response = await fetch('https://chegar-primeiro.onrender.com/api/login', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                cpf: cpf,
                senha: senha
              })
            });
            
            console.log('Status da resposta:', response.status);
            console.log('Headers da resposta:', Object.fromEntries(response.headers));
            
            let data;
            try {
              data = await response.json();
              console.log('Resposta do servidor (parsed):', data);
            } catch (parseError) {
              const textResponse = await response.text();
              console.error('Erro ao fazer parse da resposta JSON:', parseError);
              console.log('Resposta como texto:', textResponse);
              throw new Error('Resposta do servidor n√£o √© um JSON v√°lido');
            }
            
            if (response.ok && data.success) {
              // Login bem-sucedido
              console.log('Salvando dados do usu√°rio:', data.cliente);
              localStorage.setItem('userAuthenticated', 'true');
              localStorage.setItem('userData', JSON.stringify(data.cliente));
              
              mostrarNotificacao('Login realizado com sucesso!', 'success');
              
              // Redirecionar ap√≥s sucesso
              setTimeout(() => {
                window.location.href = 'dashboard.html';
              }, 1000);
            } else {
              // Login falhou
              const errorMessage = data.error || 'CPF ou senha inv√°lidos';
              console.error('Login falhou:', {
                status: response.status,
                error: errorMessage,
                fullResponse: data
              });
              mostrarNotificacao(errorMessage, 'error');
            }
            
          } catch (error) {
            console.error('Erro no login:', error);
            mostrarNotificacao('Erro na conex√£o. Tente novamente.', 'error');
          } finally {
            toggleLoading(false);
          }
        });
      }
    });

    // Fun√ß√£o para abrir modal de recupera√ß√£o
    function openAdvancedRecovery() {
      document.getElementById('modalRecuperarSenha').style.display = 'flex';
    }

    // Fun√ß√£o para fechar modal de recupera√ß√£o
    function fecharModalRecuperarSenha() {
      document.getElementById('modalRecuperarSenha').style.display = 'none';
    }

    // Fun√ß√£o para alternar visibilidade da senha
    function togglePasswordVisibility(fieldId) {
      const field = document.getElementById(fieldId);
      const button = field.nextElementSibling;
      
      if (field.type === 'password') {
        field.type = 'text';
        button.textContent = 'üôà';
      } else {
        field.type = 'password';
        button.textContent = 'üëÅÔ∏è';
      }
    }

    // Sobrescrever a fun√ß√£o de sucesso do login original para redirecionar para clientes.html
    function modificarComportamentoLogin() {
      // Encontrar e modificar o m√©todo simulateSuccessfulLogin
      if (typeof advancedLoginSystem !== 'undefined' && advancedLoginSystem.simulateSuccessfulLogin) {
        const originalSimulate = advancedLoginSystem.simulateSuccessfulLogin;
        advancedLoginSystem.simulateSuccessfulLogin = async function(method) {
          mostrarMensagem(`Login realizado com sucesso via ${method}!`, true);
          
          // Simular carregamento de dados do usu√°rio
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          // Redirecionar para dashboard.html ap√≥s login bem-sucedido
          window.location.href = 'dashboard.html';
        };
      }
    }

    // Modificar comportamento ap√≥s carregar
    setTimeout(modificarComportamentoLogin, 100);

    // Fun√ß√µes auxiliares para compatibilidade
    function mostrarNotificacao(mensagem, tipo = 'info', duracao = 5000) {
      // Usar a fun√ß√£o mostrarMensagem original se dispon√≠vel
      if (typeof mostrarMensagem === 'function') {
        mostrarMensagem(mensagem, tipo === 'success');
        return;
      }
      
      const notification = document.getElementById('notification');
      if (!notification) return;
      
      notification.className = `notification show ${tipo}`;
      notification.textContent = mensagem;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, duracao);
    }

    function toggleLoading(show = true) {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.style.display = show ? 'flex' : 'none';
      }
    }

    // Fun√ß√£o para testar se cliente existe
    async function testarClienteExiste() {
      const cpf = document.getElementById('loginCpf').value.replace(/\D/g, '');
      
      if (!cpf || cpf.length !== 11) {
        mostrarNotificacao('Digite um CPF v√°lido para testar', 'error');
        return;
      }
      
      try {
        toggleLoading(true);
        console.log('Testando se cliente existe:', cpf);
        
        const response = await fetch(`https://chegar-primeiro.onrender.com/api/debug/cliente-existe/${cpf}`);
        const data = await response.json();
        
        console.log('Resultado do teste:', data);
        
        if (data.existe) {
          mostrarNotificacao(`‚úÖ Cliente encontrado: ${data.nome} - Tem senha: ${data.tem_senha ? 'Sim' : 'N√£o'}`, 'success');
        } else {
          mostrarNotificacao('‚ùå Cliente n√£o encontrado. Fa√ßa o cadastro primeiro.', 'error');
        }
      } catch (error) {
        console.error('Erro no teste:', error);
        mostrarNotificacao('Erro ao testar. Verifique a conex√£o.', 'error');
      } finally {
        toggleLoading(false);
      }
    }
  </script>
</body>
</html>
